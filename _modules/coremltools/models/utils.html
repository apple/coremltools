<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>coremltools.models.utils &mdash; coremltools API Reference 8.0b1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/norightmargin.css?v=eea1f72d" />

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../_static/documentation_options.js?v=d50bc636"></script>
        <script src="../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            coremltools API Reference
          </a>
              <div class="version">
                8.0b1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../source/coremltools.converters.html">Converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/coremltools.models.html">Model APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/coremltools.converters.mil.html">MIL Builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/coremltools.converters.mil.input_types.html">MIL Input Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/coremltools.converters.mil.mil.ops.defs.html">MIL Ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/coremltools.converters.mil.mil.passes.defs.html">MIL Graph Passes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/coremltools.optimize.html">Optimizers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://apple.github.io/coremltools/docs-guides/index.html">Guide and Examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://apple.github.io/coremltools/mlmodel/index.html">Core ML Format Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../source/api-versions.html">Previous Versions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apple/coremltools">GitHub</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">coremltools API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">coremltools.models.utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for coremltools.models.utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2017, Apple Inc. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Use of this source code is governed by a BSD-3-clause license that can be</span>
<span class="c1"># found in the LICENSE.txt file or at https://opensource.org/licenses/BSD-3-Clause</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Utilities for the entire package.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span> <span class="k">as</span> <span class="n">_OrderedDict</span>
<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">_copy</span>
<span class="kn">import</span> <span class="nn">gc</span> <span class="k">as</span> <span class="nn">_gc</span>
<span class="kn">import</span> <span class="nn">math</span> <span class="k">as</span> <span class="nn">_math</span>
<span class="kn">import</span> <span class="nn">os</span> <span class="k">as</span> <span class="nn">_os</span>
<span class="kn">import</span> <span class="nn">shutil</span> <span class="k">as</span> <span class="nn">_shutil</span>
<span class="kn">import</span> <span class="nn">subprocess</span> <span class="k">as</span> <span class="nn">_subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span> <span class="k">as</span> <span class="nn">_sys</span>
<span class="kn">import</span> <span class="nn">tempfile</span> <span class="k">as</span> <span class="nn">_tempfile</span>
<span class="kn">import</span> <span class="nn">warnings</span> <span class="k">as</span> <span class="nn">_warnings</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span> <span class="k">as</span> <span class="n">_Iterable</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">lru_cache</span> <span class="k">as</span> <span class="n">_lru_cache</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span> <span class="k">as</span> <span class="n">_Callable</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span> <span class="k">as</span> <span class="n">_Dict</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span> <span class="k">as</span> <span class="n">_List</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span> <span class="k">as</span> <span class="n">_Optional</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span> <span class="k">as</span> <span class="n">_Tuple</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span> <span class="k">as</span> <span class="n">_Union</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">_np</span>

<span class="kn">import</span> <span class="nn">coremltools</span> <span class="k">as</span> <span class="nn">_ct</span>
<span class="kn">from</span> <span class="nn">coremltools</span> <span class="kn">import</span> <span class="n">_logger</span>
<span class="kn">from</span> <span class="nn">coremltools</span> <span class="kn">import</span> <span class="n">_SPECIFICATION_VERSION_IOS_16</span><span class="p">,</span> <span class="n">_SPECIFICATION_VERSION_IOS_18</span>
<span class="kn">from</span> <span class="nn">coremltools</span> <span class="kn">import</span> <span class="n">ComputeUnit</span> <span class="k">as</span> <span class="n">_ComputeUnit</span>
<span class="kn">from</span> <span class="nn">coremltools</span> <span class="kn">import</span> <span class="n">proto</span> <span class="k">as</span> <span class="n">_proto</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil</span> <span class="kn">import</span> <span class="n">mil</span> <span class="k">as</span> <span class="n">_mil</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.frontend.milproto</span> <span class="kn">import</span> <span class="n">load</span> <span class="k">as</span> <span class="n">_milproto_to_pymil</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.mil</span> <span class="kn">import</span> <span class="n">Builder</span> <span class="k">as</span> <span class="n">_mb</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.mil</span> <span class="kn">import</span> <span class="n">Program</span> <span class="k">as</span> <span class="n">_Program</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.mil.passes.defs.preprocess</span> <span class="kn">import</span> <span class="n">NameSanitizer</span> <span class="k">as</span> <span class="n">_NameSanitizer</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.mil.passes.defs.randomize</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">WeightRandomizer</span> <span class="k">as</span> <span class="n">_WeightRandomizer</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.mil.passes.graph_pass</span> <span class="kn">import</span> <span class="n">AbstractGraphPass</span> <span class="k">as</span> <span class="n">_AbstractGraphPass</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.mil.passes.helper</span> <span class="kn">import</span> <span class="n">block_context_manager</span> <span class="k">as</span> <span class="n">_block_context_manager</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.mil.passes.pass_pipeline</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">PassPipelineManager</span> <span class="k">as</span> <span class="n">_PassPipelineManager</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.mil.passes.pass_registry</span> <span class="kn">import</span> <span class="n">PASS_REGISTRY</span> <span class="k">as</span> <span class="n">_PASS_REGISTRY</span>
<span class="kn">from</span> <span class="nn">coremltools.converters.mil.mil.program</span> <span class="kn">import</span> <span class="n">Placeholder</span> <span class="k">as</span> <span class="n">_Placeholder</span>

<span class="kn">from</span> <span class="nn">.._deps</span> <span class="kn">import</span> <span class="n">_HAS_SCIPY</span>

<span class="n">_MLMODEL_EXTENSION</span> <span class="o">=</span> <span class="s2">&quot;.mlmodel&quot;</span>
<span class="n">_MLPACKAGE_EXTENSION</span> <span class="o">=</span> <span class="s2">&quot;.mlpackage&quot;</span>
<span class="n">_MODEL_FILE_NAME</span> <span class="o">=</span> <span class="s1">&#39;model.mlmodel&#39;</span>
<span class="n">_WEIGHTS_FILE_NAME</span> <span class="o">=</span> <span class="s1">&#39;weight.bin&#39;</span>
<span class="n">_WEIGHTS_DIR_NAME</span> <span class="o">=</span> <span class="s1">&#39;weights&#39;</span>
<span class="n">_MLPACKAGE_AUTHOR_NAME</span> <span class="o">=</span> <span class="s2">&quot;com.apple.CoreML&quot;</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">..libmodelpackage</span> <span class="kn">import</span> <span class="n">ModelPackage</span> <span class="k">as</span> <span class="n">_ModelPackage</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">_ModelPackage</span> <span class="o">=</span> <span class="kc">None</span>

<span class="k">if</span> <span class="n">_HAS_SCIPY</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">scipy.sparse</span> <span class="k">as</span> <span class="nn">_sp</span>


<span class="k">def</span> <span class="nf">_to_unicode</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">_remove_invalid_keys</span><span class="p">(</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
    <span class="c1"># make sure that input_dict does not contain an input name, which</span>
    <span class="c1"># is not present in the list of model inputs</span>
    <span class="n">input_dict_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">input_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="n">model_input_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">inp</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">inp</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">input_dict_keys</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model_input_names</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">input_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_create_mlpackage</span><span class="p">(</span>
    <span class="n">proto_spec</span><span class="p">:</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="p">,</span>
    <span class="n">weights_dir</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">package_path</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    proto_spec</span>
<span class="sd">        The proto spec of the model.</span>

<span class="sd">    weights_dir</span>
<span class="sd">        Copy weights from this path to the ``mlpackage``.</span>

<span class="sd">    package_path</span>
<span class="sd">        Place the created ``mlpackage`` at this path. Error out if this path is a non-empty directory.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    path to the ``mlpackage``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">package_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">package_path</span> <span class="o">=</span> <span class="n">_tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="n">_MLPACKAGE_EXTENSION</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">package_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">package_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">FileExistsError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The package_path is invalid because it&#39;s a non-empty directory: </span><span class="si">{</span><span class="n">package_path</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="c1"># If package_path is an empty dir, the ModelPackage load will error out with `manifest.json not found` issue.</span>
        <span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">package_path</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">package_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ext</span> <span class="o">!=</span> <span class="n">_MLPACKAGE_EXTENSION</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;For an ML Package, extension must be </span><span class="si">{</span><span class="n">_MLPACKAGE_EXTENSION</span><span class="si">}</span><span class="s2"> (not </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

    <span class="n">package</span> <span class="o">=</span> <span class="n">_ModelPackage</span><span class="p">(</span><span class="n">package_path</span><span class="p">)</span>

    <span class="c1"># Save proto to disk as the root model file, and copy into the model package.</span>
    <span class="n">spec_file</span> <span class="o">=</span> <span class="n">_tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">suffix</span><span class="o">=</span><span class="n">_MLMODEL_EXTENSION</span><span class="p">)</span>
    <span class="n">spec_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">proto_spec</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span>
    <span class="n">spec_file</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">package</span><span class="o">.</span><span class="n">setRootModel</span><span class="p">(</span><span class="n">spec_file</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_MODEL_FILE_NAME</span><span class="p">,</span> <span class="n">_MLPACKAGE_AUTHOR_NAME</span><span class="p">,</span>
                         <span class="s2">&quot;CoreML Model Specification&quot;</span><span class="p">)</span>
    <span class="c1"># Spec file is auto cleaned after close, which is fine because it is already added to the model package.</span>
    <span class="n">spec_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># Add weights bundle into the model package.</span>
    <span class="k">if</span> <span class="n">weights_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">package</span><span class="o">.</span><span class="n">addItem</span><span class="p">(</span>
            <span class="n">weights_dir</span><span class="p">,</span>
            <span class="n">_WEIGHTS_DIR_NAME</span><span class="p">,</span>
            <span class="n">_MLPACKAGE_AUTHOR_NAME</span><span class="p">,</span>
            <span class="s2">&quot;CoreML Model Weights&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">package_path</span>


<div class="viewcode-block" id="save_spec">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.save_spec">[docs]</a>
<span class="k">def</span> <span class="nf">save_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">auto_set_specification_version</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">weights_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a protobuf model specification to file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spec: Model_pb</span>
<span class="sd">        Protobuf representation of the model.</span>

<span class="sd">    filename: str</span>
<span class="sd">        File path where the spec is saved.</span>

<span class="sd">    auto_set_specification_version: bool</span>
<span class="sd">        If ``True``, will always try to set specification version automatically.</span>

<span class="sd">    weights_dir: str</span>
<span class="sd">        Path to the directory containing the weights.bin file. This is required</span>
<span class="sd">        when the spec has model type ``mlprogram``. If the ``mlprogram`` does not contain</span>
<span class="sd">        any weights, this path can be an empty directory.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        coremltools.utils.save_spec(spec, &quot;HousePricer.mlmodel&quot;)</span>
<span class="sd">        coremltools.utils.save_spec(spec, &quot;HousePricer.mlpackage&quot;)</span>
<span class="sd">        coremltools.utils.save_spec(</span>
<span class="sd">            spec, &quot;mlprogram_model.mlpackage&quot;, weights_dir=&quot;/path/to/weights/directory&quot;</span>
<span class="sd">        )</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    load_spec</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="n">is_package</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ext</span><span class="p">:</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">_MLMODEL_EXTENSION</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="n">_MLPACKAGE_EXTENSION</span><span class="p">:</span>
        <span class="n">is_package</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="n">_MLMODEL_EXTENSION</span><span class="p">:</span>
        <span class="n">is_package</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Extension must be </span><span class="si">{}</span><span class="s2"> or </span><span class="si">{}</span><span class="s2"> (not </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_MLMODEL_EXTENSION</span><span class="p">,</span> <span class="n">_MLPACKAGE_EXTENSION</span><span class="p">,</span> <span class="n">ext</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">auto_set_specification_version</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># always try to downgrade the specification version to the</span>
            <span class="c1"># minimal version that supports everything in this mlmodel</span>
            <span class="kn">from</span> <span class="nn">..libcoremlpython</span> <span class="kn">import</span> <span class="n">_MLModelProxy</span>

            <span class="n">spec</span> <span class="o">=</span> <span class="n">_MLModelProxy</span><span class="o">.</span><span class="n">auto_set_specification_version</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">_warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;Failed to automatic set specification version for this model.&quot;</span><span class="p">,</span>
                <span class="ne">RuntimeWarning</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="k">if</span> <span class="n">is_package</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_ModelPackage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Unable to load libmodelpackage. Cannot save spec&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mlProgram&quot;</span> <span class="ow">and</span> <span class="n">weights_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;spec of type mlProgram cannot be saved without the&#39;</span>
                                <span class="s1">&#39; weights file. Please provide the path to the weights file as well, &#39;</span>
                                <span class="s1">&#39;using the </span><span class="se">\&#39;</span><span class="s1">weights_dir</span><span class="se">\&#39;</span><span class="s1"> argument.&#39;</span><span class="p">)</span>
        <span class="n">_create_mlpackage</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">weights_dir</span><span class="o">=</span><span class="n">weights_dir</span><span class="p">,</span> <span class="n">package_path</span><span class="o">=</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">SerializeToString</span><span class="p">())</span></div>



<div class="viewcode-block" id="load_spec">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.load_spec">[docs]</a>
<span class="k">def</span> <span class="nf">load_spec</span><span class="p">(</span><span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load a protobuf model specification from file (``mlmodel``) or directory (``mlpackage``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model_path: Path to the model from which the protobuf spec is loaded.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model_spec: Model_pb</span>
<span class="sd">        Protobuf representation of the model.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        spec = coremltools.utils.load_spec(&quot;HousePricer.mlmodel&quot;)</span>
<span class="sd">        spec = coremltools.utils.load_spec(&quot;HousePricer.mlpackage&quot;)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    save_spec</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">model_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_ModelPackage</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to load libmodelpackage. Cannot make save spec.&quot;</span><span class="p">)</span>
        <span class="n">specfile</span> <span class="o">=</span> <span class="n">_ModelPackage</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span><span class="o">.</span><span class="n">getRootModel</span><span class="p">()</span><span class="o">.</span><span class="n">path</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">specfile</span> <span class="o">=</span> <span class="n">model_path</span>

    <span class="n">spec</span> <span class="o">=</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">specfile</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">spec</span><span class="o">.</span><span class="n">ParseFromString</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">spec</span></div>



<span class="k">def</span> <span class="nf">_get_nn_layers</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of neural network layers if the model contains any.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spec: Model_pb</span>
<span class="sd">        A model protobuf specification.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [NN layer]</span>
<span class="sd">        list of all layers (including layers from elements of a pipeline).</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">:</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model_spec</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">layers</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_get_nn_layers</span><span class="p">(</span><span class="n">model_spec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_get_nn_layers</span><span class="p">(</span><span class="n">model_spec</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;pipelineClassifier&quot;</span><span class="p">,</span> <span class="s2">&quot;pipelineRegressor&quot;</span><span class="p">]:</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">model_spec</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">layers</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">_get_nn_layers</span><span class="p">(</span><span class="n">model_spec</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">layers</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">_get_nn_layers</span><span class="p">(</span><span class="n">model_spec</span><span class="p">))</span>

    <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">neuralNetwork</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">neuralNetwork</span><span class="o">.</span><span class="n">layers</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">neuralNetworkClassifier</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">neuralNetworkClassifier</span><span class="o">.</span><span class="n">layers</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">neuralNetworkRegressor</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">neuralNetworkRegressor</span><span class="o">.</span><span class="n">layers</span>

    <span class="k">return</span> <span class="n">layers</span>


<span class="k">def</span> <span class="nf">_fp32_to_reversed_fp16_byte_array</span><span class="p">(</span><span class="n">fp32_arr</span><span class="p">):</span>
    <span class="n">raw_fp16</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">float16</span><span class="p">(</span><span class="n">fp32_arr</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">fp16</span> <span class="ow">in</span> <span class="n">raw_fp16</span><span class="p">:</span>
        <span class="n">all_bytes</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">fromstring</span><span class="p">(</span><span class="n">fp16</span><span class="o">.</span><span class="n">tobytes</span><span class="p">(),</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int8&quot;</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">all_bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">+=</span> <span class="n">all_bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">x</span>


<span class="k">def</span> <span class="nf">_fp32_to_fp16_byte_array</span><span class="p">(</span><span class="n">fp32_arr</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">amax</span><span class="p">(</span><span class="n">fp32_arr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">65504</span> <span class="ow">or</span> <span class="n">_np</span><span class="o">.</span><span class="n">amin</span><span class="p">(</span><span class="n">fp32_arr</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">65504</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Model cannot be converted as &quot;</span>
            <span class="s2">&quot;it has weights that cannot be represented in &quot;</span>
            <span class="s2">&quot;half precision.</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">_sys</span><span class="o">.</span><span class="n">byteorder</span> <span class="o">==</span> <span class="s2">&quot;little&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">float16</span><span class="p">(</span><span class="n">fp32_arr</span><span class="p">)</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_fp32_to_reversed_fp16_byte_array</span><span class="p">(</span><span class="n">fp32_arr</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_wp_to_fp16wp</span><span class="p">(</span><span class="n">wp</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">wp</span>
    <span class="c1"># If the float32 field is empty do nothing.</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">wp</span><span class="o">.</span><span class="n">floatValue</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">wp</span><span class="o">.</span><span class="n">float16Value</span> <span class="o">=</span> <span class="n">_fp32_to_fp16_byte_array</span><span class="p">(</span><span class="n">wp</span><span class="o">.</span><span class="n">floatValue</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">wp</span><span class="o">.</span><span class="n">floatValue</span><span class="p">[:]</span>

<span class="k">def</span> <span class="nf">_convert_neural_network_spec_weights_to_fp16</span><span class="p">(</span><span class="n">fp_spec</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">.neural_network.quantization_utils</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">_QUANTIZATION_MODE_LINEAR_QUANTIZATION</span><span class="p">,</span>
        <span class="n">_quantize_spec_weights</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">qspec</span> <span class="o">=</span> <span class="n">_quantize_spec_weights</span><span class="p">(</span><span class="n">fp_spec</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">_QUANTIZATION_MODE_LINEAR_QUANTIZATION</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">qspec</span>


<span class="k">def</span> <span class="nf">_convert_neural_network_weights_to_fp16</span><span class="p">(</span><span class="n">full_precision_model</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function to convert a full-precision (float) MLModel to a</span>
<span class="sd">    half-precision MLModel (float16).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    full_precision_model: MLModel</span>
<span class="sd">        Model which will be converted to half precision. Currently conversion</span>
<span class="sd">        for only neural network models is supported. If a pipeline model is</span>
<span class="sd">        passed in, then all embedded neural network models embedded within</span>
<span class="sd">        will be converted.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: MLModel</span>
<span class="sd">        The converted half precision MLModel.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spec</span> <span class="o">=</span> <span class="n">full_precision_model</span><span class="o">.</span><span class="n">get_spec</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_get_model</span><span class="p">(</span><span class="n">_convert_neural_network_spec_weights_to_fp16</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_model</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">compute_units</span><span class="o">=</span><span class="n">_ComputeUnit</span><span class="o">.</span><span class="n">ALL</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility to get the model and the data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">MLModel</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">MLModel</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">spec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">MLModel</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">compute_units</span><span class="o">=</span><span class="n">compute_units</span><span class="p">)</span>

<div class="viewcode-block" id="evaluate_regressor">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.evaluate_regressor">[docs]</a>
<span class="k">def</span> <span class="nf">evaluate_regressor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a Core ML regression model and compare against predictions</span>
<span class="sd">    from the original framework (for testing correctness of conversion).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model: MLModel or str</span>
<span class="sd">        A loaded MLModel or a path to a saved MLModel.</span>

<span class="sd">    data: Dataframe</span>
<span class="sd">        Test data on which to evaluate the models.</span>

<span class="sd">    target: str</span>
<span class="sd">       Name of the column in the dataframe to be compared against the prediction.</span>

<span class="sd">    verbose: bool</span>
<span class="sd">       Set to true for a more verbose output.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    evaluate_classifier</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        metrics = coremltools.utils.evaluate_regressor(</span>
<span class="sd">            spec, &quot;data_and_predictions.csv&quot;, &quot;target&quot;</span>
<span class="sd">        )</span>
<span class="sd">        print(metrics)</span>
<span class="sd">        {&quot;samples&quot;: 10, &quot;rmse&quot;: 0.0, max_error: 0.0}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">_get_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Other Framework</span><span class="se">\t\t</span><span class="s2">Predicted</span><span class="se">\t\t</span><span class="s2">Delta&quot;</span><span class="p">)</span>

    <span class="n">max_error</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">error_squared</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">input_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">_remove_invalid_keys</span><span class="p">(</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)[</span><span class="n">_to_unicode</span><span class="p">(</span><span class="n">target</span><span class="p">)]</span>
        <span class="n">other_framework</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">predicted</span> <span class="o">-</span> <span class="n">other_framework</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="se">\t\t\t</span><span class="si">{:0.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">other_framework</span><span class="p">,</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">delta</span><span class="p">))</span>

        <span class="n">max_error</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="n">max_error</span><span class="p">)</span>
        <span class="n">error_squared</span> <span class="o">=</span> <span class="n">error_squared</span> <span class="o">+</span> <span class="p">(</span><span class="n">delta</span> <span class="o">*</span> <span class="n">delta</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;samples&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
        <span class="s2">&quot;rmse&quot;</span><span class="p">:</span> <span class="n">_math</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">error_squared</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)),</span>
        <span class="s2">&quot;max_error&quot;</span><span class="p">:</span> <span class="n">max_error</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;results: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span></div>



<div class="viewcode-block" id="evaluate_classifier">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.evaluate_classifier">[docs]</a>
<span class="k">def</span> <span class="nf">evaluate_classifier</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="s2">&quot;target&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a Core ML classifier model and compare against predictions</span>
<span class="sd">    from the original framework (for testing correctness of conversion).</span>
<span class="sd">    Use this evaluation for models that don&#39;t deal with probabilities.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename: list of str or list of MLModel</span>
<span class="sd">        File to load the model from, or a loaded</span>
<span class="sd">        version of the MLModel.</span>

<span class="sd">    data: list of str or list of Dataframe</span>
<span class="sd">        Test data on which to evaluate the models (dataframe,</span>
<span class="sd">        or path to a CSV file).</span>

<span class="sd">    target: str</span>
<span class="sd">       Column to interpret as the target column.</span>

<span class="sd">    verbose: bool</span>
<span class="sd">       Set to true for more verbose output.</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    evaluate_regressor, evaluate_classifier_with_probabilities</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        metrics = coremltools.utils.evaluate_classifier(</span>
<span class="sd">            spec, &quot;data_and_predictions.csv&quot;, &quot;target&quot;</span>
<span class="sd">        )</span>
<span class="sd">        print(metrics)</span>
<span class="sd">        {&quot;samples&quot;: 10, num_errors: 0}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">_get_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Other Framework</span><span class="se">\t\t</span><span class="s2">Predicted&quot;</span><span class="p">)</span>

    <span class="n">num_errors</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">input_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">_remove_invalid_keys</span><span class="p">(</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)[</span><span class="n">_to_unicode</span><span class="p">(</span><span class="n">target</span><span class="p">)]</span>
        <span class="n">other_framework</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">target</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">predicted</span> <span class="o">!=</span> <span class="n">other_framework</span><span class="p">:</span>
            <span class="n">num_errors</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="se">\t\t\t\t</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">other_framework</span><span class="p">,</span> <span class="n">predicted</span><span class="p">))</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;num_samples&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="s2">&quot;num_errors&quot;</span><span class="p">:</span> <span class="n">num_errors</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;results: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ret</span></div>



<div class="viewcode-block" id="evaluate_classifier_with_probabilities">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.evaluate_classifier_with_probabilities">[docs]</a>
<span class="k">def</span> <span class="nf">evaluate_classifier_with_probabilities</span><span class="p">(</span>
    <span class="n">model</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">probabilities</span><span class="o">=</span><span class="s2">&quot;probabilities&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a classifier specification for testing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename: [str | Model]</span>
<span class="sd">        File to load the model from, or a loaded</span>
<span class="sd">        version of the MLModel.</span>

<span class="sd">    data: [str | Dataframe]</span>
<span class="sd">        Test data on which to evaluate the models (dataframe,</span>
<span class="sd">        or path to a CSV file).</span>

<span class="sd">    probabilities: str</span>
<span class="sd">       Column to interpret as the probabilities column.</span>

<span class="sd">    verbose: bool</span>
<span class="sd">       Verbosity levels of the predictions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">_get_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Other Framework</span><span class="se">\t\t</span><span class="s2">Predicted&quot;</span><span class="p">)</span>

    <span class="n">max_probability_error</span><span class="p">,</span> <span class="n">num_key_mismatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">input_dict</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">dict</span><span class="p">(</span><span class="n">row</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="n">probabilities</span><span class="p">}</span>
        <span class="n">_remove_invalid_keys</span><span class="p">(</span><span class="n">input_dict</span><span class="p">,</span> <span class="n">model</span><span class="p">)</span>
        <span class="n">predicted_values</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)[</span><span class="n">_to_unicode</span><span class="p">(</span><span class="n">probabilities</span><span class="p">)]</span>
        <span class="n">other_values</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="n">probabilities</span><span class="p">]</span>

        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">predicted_values</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">!=</span> <span class="nb">set</span><span class="p">(</span><span class="n">other_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Different classes: &quot;</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">predicted_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">other_values</span><span class="o">.</span><span class="n">keys</span><span class="p">()),</span>
                <span class="p">)</span>
            <span class="n">num_key_mismatch</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">continue</span>

        <span class="k">for</span> <span class="n">cur_class</span><span class="p">,</span> <span class="n">cur_predicted_class_values</span> <span class="ow">in</span> <span class="n">predicted_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="n">cur_predicted_class_values</span> <span class="o">-</span> <span class="n">other_values</span><span class="p">[</span><span class="n">cur_class</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">delta</span><span class="p">,</span> <span class="n">cur_predicted_class_values</span><span class="p">,</span> <span class="n">other_values</span><span class="p">[</span><span class="n">cur_class</span><span class="p">])</span>

            <span class="n">max_probability_error</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">delta</span><span class="p">),</span> <span class="n">max_probability_error</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;num_samples&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
        <span class="s2">&quot;max_probability_error&quot;</span><span class="p">:</span> <span class="n">max_probability_error</span><span class="p">,</span>
        <span class="s2">&quot;num_key_mismatch&quot;</span><span class="p">:</span> <span class="n">num_key_mismatch</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;results: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ret</span></div>



<div class="viewcode-block" id="rename_feature">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.rename_feature">[docs]</a>
<span class="k">def</span> <span class="nf">rename_feature</span><span class="p">(</span>
    <span class="n">spec</span><span class="p">,</span> <span class="n">current_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">rename_inputs</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rename_outputs</span><span class="o">=</span><span class="kc">True</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rename a feature in the specification.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spec: Model_pb</span>
<span class="sd">        The specification containing the feature to rename.</span>

<span class="sd">    current_name: str</span>
<span class="sd">        Current name of the feature. If this feature doesn&#39;t exist, the rename</span>
<span class="sd">        is a no-op.</span>

<span class="sd">    new_name: str</span>
<span class="sd">        New name of the feature.</span>

<span class="sd">    rename_inputs: bool</span>
<span class="sd">        Search for ``current_name`` only in the input features (that is, ignore output</span>
<span class="sd">        features).</span>

<span class="sd">    rename_outputs: bool</span>
<span class="sd">        Search for ``current_name`` only in the output features (that is, ignore input</span>
<span class="sd">        features).</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        # In-place rename of spec</span>
<span class="sd">        model = MLModel(&quot;model.mlmodel&quot;)</span>
<span class="sd">        spec = model.get_spec()</span>
<span class="sd">        coremltools.utils.rename_feature(spec, &quot;old_feature&quot;, &quot;new_feature_name&quot;)</span>
<span class="sd">        # re-initialize model</span>
<span class="sd">        model = MLModel(spec)</span>
<span class="sd">        model.save(&quot;model.mlmodel&quot;)</span>

<span class="sd">        # Rename a spec when the model is an mlprogram, in that case, weights are stored outside of the spec</span>
<span class="sd">        model = coremltools.convert(torch_model, convert_to=&quot;mlprogram&quot;)</span>
<span class="sd">        spec = model.get_spec()</span>
<span class="sd">        # print info about inputs and outputs</span>
<span class="sd">        print(spec.description)</span>
<span class="sd">        coremltools.utils.rename_feature(spec, &quot;old_feature&quot;, &quot;new_feature_name&quot;)</span>
<span class="sd">        # re-initialize model</span>
<span class="sd">        model = MLModel(spec, weights_dir=model.weights_dir)</span>
<span class="sd">        model.save(&quot;model.mlpackage&quot;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rename_inputs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rename_outputs</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">changed_input</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">changed_output</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">rename_inputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                <span class="nb">input</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
                <span class="n">changed_input</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">rename_outputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                <span class="n">output</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
                <span class="n">changed_output</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">predictedFeatureName</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">predictedFeatureName</span> <span class="o">=</span> <span class="n">new_name</span>

        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">predictedProbabilitiesName</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">predictedProbabilitiesName</span> <span class="o">=</span> <span class="n">new_name</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">changed_input</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">changed_output</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Rename internally in NN model</span>
    <span class="n">nn</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">nn_type</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="s2">&quot;neuralNetwork&quot;</span><span class="p">,</span>
        <span class="s2">&quot;neuralNetworkClassifier&quot;</span><span class="p">,</span>
        <span class="s2">&quot;neuralNetworkRegressor&quot;</span><span class="p">,</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="n">nn_type</span><span class="p">):</span>
            <span class="n">nn</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">nn_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">nn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">nn</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rename_inputs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">input</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                        <span class="n">layer</span><span class="o">.</span><span class="n">input</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>
                <span class="k">if</span> <span class="n">rename_outputs</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">output</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                            <span class="n">layer</span><span class="o">.</span><span class="n">output</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>

        <span class="k">if</span> <span class="n">rename_inputs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">preprocess_params</span> <span class="ow">in</span> <span class="n">nn</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">preprocess_params</span><span class="o">.</span><span class="n">featureName</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                    <span class="n">preprocess_params</span><span class="o">.</span><span class="n">featureName</span> <span class="o">=</span> <span class="n">new_name</span>

        <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;neuralNetworkClassifier&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">nn</span><span class="o">.</span><span class="n">labelProbabilityLayerName</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                <span class="n">nn</span><span class="o">.</span><span class="n">labelProbabilityLayerName</span> <span class="o">=</span> <span class="n">new_name</span>

    <span class="c1"># Rename internally for feature vectorizer</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;featureVectorizer&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rename_inputs</span><span class="p">:</span>
        <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">featureVectorizer</span><span class="o">.</span><span class="n">inputList</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">inputColumn</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                <span class="nb">input</span><span class="o">.</span><span class="n">inputColumn</span> <span class="o">=</span> <span class="n">new_name</span>
                <span class="n">changed_input</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="c1"># Rename for pipeline models</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;pipeline&quot;</span><span class="p">):</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">pipeline</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;pipelineClassifier&quot;</span><span class="p">):</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">pipelineClassifier</span><span class="o">.</span><span class="n">pipeline</span>
    <span class="k">elif</span> <span class="n">spec</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;pipelineRegressor&quot;</span><span class="p">):</span>
        <span class="n">pipeline</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">pipelineRegressor</span><span class="o">.</span><span class="n">pipeline</span>

    <span class="k">if</span> <span class="n">pipeline</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pipeline</span><span class="o">.</span><span class="n">models</span><span class="p">):</span>
            <span class="n">rename_feature</span><span class="p">(</span>
                <span class="n">model</span><span class="p">,</span>
                <span class="n">current_name</span><span class="p">,</span>
                <span class="n">new_name</span><span class="p">,</span>
                <span class="n">rename_inputs</span> <span class="ow">or</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">),</span>
                <span class="n">rename_outputs</span> <span class="ow">or</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">spec</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">models</span><span class="p">)),</span>
            <span class="p">)</span>

    <span class="c1"># Rename for mlProgram</span>
    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;mlProgram&quot;</span><span class="p">):</span>
        <span class="n">new_name_sanitized</span> <span class="o">=</span> <span class="n">_NameSanitizer</span><span class="p">()</span><span class="o">.</span><span class="n">sanitize_name</span><span class="p">(</span><span class="n">new_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_name</span> <span class="o">!=</span> <span class="n">new_name_sanitized</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input/output names for ML Program must be of the format [a-zA-Z_][a-zA-Z0-9_]*. &quot;</span>
                             <span class="s2">&quot;That is, it must start with a letter and only contain numerals, underscore or letters. &quot;</span>
                             <span class="s2">&quot;Provided feature name, </span><span class="se">\&quot;</span><span class="si">{}</span><span class="se">\&quot;</span><span class="s2"> does not satisfy these requirements.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">new_name</span><span class="p">))</span>
        <span class="n">mil</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">mlProgram</span>
        <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="n">mil</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">name_value_type</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">inputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">name_value_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                    <span class="n">name_value_type</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
            <span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">function</span><span class="o">.</span><span class="n">block_specializations</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">out_name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">outputs</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">out_name</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                        <span class="n">block</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_name</span>
                <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">argument</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="n">argument</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">binding</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">binding</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                                    <span class="n">binding</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
                    <span class="k">for</span> <span class="n">name_value_type</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">name_value_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">current_name</span><span class="p">:</span>
                            <span class="n">name_value_type</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span></div>



<span class="k">def</span> <span class="nf">_sanitize_value</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs cleaning steps on the data so various type comparisons can</span>
<span class="sd">    be performed correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,)):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="n">_HAS_SCIPY</span> <span class="ow">and</span> <span class="n">_sp</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">.</span><span class="n">todense</span><span class="p">()</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">_sanitize_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">_sanitize_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">((</span><span class="n">_sanitize_value</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="n">_sanitize_value</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">assert</span> <span class="kc">False</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_element_equal</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Performs a robust equality test between elements.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mf">1e-5</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
            <span class="ow">and</span> <span class="n">_element_equal</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="ow">and</span> <span class="nb">all</span><span class="p">(</span><span class="n">_element_equal</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">abs</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-5</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="nb">abs</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="o">==</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="n">y</span><span class="p">)</span>


<div class="viewcode-block" id="evaluate_transformer">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.evaluate_transformer">[docs]</a>
<span class="k">def</span> <span class="nf">evaluate_transformer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">input_data</span><span class="p">,</span> <span class="n">reference_output</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluate a transformer specification for testing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model: list of str or list of MLModel</span>
<span class="sd">        File to load the Model from, or a loaded</span>
<span class="sd">        version of the MLModel.</span>

<span class="sd">    input_data: list of dict</span>
<span class="sd">        Test data on which to evaluate the models.</span>

<span class="sd">    reference_output: list of dict</span>
<span class="sd">        Expected results for the model.</span>

<span class="sd">    verbose: bool</span>
<span class="sd">        Verbosity levels of the predictions.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        input_data = [{&quot;input_1&quot;: 1, &quot;input_2&quot;: 2}, {&quot;input_1&quot;: 3, &quot;input_2&quot;: 3}]</span>
<span class="sd">        expected_output = [{&quot;input_1&quot;: 2.5, &quot;input_2&quot;: 2.0}, {&quot;input_1&quot;: 1.3, &quot;input_2&quot;: 2.3}]</span>
<span class="sd">        metrics = coremltools.utils.evaluate_transformer(</span>
<span class="sd">            scaler_spec, input_data, expected_output</span>
<span class="sd">        )</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    evaluate_regressor, evaluate_classifier</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">_get_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Other Framework</span><span class="se">\t\t</span><span class="s2">Predicted&quot;</span><span class="p">)</span>

    <span class="n">num_errors</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_data</span><span class="p">):</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="n">sanitized_row</span> <span class="o">=</span> <span class="n">_sanitize_value</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="n">ref_data</span> <span class="o">=</span> <span class="n">_sanitize_value</span><span class="p">(</span><span class="n">reference_output</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Correct output:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ref_data</span><span class="p">))</span>

        <span class="n">predicted</span> <span class="o">=</span> <span class="n">_sanitize_value</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">sanitized_row</span><span class="p">))</span>

        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ref_data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span>

        <span class="n">predicted_trimmed</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">predicted</span><span class="p">[</span><span class="n">k</span><span class="p">])</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">ref_data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Predicted:</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">predicted_trimmed</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_element_equal</span><span class="p">(</span><span class="n">predicted_trimmed</span><span class="p">,</span> <span class="n">ref_data</span><span class="p">):</span>
            <span class="n">num_errors</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;num_samples&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">input_data</span><span class="p">),</span> <span class="s2">&quot;num_errors&quot;</span><span class="p">:</span> <span class="n">num_errors</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;results: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">ret</span></div>



<span class="k">def</span> <span class="nf">_has_custom_layer</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Returns true if the given protobuf specification has a custom layer, and false otherwise.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spec: mlmodel spec</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    ``True`` if the protobuf specification contains a neural network with a custom layer, ``False`` otherwise.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">layers</span> <span class="o">=</span> <span class="n">_get_nn_layers</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;layer&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">_get_custom_layer_names</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Returns a list of ``className`` fields which appear in the given protobuf spec.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spec: mlmodel spec</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    set(str)</span>
<span class="sd">        A set of unique ``className`` fields of custom layers that appear in the model.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">_get_nn_layers</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">layers_out</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;layer&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="n">layers_out</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">layer</span><span class="o">.</span><span class="n">custom</span><span class="o">.</span><span class="n">className</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">layers_out</span>


<span class="k">def</span> <span class="nf">_get_custom_layers</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Returns a list of all neural network custom layers in the spec.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spec: mlmodel spec</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [NN layer]</span>
<span class="sd">        A list of custom layer implementations.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">_get_nn_layers</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="n">layers_out</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;layer&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;custom&quot;</span><span class="p">:</span>
            <span class="n">layers_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">layers_out</span>


<span class="k">def</span> <span class="nf">_replace_custom_layer_name</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">oldname</span><span class="p">,</span> <span class="n">newname</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Substitutes ``newname`` for ``oldname`` in the ``className`` field of custom layers. If there are no custom layers, or no</span>
<span class="sd">    layers with ``className`` = ``oldname``, then the spec is unchanged.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spec: mlmodel spec</span>

<span class="sd">    oldname: str</span>
<span class="sd">        The custom layer ``className`` to be replaced.</span>

<span class="sd">    newname: str</span>
<span class="sd">        The new ``className`` value to replace ``oldname``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    An mlmodel spec.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="n">_get_custom_layers</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">layer</span><span class="o">.</span><span class="n">custom</span><span class="o">.</span><span class="n">className</span> <span class="o">==</span> <span class="n">oldname</span><span class="p">:</span>
            <span class="n">layer</span><span class="o">.</span><span class="n">custom</span><span class="o">.</span><span class="n">className</span> <span class="o">=</span> <span class="n">newname</span>


<span class="k">def</span> <span class="nf">_is_macos</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns True if current platform is MacOS, False otherwise.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_sys</span><span class="o">.</span><span class="n">platform</span> <span class="o">==</span> <span class="s2">&quot;darwin&quot;</span>


<span class="nd">@_lru_cache</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">_macos_version</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns macOS version as a tuple of integers, making it easy to do proper</span>
<span class="sd">    version comparisons. On non-Macs, it returns an empty tuple.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">_is_macos</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ver_str</span> <span class="o">=</span> <span class="n">_subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="s2">&quot;sw_vers&quot;</span><span class="p">,</span> <span class="s2">&quot;-productVersion&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">ver_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to determine the macOS version&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">()</span>


<span class="k">def</span> <span class="nf">_python_version</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Return python version as a tuple of integers</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">_sys</span><span class="o">.</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">version</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">version</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">))))</span>
    <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">version</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_feature</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">feature_name</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">input_feature</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">input_feature</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">feature_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">input_feature</span>

    <span class="k">for</span> <span class="n">output_feature</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_feature</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">feature_name</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">output_feature</span>

    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Feature with name </span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">feature_name</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_get_input_names</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a list of the names of the inputs to this model.</span>
<span class="sd">    :param spec: The model protobuf specification</span>
<span class="sd">    :return: list of str A list of input feature names</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">retval</span>


<div class="viewcode-block" id="convert_double_to_float_multiarray_type">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.convert_double_to_float_multiarray_type">[docs]</a>
<span class="k">def</span> <span class="nf">convert_double_to_float_multiarray_type</span><span class="p">(</span><span class="n">spec</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convert all double multiarrays feature descriptions (input, output, training input)</span>
<span class="sd">    to float multiarrays.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    spec: Model_pb</span>
<span class="sd">        The specification containing the multiarrays types to convert.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        # In-place convert multiarray type of spec</span>
<span class="sd">        spec = mlmodel.get_spec()</span>
<span class="sd">        coremltools.utils.convert_double_to_float_multiarray_type(spec)</span>
<span class="sd">        model = coremltools.models.MLModel(spec)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_convert_to_float</span><span class="p">(</span><span class="n">feature</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">HasField</span><span class="p">(</span><span class="s2">&quot;multiArrayType&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">multiArrayType</span><span class="o">.</span><span class="n">dataType</span> <span class="o">==</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">ArrayFeatureType</span><span class="o">.</span><span class="n">DOUBLE</span><span class="p">:</span>
                <span class="n">feature</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">multiArrayType</span><span class="o">.</span><span class="n">dataType</span> <span class="o">=</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">ArrayFeatureType</span><span class="o">.</span><span class="n">FLOAT32</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
        <span class="n">_convert_to_float</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
        <span class="n">_convert_to_float</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">trainingInput</span><span class="p">:</span>
        <span class="n">_convert_to_float</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">spec</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;pipeline&quot;</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">model_spec</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">models</span><span class="p">:</span>
            <span class="n">convert_double_to_float_multiarray_type</span><span class="p">(</span><span class="n">model_spec</span><span class="p">)</span></div>



<div class="viewcode-block" id="compile_model">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.compile_model">[docs]</a>
<span class="k">def</span> <span class="nf">compile_model</span><span class="p">(</span><span class="n">model</span><span class="p">:</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">Model</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compiles a Core ML model spec.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model: Model_pb2</span>
<span class="sd">        Spec/protobuf to compile.</span>

<span class="sd">        Note: an ``mlprogam`` which uses a blob file is not supported.</span>

<span class="sd">    destination_path: str</span>
<span class="sd">        Path where the compiled model will be saved.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>

<span class="sd">    str : Path to compiled model directory</span>
<span class="sd">        If the ``destination_path`` is specified, that is the value that will be returned.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        from coremltools.models import CompiledMLModel</span>
<span class="sd">        from coremltools.models.utils import compile_model</span>
<span class="sd">        from coremltools.proto import Model_pb2</span>

<span class="sd">        spec = Model_pb2.Model()</span>
<span class="sd">        spec.specificationVersion = 1</span>

<span class="sd">        input_ = spec.description.input.add()</span>
<span class="sd">        input_.name = &quot;x&quot;</span>
<span class="sd">        input_.type.doubleType.MergeFromString(b&quot;&quot;)</span>

<span class="sd">        output_ = spec.description.output.add()</span>
<span class="sd">        output_.name = &quot;y&quot;</span>
<span class="sd">        output_.type.doubleType.MergeFromString(b&quot;&quot;)</span>
<span class="sd">        spec.description.predictedFeatureName = &quot;y&quot;</span>

<span class="sd">        lr = spec.glmRegressor</span>
<span class="sd">        lr.offset.append(0.1)</span>
<span class="sd">        weights = lr.weights.add()</span>
<span class="sd">        weights.value.append(2.0)</span>

<span class="sd">        compiled_model_path = compile_model(spec)</span>
<span class="sd">        model = CompiledMLModel(compiled_model_path)</span>
<span class="sd">        y = model.predict({&quot;x&quot;: 2})</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    coremltools.models.CompiledMLModel</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Check environment</span>
    <span class="k">if</span> <span class="n">_macos_version</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Compiling a Core ML models is only support on macOS 10.13 or higher.&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">..libcoremlpython</span> <span class="kn">import</span> <span class="n">_MLModelProxy</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Unable to compile any Core ML models.&quot;</span><span class="p">)</span>

    <span class="c1"># Check model parameter</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;To get a compiled model from a saved MLModel, first load the model, &quot;</span>
                        <span class="s2">&quot; then call </span><span class="se">\&quot;</span><span class="s2">get_compiled_model_path</span><span class="se">\&quot;</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">_ct</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MLModel</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;This model has already been compiled. Call </span><span class="se">\&quot;</span><span class="s2">get_compiled_model_path</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
                        <span class="s2">&quot; to get the compiled model.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Unrecognized input for </span><span class="se">\&quot;</span><span class="s2">model</span><span class="se">\&quot;</span><span class="s2"> parameter. It should be a spec.&quot;</span><span class="p">)</span>

    <span class="c1"># Check file extension of destination_path parameter</span>
    <span class="k">if</span> <span class="n">destination_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">destination_path</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.mlmodelc&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">destination_path</span><span class="se">\&quot;</span><span class="s2"> parameter must have </span><span class="se">\&quot;</span><span class="s2">.mlmodelc</span><span class="se">\&quot;</span><span class="s2"> file extension.&quot;</span><span class="p">)</span>

    <span class="c1"># Compile model</span>
    <span class="k">with</span> <span class="n">_tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">save_dir</span><span class="p">:</span>
        <span class="n">spec_file_path</span> <span class="o">=</span> <span class="n">save_dir</span> <span class="o">+</span> <span class="s1">&#39;/spec.mlmodel&#39;</span>
        <span class="n">save_spec</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">spec_file_path</span><span class="p">)</span>
        <span class="n">original_compiled_model_path</span> <span class="o">=</span>  <span class="n">_MLModelProxy</span><span class="o">.</span><span class="n">compileModel</span><span class="p">(</span><span class="n">spec_file_path</span><span class="p">)</span>

    <span class="c1"># Move the compiled model if needed</span>
    <span class="k">if</span> <span class="n">destination_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">original_compiled_model_path</span>
    <span class="n">_shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">original_compiled_model_path</span><span class="p">,</span> <span class="n">destination_path</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">destination_path</span></div>



<div class="viewcode-block" id="make_pipeline">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.make_pipeline">[docs]</a>
<span class="k">def</span> <span class="nf">make_pipeline</span><span class="p">(</span>
        <span class="o">*</span><span class="n">models</span><span class="p">:</span> <span class="s1">&#39;_ct.models.MLModel&#39;</span><span class="p">,</span>
        <span class="n">compute_units</span><span class="p">:</span> <span class="n">_Union</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="n">_ct</span><span class="o">.</span><span class="n">ComputeUnit</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_ct.models.MLModel&#39;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Makes a pipeline with the given models.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    *models :</span>
<span class="sd">        Two or more instances of ``ct.models.MLModel``.</span>

<span class="sd">    compute_units :</span>
<span class="sd">        The set of processing units that all models in the pipeline can use to make predictions.</span>
<span class="sd">        Can be ``None`` or ``coremltools.ComputeUnit``.</span>

<span class="sd">        * If ``None``, the ``compute_unit`` will be inferred from the ``compute_unit`` values of the models.</span>
<span class="sd">          If all models do not have the same ``compute_unit`` values, this parameter must be specified.</span>

<span class="sd">        * ``coremltools.ComputeUnit`` is an enum with four possible values:</span>
<span class="sd">            - ``coremltools.ComputeUnit.ALL``: Use all compute units available, including the</span>
<span class="sd">              neural engine.</span>
<span class="sd">            - ``coremltools.ComputeUnit.CPU_ONLY``: Limit the model to only use the CPU.</span>
<span class="sd">            - ``coremltools.ComputeUnit.CPU_AND_GPU``: Use both the CPU and GPU,</span>
<span class="sd">              but not the neural engine.</span>
<span class="sd">            - ``coremltools.ComputeUnit.CPU_AND_NE``: Use both the CPU and neural engine, but</span>
<span class="sd">              not the GPU. Available only for macOS &gt;= 13.0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ct.models.MLModel</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        my_model1 = ct.models.MLModel(&quot;/tmp/m1.mlpackage&quot;)</span>
<span class="sd">        my_model2 = ct.models.MLModel(&quot;/tmp/m2.mlmodel&quot;)</span>

<span class="sd">        my_pipeline_model = ct.utils.make_pipeline(my_model1, my_model2)</span>

<span class="sd">        y = my_pipeline_model.predict({&quot;x&quot;: 12})</span>

<span class="sd">        my_pipeline_model.save(&quot;/tmp/my_pipeline.mlpackage&quot;)</span>
<span class="sd">        new_my_pipeline = ct.model.MLModel(&quot;/tmp/my_pipeline.mlpackage&quot;)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">updateBlobFileName</span><span class="p">(</span><span class="n">proto_message</span><span class="p">,</span> <span class="n">new_path</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">proto_message</span><span class="p">)</span> <span class="o">==</span> <span class="n">_proto</span><span class="o">.</span><span class="n">MIL_pb2</span><span class="o">.</span><span class="n">Value</span><span class="p">:</span>
            <span class="c1"># Value protobuf message. This is what might need to be updated.</span>
            <span class="k">if</span> <span class="n">proto_message</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;blobFileValue&#39;</span><span class="p">:</span>
                <span class="k">assert</span> <span class="n">proto_message</span><span class="o">.</span><span class="n">blobFileValue</span><span class="o">.</span><span class="n">fileName</span> <span class="o">==</span> <span class="s2">&quot;@model_path/weights/weight.bin&quot;</span>
                <span class="n">proto_message</span><span class="o">.</span><span class="n">blobFileValue</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">new_path</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">proto_message</span><span class="p">,</span> <span class="s1">&#39;ListFields&#39;</span><span class="p">):</span>
            <span class="c1"># Normal protobuf message</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">proto_message</span><span class="o">.</span><span class="n">ListFields</span><span class="p">():</span>
                <span class="n">updateBlobFileName</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">new_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">proto_message</span><span class="p">,</span> <span class="s1">&#39;values&#39;</span><span class="p">):</span>
            <span class="c1"># Protobuf map</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">proto_message</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">updateBlobFileName</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proto_message</span><span class="p">,</span> <span class="n">_Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">proto_message</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="c1"># Repeated protobuf message</span>
            <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">proto_message</span><span class="p">:</span>
                <span class="n">updateBlobFileName</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">new_path</span><span class="p">)</span>


    <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">compute_units</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compute_units</span><span class="p">,</span> <span class="n">_ComputeUnit</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;&quot;compute_units&quot; parameter must be None or of type coremltools.ComputeUnit&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">compute_units</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">all_compute_units_the_same</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_unit</span> <span class="ow">is</span> <span class="n">m</span><span class="o">.</span><span class="n">compute_unit</span><span class="p">,</span>
            <span class="n">models</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">all_compute_units_the_same</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s1">&#39;Models have different compute_unit values. The &quot;compute_units&quot; parameter must be specified.&#39;</span>
            <span class="p">)</span>
        <span class="n">compute_units</span> <span class="o">=</span> <span class="n">models</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">compute_unit</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">compute_units</span> <span class="o">==</span> <span class="n">_ComputeUnit</span><span class="o">.</span><span class="n">CPU_AND_NE</span>
          <span class="ow">and</span> <span class="n">_is_macos</span><span class="p">()</span>
          <span class="ow">and</span> <span class="n">_macos_version</span><span class="p">()</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;coremltools.ComputeUnit.CPU_AND_NE is only available on macOS &gt;= 13.0&#39;</span>
        <span class="p">)</span>

    <span class="n">input_specs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">m</span><span class="p">:</span> <span class="n">m</span><span class="o">.</span><span class="n">get_spec</span><span class="p">(),</span> <span class="n">models</span><span class="p">))</span>

    <span class="n">pipeline_spec</span> <span class="o">=</span> <span class="n">_ct</span><span class="o">.</span><span class="n">proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span>
    <span class="n">pipeline_spec</span><span class="o">.</span><span class="n">specificationVersion</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">spec</span><span class="p">:</span> <span class="n">spec</span><span class="o">.</span><span class="n">specificationVersion</span><span class="p">,</span> <span class="n">input_specs</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># If a later model doesn&#39;t get an input from a previous model, it must be</span>
    <span class="c1"># an input to the pipeline.</span>
    <span class="n">available_as_input</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cur_spec</span> <span class="ow">in</span> <span class="n">input_specs</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">cur_input</span> <span class="ow">in</span> <span class="n">cur_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur_input</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available_as_input</span><span class="p">:</span>
                <span class="n">pipeline_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="o">.</span><span class="n">add</span><span class="p">()</span><span class="o">.</span><span class="n">MergeFrom</span><span class="p">(</span><span class="n">cur_input</span><span class="p">)</span>
                <span class="n">available_as_input</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">cur_input</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">available_as_input</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">output</span><span class="p">])</span>

    <span class="c1"># If an output for a model is not used as input for a later model, assume it</span>
    <span class="c1"># should be an output to the pipeline.</span>
    <span class="n">used_as_input</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">cur_spec</span> <span class="ow">in</span> <span class="n">input_specs</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>     <span class="c1"># iterate overs specs in reverse</span>
        <span class="k">for</span> <span class="n">cur_output</span> <span class="ow">in</span> <span class="n">cur_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cur_output</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">used_as_input</span><span class="p">:</span>
                <span class="n">pipeline_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">output</span><span class="o">.</span><span class="n">add</span><span class="p">()</span><span class="o">.</span><span class="n">MergeFrom</span><span class="p">(</span><span class="n">cur_output</span><span class="p">)</span>
        <span class="n">used_as_input</span><span class="o">.</span><span class="n">update</span><span class="p">([</span><span class="n">i</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">cur_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">])</span>

    <span class="c1"># Map input shapes to output shapes</span>
    <span class="n">var_name_to_type</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">input_specs</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">input_specs</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
            <span class="n">var_name_to_type</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span><span class="o">.</span><span class="n">type</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">input_specs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
            <span class="c1"># If shape is already present, don&#39;t override it</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s1">&#39;Type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;multiArrayType&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">multiArrayType</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">var_name_to_type</span><span class="p">:</span>
                <span class="n">j</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">var_name_to_type</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">name</span><span class="p">])</span>

    <span class="c1"># Update each model&#39;s spec to have a unique weight filename</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cur_spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">input_specs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cur_spec</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;mlProgram&quot;</span><span class="p">:</span>
            <span class="n">new_file_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;@model_path/weights/</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-weight.bin&quot;</span>
            <span class="n">updateBlobFileName</span><span class="p">(</span><span class="n">cur_spec</span><span class="o">.</span><span class="n">mlProgram</span><span class="p">,</span> <span class="n">new_file_path</span><span class="p">)</span>
        <span class="n">pipeline_spec</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cur_spec</span><span class="p">)</span>

    <span class="n">mlpackage_path</span> <span class="o">=</span> <span class="n">_create_mlpackage</span><span class="p">(</span><span class="n">pipeline_spec</span><span class="p">)</span>
    <span class="n">dst</span> <span class="o">=</span> <span class="n">mlpackage_path</span> <span class="o">+</span> <span class="s1">&#39;/Data/&#39;</span> <span class="o">+</span> <span class="n">_MLPACKAGE_AUTHOR_NAME</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="n">_WEIGHTS_DIR_NAME</span>
    <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">dst</span><span class="p">)</span>

    <span class="c1"># Copy and rename each model&#39;s weight file</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">cur_model</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">models</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">cur_model</span><span class="o">.</span><span class="n">weights_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">weight_file_path</span> <span class="o">=</span> <span class="n">cur_model</span><span class="o">.</span><span class="n">weights_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="n">_WEIGHTS_FILE_NAME</span>
            <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">weight_file_path</span><span class="p">):</span>
                <span class="n">_shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">weight_file_path</span><span class="p">,</span> <span class="n">dst</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">-weight.bin&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">_ct</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MLModel</span><span class="p">(</span><span class="n">pipeline_spec</span><span class="p">,</span> <span class="n">compute_units</span><span class="o">=</span><span class="n">compute_units</span><span class="p">,</span> <span class="n">weights_dir</span><span class="o">=</span><span class="n">dst</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_convert_model_spec_to_pymil_prog</span><span class="p">(</span>
    <span class="n">mlmodel</span><span class="p">:</span> <span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">,</span>
    <span class="n">specification_version</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
    <span class="n">pymil_load_func</span><span class="p">:</span> <span class="n">_Callable</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Program</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A utility that converts an ``mlprogram`` model into PyMIL program.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_spec</span> <span class="o">=</span> <span class="n">mlmodel</span><span class="o">.</span><span class="n">get_spec</span><span class="p">()</span>
    <span class="n">model_type</span> <span class="o">=</span> <span class="n">model_spec</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;neuralNetwork&quot;</span><span class="p">,</span>
        <span class="s2">&quot;neuralNetworkClassifier&quot;</span><span class="p">,</span>
        <span class="s2">&quot;neuralNetworkRegressor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pipeline&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PipelineClassifier&quot;</span><span class="p">,</span>
        <span class="s2">&quot;PipelineRegressor&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="s2">&quot;coremltools.optimize.coreml are meant to be used only with mlprogram typed coreml models. &quot;</span>
            <span class="s2">&quot;This model has type </span><span class="si">{}</span><span class="s2">. Please use coremltools.models.neural_network.quantization_utils.quantize_weights&quot;</span>
            <span class="s2">&quot;instead to compress the weights of the model.&quot;</span>
        <span class="p">)</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_type</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s2">&quot;mlProgram&quot;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;weight compression not applicable for model type </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">model_type</span><span class="p">))</span>

    <span class="n">prog</span> <span class="o">=</span> <span class="n">pymil_load_func</span><span class="p">(</span>
        <span class="n">model_spec</span><span class="o">=</span><span class="n">model_spec</span><span class="p">,</span>
        <span class="n">specification_version</span><span class="o">=</span><span class="n">specification_version</span><span class="p">,</span>
        <span class="n">file_weights_dir</span><span class="o">=</span><span class="n">mlmodel</span><span class="o">.</span><span class="n">weights_dir</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">prog</span>


<span class="k">def</span> <span class="nf">_apply_graph_pass</span><span class="p">(</span>
    <span class="n">mlmodel</span><span class="p">:</span> <span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">,</span>
    <span class="n">graph_pass</span><span class="p">:</span> <span class="n">_AbstractGraphPass</span><span class="p">,</span>
    <span class="n">spec_version</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">_SPECIFICATION_VERSION_IOS_16</span><span class="p">,</span>
    <span class="n">skip_model_load</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pymil_load_func</span><span class="p">:</span> <span class="n">_Callable</span> <span class="o">=</span> <span class="n">_milproto_to_pymil</span><span class="o">.</span><span class="n">load</span><span class="p">,</span>
    <span class="n">return_pymil_prog</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Union</span><span class="p">[</span><span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">,</span> <span class="n">_Program</span><span class="p">]:</span>
    <span class="c1"># We do the lazy import to prevent circular import</span>
    <span class="kn">from</span> <span class="nn">coremltools.converters.mil.converter</span> <span class="kn">import</span> <span class="n">mil_convert</span> <span class="k">as</span> <span class="n">_mil_convert</span>

    <span class="k">if</span> <span class="n">skip_model_load</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Determine if skip the model load by the original mlmodel.</span>
        <span class="n">skip_model_load</span> <span class="o">=</span> <span class="n">mlmodel</span><span class="o">.</span><span class="n">__proxy__</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="c1"># Utility function which compresses a Core ML model</span>
    <span class="c1"># Converts the full precision mlmodel into a pymil program</span>
    <span class="n">model_spec</span> <span class="o">=</span> <span class="n">mlmodel</span><span class="o">.</span><span class="n">get_spec</span><span class="p">()</span>
    <span class="n">specification_version</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">model_spec</span><span class="o">.</span><span class="n">specificationVersion</span><span class="p">,</span> <span class="n">spec_version</span><span class="p">)</span>
    <span class="n">prog</span> <span class="o">=</span> <span class="n">_convert_model_spec_to_pymil_prog</span><span class="p">(</span><span class="n">mlmodel</span><span class="p">,</span> <span class="n">specification_version</span><span class="p">,</span> <span class="n">pymil_load_func</span><span class="p">)</span>

    <span class="c1"># Apply graph pass.</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">graph_pass</span><span class="p">,</span> <span class="n">_AbstractGraphPass</span>
    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;graph pass must be an AbstractGraphPass instance, but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">graph_pass</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">graph_pass</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>

    <span class="c1"># An early return can prevent running all other optimization paths triggered by _mil_convert.</span>
    <span class="k">if</span> <span class="n">return_pymil_prog</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">prog</span>

    <span class="c1"># Convert the pymil program back to mlmodel</span>
    <span class="n">compressed_mlmodel</span> <span class="o">=</span> <span class="n">_mil_convert</span><span class="p">(</span>
        <span class="n">prog</span><span class="p">,</span>
        <span class="n">convert_to</span><span class="o">=</span><span class="s2">&quot;mlprogram&quot;</span><span class="p">,</span>
        <span class="n">convert_from</span><span class="o">=</span><span class="s2">&quot;milinternal&quot;</span><span class="p">,</span>
        <span class="n">specification_version</span><span class="o">=</span><span class="n">specification_version</span><span class="p">,</span>
        <span class="n">compute_units</span><span class="o">=</span><span class="n">mlmodel</span><span class="o">.</span><span class="n">compute_unit</span><span class="p">,</span>
        <span class="n">model_description</span><span class="o">=</span><span class="n">model_spec</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
        <span class="n">skip_model_load</span><span class="o">=</span><span class="n">skip_model_load</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">compressed_mlmodel</span>


<span class="k">def</span> <span class="nf">_try_get_weights_dir_path</span><span class="p">(</span><span class="n">mlpackage_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Try to find the weights in mlpackage and return the path to the weights directory if found.</span>
<span class="sd">    Return None if not found.</span>
<span class="sd">    :param mlpackage_path: str, path to the mlpackage directory</span>
<span class="sd">    :return: path to the weights directory inside the mlpackage directory</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">weights_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_ModelPackage</span><span class="o">.</span><span class="n">isValid</span><span class="p">(</span><span class="n">mlpackage_path</span><span class="p">):</span>
            <span class="n">item_info</span> <span class="o">=</span> <span class="n">_ModelPackage</span><span class="p">(</span><span class="n">mlpackage_path</span><span class="p">)</span><span class="o">.</span><span class="n">findItemByNameAuthor</span><span class="p">(</span>
                <span class="n">_WEIGHTS_DIR_NAME</span><span class="p">,</span> <span class="n">_MLPACKAGE_AUTHOR_NAME</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">item_info</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">weights_dir</span> <span class="o">=</span> <span class="n">item_info</span><span class="o">.</span><span class="n">path</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">weights_dir</span>


<div class="viewcode-block" id="MultiFunctionDescriptor">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.MultiFunctionDescriptor">[docs]</a>
<span class="k">class</span> <span class="nc">MultiFunctionDescriptor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This data class defines how to construct a multifunction model from different model sources.</span>
<span class="sd">    Use the ``add_function`` method to specify the path to the source ``mlpackage``,</span>
<span class="sd">    along with the source and target function names.</span>

<span class="sd">    After setting the ``default_function_name`` to the ``MultiFunctionDescriptor`` instance,</span>
<span class="sd">    you can export a multifunction model using the ``save_multifunction`` method.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        from coremltools.utils import MultiFunctionDescriptor, save_multifunction</span>

<span class="sd">        # Initialize a MultiFunctionDescriptor instance with functions in an existing mlpackage.</span>
<span class="sd">        # desc will contain all functions in &quot;my_model.mlpackage&quot;</span>
<span class="sd">        desc = MultiFunctionDescriptor(&quot;my_model.mlpackage&quot;)</span>

<span class="sd">        # Construct a MultiFunctionDescriptor instance from scratch.</span>
<span class="sd">        # The below code inserts the &quot;main&quot; function from &quot;my_model.mlpackage&quot; as &quot;main_1&quot;,</span>
<span class="sd">        # and inserts the &quot;main&quot; function from &quot;my_model_2.mlpackage&quot; as &quot;main_2&quot;.</span>
<span class="sd">        desc = MultiFunctionDescriptor()</span>
<span class="sd">        desc.add_function(</span>
<span class="sd">            model_path=&quot;my_model.mlpackage&quot;,</span>
<span class="sd">            source_function_name=&quot;main&quot;,</span>
<span class="sd">            target_function_name=&quot;main_1&quot;,</span>
<span class="sd">        )</span>
<span class="sd">        desc.add_function(</span>
<span class="sd">            model_path=&quot;my_model_2.mlpackage&quot;,</span>
<span class="sd">            source_function_name=&quot;main&quot;,</span>
<span class="sd">            target_function_name=&quot;main_2&quot;,</span>
<span class="sd">        )</span>

<span class="sd">        # Each MultiFunctionDescriptor instance must have a default function name</span>
<span class="sd">        # so it can be saved as a multifunction mlpackage on disk.</span>
<span class="sd">        desc.default_function_name = &quot;main_1&quot;</span>
<span class="sd">        save_multifunction(desc, &quot;my_multifunction_model.mlpackage&quot;)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    save_multifunction</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MultiFunctionDescriptor.__init__">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.MultiFunctionDescriptor.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        If ``model_path`` is passed to the constructor, it must be a str pointing to an</span>
<span class="sd">        existing ``mlpackage`` on disk. The MultiFunctionDescriptor instance will be initiated</span>
<span class="sd">        with the functions in ``model_path``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_function_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_name_to_source_function</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelpath_to_functions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelpath_to_spec</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_model</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns ``self._name_to_source_function``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_name_to_source_function</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_modelpath_to_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Given an ``mlpackage`` path ``model_path``, this function caches related metadata.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelpath_to_functions</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">load_spec</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;invalid model_path </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2"> with error </span><span class="si">{</span><span class="n">err</span><span class="si">}</span><span class="s2"> while loading.&quot;</span><span class="p">)</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span>

        <span class="c1"># For the protobuf in iOS17 and below, there was no `functions` field,</span>
        <span class="c1"># so &quot;main&quot; is the only function associated with the model in those cases.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">desc</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modelpath_to_functions</span><span class="p">[</span><span class="n">model_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_modelpath_to_functions</span><span class="p">[</span><span class="n">model_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">func</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">desc</span><span class="o">.</span><span class="n">functions</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_modelpath_to_spec</span><span class="p">[</span><span class="n">model_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">default_function_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="kc">None</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_function_name</span>

    <span class="nd">@default_function_name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">default_function_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;default_function_name must be type of str. Got </span><span class="si">{</span><span class="n">val</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_function_name</span> <span class="o">=</span> <span class="n">val</span>

<div class="viewcode-block" id="MultiFunctionDescriptor.add_function">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.MultiFunctionDescriptor.add_function">[docs]</a>
    <span class="k">def</span> <span class="nf">add_function</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">src_function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">target_function_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert a ``src_function_name`` function from ``model_path`` as the </span>
<span class="sd">        ``target_function_name`` function in the multifunction descriptor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_modelpath_to_cache</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">src_function_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelpath_to_functions</span><span class="p">[</span><span class="n">model_path</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;src_function_name </span><span class="si">{</span><span class="n">src_function_name</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">target_function_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_to_source_function</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;function </span><span class="si">{</span><span class="n">target_function_name</span><span class="si">}</span><span class="s2"> already exist.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_name_to_source_function</span><span class="p">[</span><span class="n">target_function_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">src_function_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="MultiFunctionDescriptor.add_model">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.MultiFunctionDescriptor.add_model">[docs]</a>
    <span class="k">def</span> <span class="nf">add_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert all functions from the model in ``model_path`` into the multifunction descriptor.</span>
<span class="sd">        The function names will remain the same as in the original model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_modelpath_to_cache</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_modelpath_to_functions</span><span class="p">[</span><span class="n">model_path</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">func_name</span><span class="p">,</span> <span class="n">func_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="MultiFunctionDescriptor.remove_function">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.MultiFunctionDescriptor.remove_function">[docs]</a>
    <span class="k">def</span> <span class="nf">remove_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a function ``function_name`` from the multifunction descriptor.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">function_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_to_source_function</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;function_name </span><span class="si">{</span><span class="n">function_name</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_name_to_source_function</span><span class="p">[</span><span class="n">function_name</span><span class="p">]</span></div>
</div>



<span class="k">def</span> <span class="nf">_multifunction_program_append_unifunction_program</span><span class="p">(</span>
    <span class="n">multifunction_prog</span><span class="p">:</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Program</span><span class="p">,</span>
    <span class="n">unifunction_prog</span><span class="p">:</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Program</span><span class="p">,</span>
    <span class="n">src_func_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">target_func_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">multifunction_prog</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">target_func_name</span><span class="p">,</span> <span class="n">unifunction_prog</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="n">src_func_name</span><span class="p">])</span>


<div class="viewcode-block" id="save_multifunction">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.save_multifunction">[docs]</a>
<span class="k">def</span> <span class="nf">save_multifunction</span><span class="p">(</span>
    <span class="n">desc</span><span class="p">:</span> <span class="n">MultiFunctionDescriptor</span><span class="p">,</span>
    <span class="n">destination_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a MultiFunctionDescriptor instance into a multifunction ``mlpackage``.</span>
<span class="sd">    This function also performs constant deduplication across functions to allow for weight sharing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    desc : MultiFunctionDescriptor</span>
<span class="sd">        Multifunction descriptor to save on the disk.</span>

<span class="sd">    destination_path : str</span>
<span class="sd">        The path where the new ``mlpackage`` will be saved.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        from coremltools.utils import MultiFunctionDescriptor, save_multifunction</span>

<span class="sd">        desc = MultiFunctionDescriptor(&quot;my_model_1.mlpackage&quot;)</span>
<span class="sd">        desc.add_function(&quot;my_model_2.mlpackage&quot;, &quot;main&quot;, &quot;main_2&quot;)</span>
<span class="sd">        desc.default_function_name = &quot;main_2&quot;</span>

<span class="sd">        save_multifunction(desc, &quot;multifunction_model.mlpackage&quot;)</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    MultiFunctionDescriptor</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We do the lazy import to prevent circular import</span>
    <span class="kn">from</span> <span class="nn">coremltools.converters.mil.converter</span> <span class="kn">import</span> <span class="n">mil_convert</span> <span class="k">as</span> <span class="n">_mil_convert</span>

    <span class="k">def</span> <span class="nf">get_function_spec</span><span class="p">(</span>
        <span class="n">spec</span><span class="p">:</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="p">,</span> <span class="n">func_name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">FunctionDescription</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Utils to construct a FunctionDescription from the source spec.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model_desc</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">description</span>
        <span class="c1"># For single function model, we construct the FunctionDescription ourselves</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">model_desc</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">func_name</span> <span class="o">==</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;invalid function name </span><span class="si">{</span><span class="n">func_name</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">FunctionDescription</span><span class="p">(</span>
                <span class="nb">input</span><span class="o">=</span><span class="n">model_desc</span><span class="o">.</span><span class="n">input</span><span class="p">,</span>
                <span class="n">output</span><span class="o">=</span><span class="n">model_desc</span><span class="o">.</span><span class="n">output</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">model_desc</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
                <span class="n">predictedFeatureName</span><span class="o">=</span><span class="n">model_desc</span><span class="o">.</span><span class="n">predictedFeatureName</span><span class="p">,</span>
                <span class="n">predictedProbabilitiesName</span><span class="o">=</span><span class="n">model_desc</span><span class="o">.</span><span class="n">predictedProbabilitiesName</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># For multifunction model, we look for the corresponding FunctionDescription</span>
        <span class="k">for</span> <span class="n">func_desc</span> <span class="ow">in</span> <span class="n">model_desc</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">func_desc</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="n">func_name</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">FunctionDescription</span><span class="p">()</span>
            <span class="n">res</span><span class="o">.</span><span class="n">CopyFrom</span><span class="p">(</span><span class="n">func_desc</span><span class="p">)</span>
            <span class="n">res</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">return</span> <span class="n">res</span>

    <span class="c1"># compile model information: spec / weight_dir</span>
    <span class="n">modelpath_to_spec_and_weightdir</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">desc</span><span class="o">.</span><span class="n">_name_to_source_function</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">in</span> <span class="n">modelpath_to_spec_and_weightdir</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">_modelpath_to_spec</span><span class="p">[</span><span class="n">model_path</span><span class="p">]</span>
        <span class="n">weight_dir</span> <span class="o">=</span> <span class="n">_try_get_weights_dir_path</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">weight_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;weight_dir for model_path </span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>
        <span class="n">modelpath_to_spec_and_weightdir</span><span class="p">[</span><span class="n">model_path</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">weight_dir</span><span class="p">)</span>

    <span class="c1"># min spec version to support multi-functions model is iOS18</span>
    <span class="c1"># we also make the target spec version the max among the input models</span>
    <span class="n">spec_version</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
        <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">val</span><span class="p">:</span> <span class="n">val</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">specificationVersion</span><span class="p">,</span> <span class="n">modelpath_to_spec_and_weightdir</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
    <span class="p">)</span>
    <span class="n">spec_version</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">spec_version</span><span class="p">,</span> <span class="n">_SPECIFICATION_VERSION_IOS_18</span><span class="p">)</span>

    <span class="c1"># convert spec into pymil program</span>
    <span class="n">modelpath_to_pymil</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">model_path</span><span class="p">,</span> <span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">weight_dir</span><span class="p">)</span> <span class="ow">in</span> <span class="n">modelpath_to_spec_and_weightdir</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="n">_milproto_to_pymil</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">spec</span><span class="p">,</span>
            <span class="n">spec_version</span><span class="p">,</span>
            <span class="n">weight_dir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">modelpath_to_pymil</span><span class="p">[</span><span class="n">model_path</span><span class="p">]</span> <span class="o">=</span> <span class="n">prog</span>

    <span class="c1"># construct a multifunction pymil program</span>
    <span class="n">multifunction_prog</span> <span class="o">=</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Program</span><span class="p">()</span>
    <span class="n">function_to_desc</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">target_func_name</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">desc</span><span class="o">.</span><span class="n">_name_to_source_function</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">src_func_name</span> <span class="o">=</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="n">modelpath_to_pymil</span><span class="p">[</span><span class="n">model_path</span><span class="p">]</span>
        <span class="n">_ct</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">_multifunction_program_append_unifunction_program</span><span class="p">(</span>
            <span class="n">multifunction_prog</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">src_func_name</span><span class="p">,</span> <span class="n">target_func_name</span>
        <span class="p">)</span>

        <span class="c1"># get the corresponding function description from the spec</span>
        <span class="n">spec</span> <span class="o">=</span> <span class="n">modelpath_to_spec_and_weightdir</span><span class="p">[</span><span class="n">model_path</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">function_spec</span> <span class="o">=</span> <span class="n">get_function_spec</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">src_func_name</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">function_spec</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;function_spec should not have name set&quot;</span>
        <span class="n">function_spec</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">target_func_name</span>
        <span class="n">function_to_desc</span><span class="p">[</span><span class="n">target_func_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">function_spec</span>

    <span class="c1"># Here we deduplicate the same weights across functions, to allow consts to use</span>
    <span class="c1"># the same blob file value when lowered into milproto.</span>
    <span class="c1"># By weight sharing, we can make the model size as small as we could.</span>
    <span class="n">graph_pass</span> <span class="o">=</span> <span class="n">_PASS_REGISTRY</span><span class="p">[</span><span class="s2">&quot;common::const_deduplication&quot;</span><span class="p">]</span>
    <span class="n">graph_pass</span><span class="o">.</span><span class="n">_deduplicate_const_across_functions</span><span class="p">(</span><span class="n">multifunction_prog</span><span class="p">)</span>

    <span class="c1"># set default function name</span>
    <span class="n">default_function_name</span> <span class="o">=</span> <span class="n">desc</span><span class="o">.</span><span class="n">default_function_name</span>
    <span class="k">if</span> <span class="n">default_function_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;default_function_name must be set for the MultiFunctionDescriptor instance before calling save_multifunction.&quot;</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">default_function_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">multifunction_prog</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;default_function_name </span><span class="si">{</span><span class="n">default_function_name</span><span class="si">}</span><span class="s2"> not found in the program. Available functions names are </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">multifunction_prog</span><span class="o">.</span><span class="n">functions</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="n">multifunction_prog</span><span class="o">.</span><span class="n">default_function_name</span> <span class="o">=</span> <span class="n">default_function_name</span>

    <span class="c1"># export program into multi-functions CoreML model</span>
    <span class="n">functions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">multifunction_prog</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
        <span class="n">functions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">function_to_desc</span><span class="p">[</span><span class="n">func</span><span class="p">])</span>
    <span class="n">model_description</span> <span class="o">=</span> <span class="n">_proto</span><span class="o">.</span><span class="n">Model_pb2</span><span class="o">.</span><span class="n">ModelDescription</span><span class="p">(</span>
        <span class="n">functions</span><span class="o">=</span><span class="n">functions</span><span class="p">,</span>
        <span class="n">defaultFunctionName</span><span class="o">=</span><span class="n">default_function_name</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">multifunction_prog</span><span class="o">.</span><span class="n">skip_all_passes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">mlmodel</span> <span class="o">=</span> <span class="n">_mil_convert</span><span class="p">(</span>
        <span class="n">multifunction_prog</span><span class="p">,</span>
        <span class="n">convert_to</span><span class="o">=</span><span class="s2">&quot;mlprogram&quot;</span><span class="p">,</span>
        <span class="n">convert_from</span><span class="o">=</span><span class="s2">&quot;milinternal&quot;</span><span class="p">,</span>
        <span class="n">specification_version</span><span class="o">=</span><span class="n">spec_version</span><span class="p">,</span>
        <span class="n">compute_units</span><span class="o">=</span><span class="n">_ct</span><span class="o">.</span><span class="n">ComputeUnit</span><span class="o">.</span><span class="n">CPU_ONLY</span><span class="p">,</span>
        <span class="n">model_description</span><span class="o">=</span><span class="n">model_description</span><span class="p">,</span>
        <span class="n">export_multi_functions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">skip_model_load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">mlmodel</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">destination_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="materialize_dynamic_shape_mlmodel">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.materialize_dynamic_shape_mlmodel">[docs]</a>
<span class="k">def</span> <span class="nf">materialize_dynamic_shape_mlmodel</span><span class="p">(</span>
    <span class="n">dynamic_shape_mlmodel</span><span class="p">:</span> <span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">,</span>
    <span class="n">function_name_to_materialization_map</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]]],</span>
    <span class="n">destination_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">source_function_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;main&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Given a dynamic-shape mlmodel, materialize symbols to create fixed-shape functions,</span>
<span class="sd">    then save as an .mlpackage to destination path.</span>
<span class="sd">    To save memory, the pymil program of input dynamic-shape mlmodel is re-used.</span>
<span class="sd">    Constant deduplication across functions is performed to allow weight sharing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dynamic_shape_mlmodel : ct.models.MLModel</span>
<span class="sd">        A dynamic-shape mlmodel to be materialized</span>

<span class="sd">    function_name_to_materialization_map: Dict[str, Dict[str, Tuple[int]]]</span>
<span class="sd">        A dictionary specifying the name of new functions to be created,</span>
<span class="sd">        and for each new function what is the new fixed shapes for inputs.</span>
<span class="sd">        If a new function has the same name as an old function,</span>
<span class="sd">        then the old function will be overridden</span>

<span class="sd">    destination_path : str</span>
<span class="sd">        The saved .mlpackage model path</span>

<span class="sd">    source_function_name: str</span>
<span class="sd">        The name of the source symbolic-shape function to be materialized, default = main</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        from coremltools.utils import materialize_dynamic_shape_mlmodel</span>

<span class="sd">        # A dynamic-shape mlmodel you have converted</span>
<span class="sd">        dynamic_shape_mlmodel: ct.models.MLModel</span>

<span class="sd">        # As an example, let us assume the inputs are</span>
<span class="sd">        # 1. ``input_ids (1, query_length)``</span>
<span class="sd">        # 2. ``mask (query_length, context_length)``</span>
<span class="sd">        function_name_to_materialization_map = {</span>
<span class="sd">            &quot;function_name_to_materialization_map&quot;: {</span>
<span class="sd">                &quot;materialization_2_3&quot;: {&quot;input_ids&quot;: (1, 2), &quot;mask&quot;: (2, 3)},</span>
<span class="sd">                &quot;materialization_4_5&quot;: {&quot;input_ids&quot;: (1, 4), &quot;mask&quot;: (4, 5)},</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">        materialize_dynamic_shape_mlmodel(</span>
<span class="sd">            dynamic_shape_mlmodel,</span>
<span class="sd">            function_name_to_materialization_map,</span>
<span class="sd">            &quot;materialized_model.mlpackage&quot;,</span>
<span class="sd">        )</span>

<span class="sd">    To make prediction from the materialized mlmodel, load the desired materialized function</span>

<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        materialization_2_3 = ct.models.MLModel(</span>
<span class="sd">            &quot;materialized_model.mlpackage&quot;, function_name=&quot;materialization_2_3&quot;</span>
<span class="sd">        )</span>
<span class="sd">        materialization_4_5 = ct.models.MLModel(</span>
<span class="sd">            &quot;materialized_model.mlpackage&quot;, function_name=&quot;materialization_4_5&quot;</span>
<span class="sd">        )</span>

<span class="sd">    See Also</span>
<span class="sd">    --------</span>
<span class="sd">    coremltools.converters.mil.mil.passes.defs.experiment.materialize_symbolic_shape_program</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We do the lazy import to prevent circular import</span>
    <span class="kn">from</span> <span class="nn">coremltools.converters.mil.converter</span> <span class="kn">import</span> <span class="n">mil_convert</span> <span class="k">as</span> <span class="n">_mil_convert</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dynamic_shape_mlmodel</span><span class="p">,</span> <span class="n">_ct</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MLModel</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Dynamic shape mlmodel must be type of ct.models.MLModel, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dynamic_shape_mlmodel</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
    <span class="k">for</span> <span class="nb">input</span> <span class="ow">in</span> <span class="n">dynamic_shape_mlmodel</span><span class="o">.</span><span class="n">_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">input</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;multiArrayType&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only tensor input is handled yet&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">dynamic_shape_mlmodel</span><span class="o">.</span><span class="n">_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">output</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">WhichOneof</span><span class="p">(</span><span class="s2">&quot;Type&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="s2">&quot;multiArrayType&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Only tensor output is handled yet&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dynamic_shape_mlmodel</span><span class="o">.</span><span class="n">_mil_program</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dynamic_shape_prog</span> <span class="o">=</span> <span class="n">dynamic_shape_mlmodel</span><span class="o">.</span><span class="n">_mil_program</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">dynamic_shape_prog</span> <span class="o">=</span> <span class="n">_milproto_to_pymil</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">dynamic_shape_mlmodel</span><span class="o">.</span><span class="n">_spec</span><span class="p">,</span>
            <span class="n">dynamic_shape_mlmodel</span><span class="o">.</span><span class="n">_spec</span><span class="o">.</span><span class="n">specificationVersion</span><span class="p">,</span>
            <span class="n">dynamic_shape_mlmodel</span><span class="o">.</span><span class="n">weights_dir</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># Materialize symbolic shapes, then run all optimization passes</span>
    <span class="n">pass_pipeline</span> <span class="o">=</span> <span class="n">_ct</span><span class="o">.</span><span class="n">PassPipeline</span><span class="o">.</span><span class="n">DEFAULT</span>
    <span class="n">pass_pipeline</span><span class="o">.</span><span class="n">insert_pass</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;common::materialize_symbolic_shape_program&quot;</span><span class="p">)</span>
    <span class="n">pass_pipeline</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span>
        <span class="s2">&quot;common::materialize_symbolic_shape_program&quot;</span><span class="p">,</span>
        <span class="p">{</span>
            <span class="s2">&quot;function_name_to_materialization_map&quot;</span><span class="p">:</span> <span class="n">function_name_to_materialization_map</span><span class="p">,</span>
            <span class="s2">&quot;source_function_name&quot;</span><span class="p">:</span> <span class="n">source_function_name</span><span class="p">,</span>
        <span class="p">},</span>
    <span class="p">)</span>
    <span class="n">_PassPipelineManager</span><span class="o">.</span><span class="n">apply_pipeline</span><span class="p">(</span><span class="n">dynamic_shape_prog</span><span class="p">,</span> <span class="n">pass_pipeline</span><span class="p">)</span>

    <span class="c1"># Weights are duplicated in each materialized new function</span>
    <span class="c1"># By default, graph pass const_deduplication will not deduplicate across functions,</span>
    <span class="c1"># so we need to call it explicitly here</span>
    <span class="n">const_deduplication_pass</span> <span class="o">=</span> <span class="n">_PASS_REGISTRY</span><span class="p">[</span><span class="s2">&quot;common::const_deduplication&quot;</span><span class="p">]</span>
    <span class="n">const_deduplication_pass</span><span class="o">.</span><span class="n">_deduplicate_const_across_functions</span><span class="p">(</span><span class="n">dynamic_shape_prog</span><span class="p">)</span>

    <span class="n">export_multi_functions</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="c1"># If source function is the only function in source model,</span>
    <span class="c1"># and source function is replaced with materialization,</span>
    <span class="c1"># and materialization does not create other functions,</span>
    <span class="c1"># then we will end up with a unifunction model</span>
    <span class="c1"># Core ML distinguishs &quot;unifunction model&quot; and &quot;multifunction model with only 1 function&quot;</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">dynamic_shape_prog</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">function_name_to_materialization_map</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="ow">and</span> <span class="n">source_function_name</span> <span class="ow">in</span> <span class="n">function_name_to_materialization_map</span>
    <span class="p">):</span>
        <span class="n">export_multi_functions</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># Multifunciton is added in iOS 18, so</span>
    <span class="c1"># * if export multifunction, then specification version has to be iOS 18+</span>
    <span class="c1"># * else, specification version can be the same as original version</span>
    <span class="n">specification_version</span> <span class="o">=</span> <span class="n">dynamic_shape_mlmodel</span><span class="o">.</span><span class="n">_spec</span><span class="o">.</span><span class="n">specificationVersion</span>
    <span class="k">if</span> <span class="n">export_multi_functions</span><span class="p">:</span>
        <span class="n">specification_version</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_ct</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">iOS18</span><span class="p">,</span> <span class="n">specification_version</span><span class="p">)</span>

    <span class="n">dynamic_shape_prog</span><span class="o">.</span><span class="n">skip_all_passes</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">materialized_mlmodel</span> <span class="o">=</span> <span class="n">_mil_convert</span><span class="p">(</span>
        <span class="n">dynamic_shape_prog</span><span class="p">,</span>
        <span class="n">convert_from</span><span class="o">=</span><span class="s2">&quot;milinternal&quot;</span><span class="p">,</span>
        <span class="n">convert_to</span><span class="o">=</span><span class="s2">&quot;mlprogram&quot;</span><span class="p">,</span>
        <span class="n">specification_version</span><span class="o">=</span><span class="n">specification_version</span><span class="p">,</span>
        <span class="n">compute_units</span><span class="o">=</span><span class="n">_ct</span><span class="o">.</span><span class="n">ComputeUnit</span><span class="o">.</span><span class="n">CPU_ONLY</span><span class="p">,</span>
        <span class="n">export_multi_functions</span><span class="o">=</span><span class="n">export_multi_functions</span><span class="p">,</span>
        <span class="n">skip_model_load</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">materialized_mlmodel</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">destination_path</span><span class="p">)</span></div>



<div class="viewcode-block" id="randomize_weights">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.randomize_weights">[docs]</a>
<span class="k">def</span> <span class="nf">randomize_weights</span><span class="p">(</span><span class="n">mlmodel</span><span class="p">:</span> <span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function to randomize weights</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mlmodel: MLModel</span>
<span class="sd">        Model which will be randomized.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    model: MLModel</span>
<span class="sd">        The MLModel with randomized weights.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        import coremltools as ct</span>

<span class="sd">        model = ct.models.MLModel(&quot;my_model.mlpackage&quot;)</span>
<span class="sd">        randomized_mlmodel = ct.models.utils.randomize_weights(mlmodel)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">randomized_mlmodel</span> <span class="o">=</span> <span class="n">_apply_graph_pass</span><span class="p">(</span>
        <span class="n">mlmodel</span><span class="p">,</span> <span class="n">graph_pass</span><span class="o">=</span><span class="n">_WeightRandomizer</span><span class="p">(),</span> <span class="n">skip_model_load</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">randomized_mlmodel</span></div>



<div class="viewcode-block" id="bisect_model">
<a class="viewcode-back" href="../../../source/coremltools.models.html#coremltools.models.utils.bisect_model">[docs]</a>
<span class="k">def</span> <span class="nf">bisect_model</span><span class="p">(</span>
    <span class="n">model</span><span class="p">:</span> <span class="n">_Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">],</span>
    <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">merge_chunks_to_pipeline</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">check_output_correctness</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Utility function to split a mlpackage model into two mlpackages of approximately same file size.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    model: str or MLModel</span>
<span class="sd">        Path to the mlpackage file, or a Core ML model, to be split into two mlpackages of approximately same file size.</span>

<span class="sd">    output_dir: str</span>
<span class="sd">        Path to output directory where the two model chunks / pipeline model would be saved.</span>

<span class="sd">        If the `model` is `{path}/{model_name}.mlpackage`, the chunk models are going to be saved as:</span>
<span class="sd">        1. first chunk model: `{output_dir}/{model_name}_chunk1.mlpackage`</span>
<span class="sd">        2. second chunk model: `{output_dir}/{model_name}_chunk2.mlpackage`</span>
<span class="sd">        3. chunked pipeline model: `{output_dir}/{model_name}_chunked_pipeline.mlpackage`</span>

<span class="sd">        If the `model` is type of `MLModel`, the chunk models are saved as:</span>
<span class="sd">        1. first chunk model: `{output_dir}/chunk1.mlpackage`</span>
<span class="sd">        2. second chunk model: `{output_dir}/chunk2.mlpackage`</span>
<span class="sd">        3. chunked pipeline model: `{output_dir}/chunked_pipeline.mlpackage`</span>

<span class="sd">    merge_chunks_to_pipeline: bool</span>
<span class="sd">        If True, model chunks are managed inside a single pipeline model for easier asset maintenance.</span>

<span class="sd">    check_output_correctness: bool</span>
<span class="sd">        - If True, compares the outputs of original Core ML model with that of pipelined CoreML model chunks and reports PSNR in dB.</span>
<span class="sd">        - Enabling this feature uses more memory. Disable it if your machine runs out of memory.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    .. sourcecode:: python</span>

<span class="sd">        import coremltools as ct</span>

<span class="sd">        model_path = &quot;my_model.mlpackage&quot;</span>
<span class="sd">        output_dir = &quot;./output/&quot;</span>

<span class="sd">        # The following code will produce two smaller models:</span>
<span class="sd">        # `./output/my_model_chunk1.mlpackage` and `./output/my_model_chunk2.mlpackage`</span>
<span class="sd">        # It also compares the output numerical of the original Core ML model with the chunked models.</span>
<span class="sd">        ct.models.utils.bisect_model(</span>
<span class="sd">            model_path,</span>
<span class="sd">            output_dir,</span>
<span class="sd">        )</span>

<span class="sd">        # The following code will produce a single pipeline model `./output/my_model_chunked_pipeline.mlpackage`</span>
<span class="sd">        ct.models.utils.bisect_model(</span>
<span class="sd">            model_path,</span>
<span class="sd">            output_dir,</span>
<span class="sd">            merge_chunks_to_pipeline=True,</span>
<span class="sd">        )</span>

<span class="sd">        # You can also pass the MLModel object directly</span>
<span class="sd">        mlmodel = ct.models.MLModel(model_path)</span>
<span class="sd">        ct.models.utils.bisect_model(</span>
<span class="sd">            mlmodel,</span>
<span class="sd">            output_dir,</span>
<span class="sd">            merge_chunks_to_pipeline=True,</span>
<span class="sd">        )</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># We do the lazy import to prevent circular import</span>
    <span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">MLModel</span>
    <span class="kn">from</span> <span class="nn">coremltools.converters.mil.converter</span> <span class="kn">import</span> <span class="n">mil_convert</span> <span class="k">as</span> <span class="n">_mil_convert</span>

    <span class="k">def</span> <span class="nf">get_pymil_prog_and_spec_from_model</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>

        <span class="c1"># get the model spec and weight directory</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">load_spec</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">weights_dir</span> <span class="o">=</span> <span class="n">_try_get_weights_dir_path</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">spec</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">_spec</span>
            <span class="n">weights_dir</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">weights_dir</span>

        <span class="c1"># convert the model spec into pymil program,</span>
        <span class="c1"># we also convert operations into type of List</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="n">_milproto_to_pymil</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
            <span class="n">spec</span><span class="p">,</span>
            <span class="n">spec</span><span class="o">.</span><span class="n">specificationVersion</span><span class="p">,</span>
            <span class="n">weights_dir</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">prog</span><span class="o">.</span><span class="n">functions</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="s2">&quot;main&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prog</span><span class="o">.</span><span class="n">functions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;&#39;bisect_model&#39; only support model with a single &#39;main&#39; function.&quot;</span><span class="p">)</span>
        
        <span class="n">func</span> <span class="o">=</span> <span class="n">prog</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span>
        <span class="n">func</span><span class="o">.</span><span class="n">operations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">operations</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">prog</span><span class="p">,</span> <span class="n">spec</span>

    <span class="c1"># check the input type of model</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">MLModel</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;&#39;model&#39; must be type of [str, MLModel]. Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="c1"># The below implementation assumes that the model is single function, with a &quot;main&quot; function.</span>
    <span class="n">prog</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">get_pymil_prog_and_spec_from_model</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
    <span class="n">spec_version</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">specificationVersion</span>

    <span class="c1"># Compute the incision point by bisecting the program based on weights size</span>
    <span class="n">op_idx</span><span class="p">,</span> <span class="n">first_chunk_weights_size</span><span class="p">,</span> <span class="n">total_weights_size</span> <span class="o">=</span> <span class="n">_get_op_idx_split_location</span><span class="p">(</span><span class="n">prog</span><span class="p">)</span>
    <span class="n">main_block</span> <span class="o">=</span> <span class="n">prog</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span>
    <span class="n">incision_op</span> <span class="o">=</span> <span class="n">main_block</span><span class="o">.</span><span class="n">operations</span><span class="p">[</span><span class="n">op_idx</span><span class="p">]</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;The incision op: name=</span><span class="si">{</span><span class="n">incision_op</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, type=</span><span class="si">{</span><span class="n">incision_op</span><span class="o">.</span><span class="n">op_type</span><span class="si">}</span><span class="s2">, index=</span><span class="si">{</span><span class="n">op_idx</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">main_block</span><span class="o">.</span><span class="n">operations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;First chunk size = </span><span class="si">{</span><span class="n">first_chunk_weights_size</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Second chunk size = </span><span class="si">{</span><span class="n">total_weights_size</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">first_chunk_weights_size</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> MB&quot;</span><span class="p">)</span>

    <span class="c1"># Build first chunk (in-place modifies prog by declaring early exits and removing unused subgraph)</span>
    <span class="n">prog_chunk1</span> <span class="o">=</span> <span class="n">_make_first_chunk_prog</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">op_idx</span><span class="p">)</span>

    <span class="c1"># Build the second chunk</span>
    <span class="c1"># when the first chunk is created, the prog is modified in-place, so we need to re-convert a new pymil</span>
    <span class="c1"># program for the second chunk.</span>
    <span class="n">prog_chunk2</span> <span class="o">=</span> <span class="n">_make_second_chunk_prog</span><span class="p">(</span>
        <span class="n">get_pymil_prog_and_spec_from_model</span><span class="p">(</span><span class="n">model</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">op_idx</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Convert the MIL Program objects into MLModels</span>
    <span class="c1"># We skip_model_load if check_output_correctness=False</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Converting the two programs&quot;</span><span class="p">)</span>
    <span class="n">model_chunk1</span> <span class="o">=</span> <span class="n">_mil_convert</span><span class="p">(</span>
        <span class="n">prog_chunk1</span><span class="p">,</span>
        <span class="n">convert_to</span><span class="o">=</span><span class="s2">&quot;mlprogram&quot;</span><span class="p">,</span>
        <span class="n">convert_from</span><span class="o">=</span><span class="s2">&quot;milinternal&quot;</span><span class="p">,</span>
        <span class="n">specification_version</span><span class="o">=</span><span class="n">spec_version</span><span class="p">,</span>
        <span class="n">compute_units</span><span class="o">=</span><span class="n">_ct</span><span class="o">.</span><span class="n">ComputeUnit</span><span class="o">.</span><span class="n">CPU_ONLY</span><span class="p">,</span>
        <span class="n">skip_model_load</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">check_output_correctness</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">del</span> <span class="n">prog_chunk1</span>
    <span class="n">_gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Conversion of first chunk done.&quot;</span><span class="p">)</span>

    <span class="n">model_chunk2</span> <span class="o">=</span> <span class="n">_mil_convert</span><span class="p">(</span>
        <span class="n">prog_chunk2</span><span class="p">,</span>
        <span class="n">convert_to</span><span class="o">=</span><span class="s2">&quot;mlprogram&quot;</span><span class="p">,</span>
        <span class="n">convert_from</span><span class="o">=</span><span class="s2">&quot;milinternal&quot;</span><span class="p">,</span>
        <span class="n">specification_version</span><span class="o">=</span><span class="n">spec_version</span><span class="p">,</span>
        <span class="n">compute_units</span><span class="o">=</span><span class="n">_ct</span><span class="o">.</span><span class="n">ComputeUnit</span><span class="o">.</span><span class="n">CPU_ONLY</span><span class="p">,</span>
        <span class="n">skip_model_load</span><span class="o">=</span><span class="p">(</span><span class="ow">not</span> <span class="n">check_output_correctness</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="k">del</span> <span class="n">prog_chunk2</span>
    <span class="n">_gc</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Conversion of second chunk done.&quot;</span><span class="p">)</span>

    <span class="c1"># Verify output correctness</span>
    <span class="k">if</span> <span class="n">check_output_correctness</span><span class="p">:</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying output correctness of chunks&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">mlmodel</span> <span class="o">=</span> <span class="n">_ct</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MLModel</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">compute_units</span><span class="o">=</span><span class="n">_ct</span><span class="o">.</span><span class="n">ComputeUnit</span><span class="o">.</span><span class="n">CPU_ONLY</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mlmodel</span> <span class="o">=</span> <span class="n">model</span>

        <span class="n">_verify_output_correctness_of_chunks</span><span class="p">(</span>
            <span class="n">full_model</span><span class="o">=</span><span class="n">mlmodel</span><span class="p">,</span>
            <span class="n">first_chunk_model</span><span class="o">=</span><span class="n">model_chunk1</span><span class="p">,</span>
            <span class="n">second_chunk_model</span><span class="o">=</span><span class="n">model_chunk2</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="c1"># save model chunks</span>
    <span class="n">_os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">mlpackage_name</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">name</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">mlpackage_name</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">merge_chunks_to_pipeline</span><span class="p">:</span>
        <span class="c1"># Make a single pipeline model to manage the model chunks</span>
        <span class="n">pipeline_model</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">model_chunk1</span><span class="p">,</span> <span class="n">model_chunk2</span><span class="p">)</span>
        <span class="n">out_path_pipeline</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;chunked_pipeline.mlpackage&quot;</span><span class="p">)</span>
        <span class="n">pipeline_model</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_path_pipeline</span><span class="p">)</span>

        <span class="c1"># reload to ensure CPU placement</span>
        <span class="k">if</span> <span class="n">check_output_correctness</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Verifying output correctness of pipeline model&quot;</span><span class="p">)</span>
            <span class="n">pipeline_model</span> <span class="o">=</span> <span class="n">_ct</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MLModel</span><span class="p">(</span>
                <span class="n">out_path_pipeline</span><span class="p">,</span> <span class="n">compute_units</span><span class="o">=</span><span class="n">_ct</span><span class="o">.</span><span class="n">ComputeUnit</span><span class="o">.</span><span class="n">CPU_ONLY</span>
            <span class="p">)</span>
            <span class="n">_verify_output_correctness_of_chunks</span><span class="p">(</span>
                <span class="n">full_model</span><span class="o">=</span><span class="n">mlmodel</span><span class="p">,</span>
                <span class="n">pipeline_model</span><span class="o">=</span><span class="n">pipeline_model</span><span class="p">,</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Save the chunked models to disk</span>
        <span class="n">out_path_chunk1</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;chunk1.mlpackage&quot;</span><span class="p">)</span>
        <span class="n">out_path_chunk2</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;chunk2.mlpackage&quot;</span><span class="p">)</span>
        <span class="n">model_chunk1</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_path_chunk1</span><span class="p">)</span>
        <span class="n">model_chunk2</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">out_path_chunk2</span><span class="p">)</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Saved chunks in </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2"> with the suffix _chunk1.mlpackage and _chunk2.mlpackage&quot;</span>
        <span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_verify_output_correctness_of_chunks</span><span class="p">(</span>
    <span class="n">full_model</span><span class="p">:</span> <span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">,</span>
    <span class="n">first_chunk_model</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">second_chunk_model</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pipeline_model</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="s2">&quot;_ct.models.MLModel&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Verifies the end-to-end output correctness of full (original) model versus chunked models&quot;&quot;&quot;</span>
    <span class="c1"># lazy import avoids circular error</span>
    <span class="kn">from</span> <span class="nn">coremltools.converters.mil.testing_utils</span> <span class="kn">import</span> <span class="n">random_gen_input_feature_type</span> <span class="k">as</span> <span class="n">random_gen_input_feature_type</span>
    <span class="kn">from</span> <span class="nn">coremltools.converters.mil.testing_utils</span> <span class="kn">import</span> <span class="n">compute_snr_and_psnr</span>

    <span class="k">def</span> <span class="nf">report_correctness</span><span class="p">(</span><span class="n">original_outputs</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">final_outputs</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">log_prefix</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot; Report PSNR values across two compatible tensors.</span>
<span class="sd">        This util is from https://github.com/apple/ml-stable-diffusion/blob/main/python_coreml_stable_diffusion/torch2coreml.py#L80,</span>
<span class="sd">        with a slightly modification.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ABSOLUTE_MIN_PSNR</span> <span class="o">=</span> <span class="mi">35</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">original_psnr</span> <span class="o">=</span> <span class="n">compute_snr_and_psnr</span><span class="p">(</span><span class="n">original_outputs</span><span class="p">,</span> <span class="n">original_outputs</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">final_psnr</span> <span class="o">=</span> <span class="n">compute_snr_and_psnr</span><span class="p">(</span><span class="n">original_outputs</span><span class="p">,</span> <span class="n">final_outputs</span><span class="p">)</span>

        <span class="n">dB_change</span> <span class="o">=</span> <span class="n">final_psnr</span> <span class="o">-</span> <span class="n">original_psnr</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">log_prefix</span><span class="si">}</span><span class="s2">: PSNR changed by </span><span class="si">{</span><span class="n">dB_change</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> dB (</span><span class="si">{</span><span class="n">original_psnr</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> -&gt; </span><span class="si">{</span><span class="n">final_psnr</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">)&quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">final_psnr</span> <span class="o">&lt;</span> <span class="n">ABSOLUTE_MIN_PSNR</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">final_psnr</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> dB is low!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">final_psnr</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2"> dB &gt; </span><span class="si">{</span><span class="n">ABSOLUTE_MIN_PSNR</span><span class="si">}</span><span class="s2"> dB (minimum allowed) parity check passed&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">final_psnr</span>

    
    <span class="c1"># Generate inputs for first chunk and full model</span>
    <span class="n">input_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">input_desc</span> <span class="ow">in</span> <span class="n">full_model</span><span class="o">.</span><span class="n">_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
        <span class="n">input_dict</span><span class="p">[</span><span class="n">input_desc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">random_gen_input_feature_type</span><span class="p">(</span><span class="n">input_desc</span><span class="p">)</span>

    <span class="c1"># Generate outputs for full model</span>
    <span class="n">outputs_from_full_model</span> <span class="o">=</span> <span class="n">full_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pipeline_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">outputs_from_pipeline_model</span> <span class="o">=</span> <span class="n">pipeline_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>
        <span class="n">final_outputs</span> <span class="o">=</span> <span class="n">outputs_from_pipeline_model</span>

    <span class="k">elif</span> <span class="n">first_chunk_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">second_chunk_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Generate outputs for first chunk</span>
        <span class="n">outputs_from_first_chunk_model</span> <span class="o">=</span> <span class="n">first_chunk_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">input_dict</span><span class="p">)</span>

        <span class="c1"># Prepare inputs for second chunk model from first chunk&#39;s outputs and regular inputs</span>
        <span class="n">second_chunk_input_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">input_desc</span> <span class="ow">in</span> <span class="n">second_chunk_model</span><span class="o">.</span><span class="n">_spec</span><span class="o">.</span><span class="n">description</span><span class="o">.</span><span class="n">input</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">input_desc</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">outputs_from_first_chunk_model</span><span class="p">:</span>
                <span class="n">second_chunk_input_dict</span><span class="p">[</span><span class="n">input_desc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs_from_first_chunk_model</span><span class="p">[</span>
                    <span class="n">input_desc</span><span class="o">.</span><span class="n">name</span>
                <span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">second_chunk_input_dict</span><span class="p">[</span><span class="n">input_desc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">input_dict</span><span class="p">[</span><span class="n">input_desc</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="c1"># Generate output for second chunk model</span>
        <span class="n">outputs_from_second_chunk_model</span> <span class="o">=</span> <span class="n">second_chunk_model</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">second_chunk_input_dict</span><span class="p">)</span>
        <span class="n">final_outputs</span> <span class="o">=</span> <span class="n">outputs_from_second_chunk_model</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Either a single Pipeline model or two model chunks should be provided.&quot;</span><span class="p">)</span>

    <span class="c1"># Verify correctness across all outputs from second chunk and full model</span>
    <span class="k">for</span> <span class="n">out_name</span> <span class="ow">in</span> <span class="n">outputs_from_full_model</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">report_correctness</span><span class="p">(</span>
            <span class="n">original_outputs</span><span class="o">=</span><span class="n">outputs_from_full_model</span><span class="p">[</span><span class="n">out_name</span><span class="p">],</span>
            <span class="n">final_outputs</span><span class="o">=</span><span class="n">final_outputs</span><span class="p">[</span><span class="n">out_name</span><span class="p">],</span>
            <span class="n">log_prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">out_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_op_idx_split_location</span><span class="p">(</span><span class="n">prog</span><span class="p">:</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Program</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Find the op that approximately bisects the graph as measure by weights size on each side&quot;&quot;&quot;</span>
    <span class="n">main_block</span> <span class="o">=</span> <span class="n">prog</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span>
    <span class="n">total_size_in_mb</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">main_block</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">op_type</span> <span class="o">==</span> <span class="s2">&quot;const&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">size_in_mb</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">op</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="n">total_size_in_mb</span> <span class="o">+=</span> <span class="n">size_in_mb</span>
    <span class="n">half_size</span> <span class="o">=</span> <span class="n">total_size_in_mb</span> <span class="o">/</span> <span class="mi">2</span>

    <span class="c1"># Find the first non const op (single child), where the total cumulative size exceeds</span>
    <span class="c1"># the half size for the first time</span>
    <span class="n">cumulative_size_in_mb</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">main_block</span><span class="o">.</span><span class="n">operations</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span><span class="o">.</span><span class="n">op_type</span> <span class="o">==</span> <span class="s2">&quot;const&quot;</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">val</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
            <span class="n">size_in_mb</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">op</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">val</span><span class="o">.</span><span class="n">itemsize</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
            <span class="n">cumulative_size_in_mb</span> <span class="o">+=</span> <span class="n">size_in_mb</span>

        <span class="c1"># Note: The condition &quot;not op.op_type.startswith(&quot;const&quot;)&quot; is to make sure that the</span>
        <span class="c1"># incision op is neither of type &quot;const&quot; nor &quot;constexpr_*&quot; ops that</span>
        <span class="c1"># are used to store compressed weights</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">cumulative_size_in_mb</span> <span class="o">&gt;=</span> <span class="n">half_size</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">op_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">)</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">child_ops</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="p">):</span>
            <span class="n">op_idx</span> <span class="o">=</span> <span class="n">main_block</span><span class="o">.</span><span class="n">operations</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">op</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">op_idx</span><span class="p">,</span> <span class="n">cumulative_size_in_mb</span><span class="p">,</span> <span class="n">total_size_in_mb</span>

    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Not able to find the bisect point in the model.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_get_first_chunk_outputs</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Block</span><span class="p">,</span> <span class="n">op_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_List</span><span class="p">[</span><span class="n">_mil</span><span class="o">.</span><span class="n">Var</span><span class="p">]:</span>
    <span class="c1"># Get the list of all vars that go across from first program (all ops from 0 to op_idx (inclusive))</span>
    <span class="c1"># to the second program (all ops from op_idx+1 till the end). These all vars need to be made the output</span>
    <span class="c1"># of the first program and the input of the second program</span>
    <span class="n">boundary_vars</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">op_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">op</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">operations</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">op</span><span class="o">.</span><span class="n">op_type</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;const&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">op</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># only consider non const vars</span>
                    <span class="k">for</span> <span class="n">child_op</span> <span class="ow">in</span> <span class="n">var</span><span class="o">.</span><span class="n">child_ops</span><span class="p">:</span>
                        <span class="n">child_op_idx</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">operations</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">child_op</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">child_op_idx</span> <span class="o">&gt;</span> <span class="n">op_idx</span><span class="p">:</span>
                            <span class="n">boundary_vars</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">boundary_vars</span><span class="p">)</span>


<span class="nd">@_block_context_manager</span>
<span class="k">def</span> <span class="nf">_add_fp32_casts</span><span class="p">(</span><span class="n">block</span><span class="p">:</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Block</span><span class="p">,</span> <span class="n">boundary_vars</span><span class="p">:</span> <span class="n">_List</span><span class="p">[</span><span class="n">_mil</span><span class="o">.</span><span class="n">Var</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="n">new_boundary_vars</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">boundary_vars</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">_mil</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">fp16</span><span class="p">:</span>
            <span class="n">new_boundary_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp32_var</span> <span class="o">=</span> <span class="n">_mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="n">new_boundary_vars</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp32_var</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">new_boundary_vars</span>


<span class="k">def</span> <span class="nf">_make_first_chunk_prog</span><span class="p">(</span>
    <span class="n">prog</span><span class="p">:</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Program</span><span class="p">,</span>
    <span class="n">op_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Program</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build first chunk by declaring early outputs and removing unused subgraph&quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">prog</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span>
    <span class="n">boundary_vars</span> <span class="o">=</span> <span class="n">_get_first_chunk_outputs</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">op_idx</span><span class="p">)</span>

    <span class="c1"># Due to possible numerical issues, cast any fp16 var to fp32</span>
    <span class="n">new_boundary_vars</span> <span class="o">=</span> <span class="n">_add_fp32_casts</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">boundary_vars</span><span class="p">)</span>

    <span class="n">block</span><span class="o">.</span><span class="n">outputs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
    <span class="n">block</span><span class="o">.</span><span class="n">set_outputs</span><span class="p">(</span><span class="n">new_boundary_vars</span><span class="p">)</span>
    <span class="n">_PASS_REGISTRY</span><span class="p">[</span><span class="s2">&quot;common::dead_code_elimination&quot;</span><span class="p">](</span><span class="n">prog</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prog</span>


<span class="k">def</span> <span class="nf">_make_second_chunk_prog</span><span class="p">(</span><span class="n">prog</span><span class="p">:</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Program</span><span class="p">,</span> <span class="n">op_idx</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_mil</span><span class="o">.</span><span class="n">Program</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Build second chunk by rebuilding a pristine MIL Program from MLModel&quot;&quot;&quot;</span>
    <span class="n">block</span> <span class="o">=</span> <span class="n">prog</span><span class="o">.</span><span class="n">functions</span><span class="p">[</span><span class="s2">&quot;main&quot;</span><span class="p">]</span>
    <span class="n">block</span><span class="o">.</span><span class="n">opset_version</span> <span class="o">=</span> <span class="n">_ct</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">iOS16</span>

    <span class="c1"># First chunk outputs are second chunk inputs (e.g. skip connections)</span>
    <span class="n">boundary_vars</span> <span class="o">=</span> <span class="n">_get_first_chunk_outputs</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">op_idx</span><span class="p">)</span>

    <span class="c1"># This op will not be included in this program. Its output var will be made into an input</span>
    <span class="n">boundary_op</span> <span class="o">=</span> <span class="n">block</span><span class="o">.</span><span class="n">operations</span><span class="p">[</span><span class="n">op_idx</span><span class="p">]</span>

    <span class="c1"># Add all boundary ops as inputs</span>
    <span class="k">with</span> <span class="n">block</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">boundary_vars</span><span class="p">:</span>
            <span class="n">new_placeholder</span> <span class="o">=</span> <span class="n">_Placeholder</span><span class="p">(</span>
                <span class="n">sym_shape</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span>
                <span class="n">dtype</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">dtype</span> <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">_mil</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">fp16</span> <span class="k">else</span> <span class="n">_mil</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">fp32</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="n">block</span><span class="o">.</span><span class="n">_input_dict</span><span class="p">[</span><span class="n">new_placeholder</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_placeholder</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">block</span><span class="o">.</span><span class="n">function_inputs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">_input_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="n">new_var</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">dtype</span> <span class="o">==</span> <span class="n">_mil</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">fp16</span><span class="p">:</span>
                <span class="n">new_var</span> <span class="o">=</span> <span class="n">_mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">new_placeholder</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp16&quot;</span><span class="p">,</span> <span class="n">before_op</span><span class="o">=</span><span class="n">var</span><span class="o">.</span><span class="n">op</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">new_var</span> <span class="o">=</span> <span class="n">new_placeholder</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">block</span><span class="o">.</span><span class="n">replace_uses_of_var_after_op</span><span class="p">(</span>
                <span class="n">anchor_op</span><span class="o">=</span><span class="n">boundary_op</span><span class="p">,</span>
                <span class="n">old_var</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                <span class="n">new_var</span><span class="o">=</span><span class="n">new_var</span><span class="p">,</span>
                <span class="c1"># This is needed if the program contains &quot;constexpr_*&quot; ops. In normal cases, there are stricter</span>
                <span class="c1"># rules for removing them, and their presence may prevent replacing this var.</span>
                <span class="c1"># However in this case, since we want to remove all the ops in chunk 1, we can safely</span>
                <span class="c1"># set this to True.</span>
                <span class="n">force_replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">_PASS_REGISTRY</span><span class="p">[</span><span class="s2">&quot;common::dead_code_elimination&quot;</span><span class="p">](</span><span class="n">prog</span><span class="p">)</span>

    <span class="c1"># Remove any unused inputs</span>
    <span class="n">new_input_dict</span> <span class="o">=</span> <span class="n">_OrderedDict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">block</span><span class="o">.</span><span class="n">_input_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">child_ops</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_input_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="n">block</span><span class="o">.</span><span class="n">_input_dict</span> <span class="o">=</span> <span class="n">new_input_dict</span>
    <span class="n">block</span><span class="o">.</span><span class="n">function_inputs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">block</span><span class="o">.</span><span class="n">_input_dict</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">prog</span>


</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Apple Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>