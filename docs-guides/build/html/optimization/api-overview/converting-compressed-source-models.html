<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Converting Compressed Source Models &mdash; Core ML Tools Guide  documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/imgstyle.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
        <script src="../../_static/clipboard.min.js"></script>
        <script src="../../_static/copybutton.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Pruning" href="../pruning/pruning.html" />
    <link rel="prev" title="optimize.torch API Overview" href="optimizetorch-api-overview.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> Core ML Tools Guide
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview/overview-coremltools.html">What Is Core ML Tools?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/new-features.html">New Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/faqs.html">Core ML Tools FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/coremltools-examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/migration.html">Migration Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview/contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Essentials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../essentials/installing-coremltools.html">Installing Core ML Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../essentials/introductory-quickstart.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../essentials/unified-conversion-api.html">Core ML Tools API Overview</a></li>
<li class="toctree-l1"><a class="reference external" href="https://apple.github.io/coremltools/mlmodel/index.html">Core ML Model Format</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apple/coremltools">API GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unified Conversion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../unified/convert-learning-models/convert-learning-models.html">Converting Deep Learning Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unified/ml-programs/ml-programs.html">ML Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unified/convert-tensorflow/convert-tensorflow.html">Converting from TensorFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unified/convert-pytorch/convert-pytorch.html">Converting from PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unified/conversion-options/conversion-options.html">Conversion Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../unified/model-intermediate-language.html">Model Intermediate Language</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optimization</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../optimizing-models/optimizing-models.html">Optimizing Models</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="api-overview.html">Optimize API Overview</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="optimizecoreml-api-overview.html">optimize.coreml API Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="optimizetorch-api-overview.html">optimize.torch API Overview</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Converting Compressed Source Models</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#convert-models-with-sparse-weights">Convert models with sparse weights</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-models-with-palettized-weights">Convert models with palettized weights</a></li>
<li class="toctree-l3"><a class="reference internal" href="#convert-pytorch-models-with-quantized-weights-and-activations">Convert PyTorch models with quantized weights and activations</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../pruning/pruning.html">Pruning</a></li>
<li class="toctree-l1"><a class="reference internal" href="../palettization/palettization.html">Palettization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quantization-aware-training/quantization-aware-training.html">Linear 8-Bit Quantization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quantization-neural-network.html">Compressing Neural Network Weights</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Converters</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../other-converters/libsvm-conversion.html">LibSVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other-converters/sci-kit-learn-conversion.html">Scikit-learn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../other-converters/xgboost-conversion.html">XGBoost</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">MLModel</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../mlmodel/mlmodel.html">MLModel Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mlmodel/xcode-model-preview-types.html">Xcode Model Preview Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mlmodel/mlmodel-utilities.html">MLModel Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mlmodel/model-prediction.html">Model Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mlmodel/updatable-model-examples/updatable-model-examples.html">Updatable Models</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Core ML Tools Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="api-overview.html">Optimize API Overview</a> &raquo;</li>
      <li>Converting Compressed Source Models</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/optimization/api-overview/converting-compressed-source-models.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="converting-compressed-source-models">
<h1>Converting Compressed Source Models<a class="headerlink" href="#converting-compressed-source-models" title="Permalink to this heading"></a></h1>
<p>This section shows how you can indicate to the converter to use the sparse or palettized representations to store the weights. This is required when you bring in a source model whose weights are compressed but still represented in dense <code class="docutils literal notranslate"><span class="pre">float</span></code>format.  This is the case for PyTorch models that are updated and fine-tuned using the [<code class="docutils literal notranslate"><span class="pre">ct.optimize.torch</span></code>](doc: optimizetorch-api-overview) APIs.</p>
<section id="convert-models-with-sparse-weights">
<h2>Convert models with sparse weights<a class="headerlink" href="#convert-models-with-sparse-weights" title="Permalink to this heading"></a></h2>
<p>If your source model weights have lots of zeros, then specify the <code class="docutils literal notranslate"><span class="pre">pass_pipeline</span></code> argument as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">coremltools</span> <span class="k">as</span> <span class="nn">ct</span>

<span class="n">model_with_sparse_weights</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
    <span class="n">mlmodel</span><span class="p">,</span>
    <span class="n">pass_pipeline</span><span class="o">=</span><span class="n">ct</span><span class="o">.</span><span class="n">PassPipeline</span><span class="o">.</span><span class="n">DEFAULT_PRUNING</span><span class="p">,</span>
    <span class="n">minimum_deployment_target</span><span class="o">=</span><span class="n">ct</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">iOS17</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>During the conversion process, an additional <span class="xref myst">graph pass</span> will be run, which will convert the weight values below a certain low threshold (<code class="docutils literal notranslate"><span class="pre">default=1e-3</span></code>) to exact zeros, and then use the a sparse representation  to store the weights, thereby saving space.</p>
<p>Remember to use this option to convert any PyTorch model that has been pruned using the <a class="reference external" href="https://apple.github.io/coremltools/source/coremltools.optimize.torch.pruning.html#coremltools.optimize.torch.pruning.MagnitudePruner"><code class="docutils literal notranslate"><span class="pre">ct.optimize.torch.pruning.MagnitudePruner</span></code></a> method.</p>
</section>
<section id="convert-models-with-palettized-weights">
<h2>Convert models with palettized weights<a class="headerlink" href="#convert-models-with-palettized-weights" title="Permalink to this heading"></a></h2>
<p>If your source model weights are palettized; that is, clustered and can only take on a few discrete values, then you can save space by invoking the following pass during conversion:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">coremltools</span> <span class="k">as</span> <span class="nn">ct</span>

<span class="n">model_with_lut_weights</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span>
    <span class="n">mlmodel</span><span class="p">,</span>
    <span class="n">pass_pipeline</span><span class="o">=</span><span class="n">ct</span><span class="o">.</span><span class="n">PassPipeline</span><span class="o">.</span><span class="n">DEFAULT_PALETTIZATION</span><span class="p">,</span>
    <span class="n">minimum_deployment_target</span><span class="o">=</span><span class="n">ct</span><span class="o">.</span><span class="n">target</span><span class="o">.</span><span class="n">macOS13</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>This will invoke an additional <span class="xref myst">graph pass</span> that will automatically detect whether the weights have repeated values. If they do, and if the overall weight tensor has at most 256 or less unique values (which means it can be represented with an 8-bit or less <a class="reference external" href="https://en.wikipedia.org/wiki/Lookup_table">lookup table</a>), it will use a more compact representation using lookup tables (LUTs) to store them.</p>
<p>Remember to use this option to convert any PyTorch model that has been compressed using the <a class="reference external" href="https://apple.github.io/coremltools/source/coremltools.optimize.torch.palettization.html#coremltools.optimize.torch.palettization.DKMPalettizer"><code class="docutils literal notranslate"><span class="pre">ct.optimize.torch.palettization.DKMPalettizer</span></code></a> method.</p>
</section>
<section id="convert-pytorch-models-with-quantized-weights-and-activations">
<h2>Convert PyTorch models with quantized weights and activations<a class="headerlink" href="#convert-pytorch-models-with-quantized-weights-and-activations" title="Permalink to this heading"></a></h2>
<p>For PyTorch models with quantized weights and/or activations, no additional <code class="docutils literal notranslate"><span class="pre">pass_pipeline</span></code> flag is required since PyTorch stores quantized weights or activations using <code class="docutils literal notranslate"><span class="pre">qint</span></code> or <code class="docutils literal notranslate"><span class="pre">quint</span></code> data types, and additional quantization ops are used. This is picked up automatically by the conversion process, which then automatically uses linear quantized storage format to store weights.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="optimizetorch-api-overview.html" class="btn btn-neutral float-left" title="optimize.torch API Overview" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../pruning/pruning.html" class="btn btn-neutral float-right" title="Pruning" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Apple Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>