<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compressing Neural Network Weights &mdash; Core ML Tools Guide  documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/imgstyle.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="LibSVM" href="../other-converters/libsvm-conversion.html" />
    <link rel="prev" title="Training-Time Quantization" href="quantization-aware-training/data-dependent-quantization.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> Core ML Tools Guide
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Overview</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/overview-coremltools.html">What Is Core ML Tools?</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/new-features.html">New Features</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/faqs.html">Core ML Tools FAQs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/coremltools-examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/migration.html">Migration Workflow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../overview/contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Essentials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../essentials/installing-coremltools.html">Installing Core ML Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../essentials/introductory-quickstart.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../essentials/unified-conversion-api.html">Core ML Tools API Overview</a></li>
<li class="toctree-l1"><a class="reference external" href="https://apple.github.io/coremltools/mlmodel/index.html">Core ML Model Format</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apple/coremltools">API GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Unified Conversion</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../unified/convert-learning-models/convert-learning-models.html">Converting Deep Learning Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unified/ml-programs/ml-programs.html">ML Programs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unified/convert-tensorflow/convert-tensorflow.html">Converting from TensorFlow</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unified/convert-pytorch/convert-pytorch.html">Converting from PyTorch</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unified/conversion-options/conversion-options.html">Conversion Options</a></li>
<li class="toctree-l1"><a class="reference internal" href="../unified/model-intermediate-language.html">Model Intermediate Language</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Optimization</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="optimizing-models/optimizing-models.html">Optimizing Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-overview/api-overview.html">Optimize API Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="pruning/pruning.html">Pruning</a></li>
<li class="toctree-l1"><a class="reference internal" href="palettization/palettization.html">Palettization</a></li>
<li class="toctree-l1"><a class="reference internal" href="quantization-aware-training/quantization-aware-training.html">Linear 8-Bit Quantization</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Compressing Neural Network Weights</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#quantize-to-float-16-weights">Quantize to Float 16 Weights</a></li>
<li class="toctree-l2"><a class="reference internal" href="#quantize-to-1-8-bits">Quantize to 1-8 Bits</a></li>
<li class="toctree-l2"><a class="reference internal" href="#quantization-options">Quantization Options</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#custom-lut-function">Custom LUT Function</a></li>
<li class="toctree-l3"><a class="reference internal" href="#control-which-layers-are-quantized">Control Which Layers are Quantized</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Other Converters</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../other-converters/libsvm-conversion.html">LibSVM</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other-converters/sci-kit-learn-conversion.html">Scikit-learn</a></li>
<li class="toctree-l1"><a class="reference internal" href="../other-converters/xgboost-conversion.html">XGBoost</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">MLModel</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../mlmodel/mlmodel.html">MLModel Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mlmodel/xcode-model-preview-types.html">Xcode Model Preview Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mlmodel/mlmodel-utilities.html">MLModel Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mlmodel/model-prediction.html">Model Prediction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mlmodel/updatable-model-examples/updatable-model-examples.html">Updatable Models</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Core ML Tools Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Compressing Neural Network Weights</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/optimization/quantization-neural-network.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="compressing-neural-network-weights">
<h1>Compressing Neural Network Weights<a class="headerlink" href="#compressing-neural-network-weights" title="Permalink to this heading"></a></h1>
<div class="admonition-for-neural-network-format-only admonition">
<p class="admonition-title">For Neural Network Format Only</p>
<p>This page describes the API to compress the weights of a Core ML model that is of type <code class="docutils literal notranslate"><span class="pre">neuralnetwork</span></code>. For the   <span class="xref myst"><code class="docutils literal notranslate"><span class="pre">mlprogram</span></code></span> model type, see the <span class="xref myst">API Overview</span>.</p>
</div>
<p>The Core ML Tools package includes a utility to compress the weights of a Core ML neural network model. Weight compression reduces the space occupied by the model. However, the precision of the intermediate tensors and the compute precision of the ops are not altered.</p>
<p><em>Quantization</em> refers to the process of reducing the number of bits that represent a number. The lower the number of bits, more the chances of degrading the model accuracy. The loss in accuracy varies with the model.</p>
<p>By default, the Core ML Tools converter produces a model with weights in floating-point 32 bit (float 32) precision. The weights can be quantized to 16 bits, 8 bits, 7 bits, and so on down to 1 bit. The intermediate tensors are kept in float precision (float 32 or float 16 depending on <span class="xref myst">execution unit</span>), while the weights are dequantized at runtime to match the precision of the intermediate tensors. Quantizing from float 32 to float 16 provides up to 2x savings in storage and generally does not affect the model’s accuracy.</p>
<p>The <a class="reference external" href="https://apple.github.io/coremltools/source/coremltools.models.neural_network.html#coremltools.models.neural_network.quantization_utils.quantize_weights"><code class="docutils literal notranslate"><span class="pre">quantize_weights</span></code></a> function handles all quantization modes and options:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">coremltools.models.neural_network</span> <span class="kn">import</span> <span class="n">quantization_utils</span>

<span class="c1"># allowed values of nbits = 16, 8, 7, 6, ...., 1</span>
<span class="n">quantized_model</span> <span class="o">=</span> <span class="n">quantization_utils</span><span class="o">.</span><span class="n">quantize_weights</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">nbits</span><span class="p">)</span>
</pre></div>
</div>
<p>For a full list of supported arguments, see <a class="reference external" href="https://apple.github.io/coremltools/source/coremltools.models.neural_network.html#coremltools.models.neural_network.quantization_utils.quantize_weights"><code class="docutils literal notranslate"><span class="pre">quantize_weights</span></code></a> in the <a class="reference external" href="https://apple.github.io/coremltools/source/coremltools.models.html#neural-network">API Reference for models.neural.network</a>. The following examples demonstrate some of these arguments.</p>
<section id="quantize-to-float-16-weights">
<h2>Quantize to Float 16 Weights<a class="headerlink" href="#quantize-to-float-16-weights" title="Permalink to this heading"></a></h2>
<p>Quantizing to float 16, which reduces by half the model’s disk size, is the safest quantization option since it generally does not affect the model’s accuracy:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">coremltools</span> <span class="k">as</span> <span class="nn">ct</span>
<span class="kn">from</span> <span class="nn">coremltools.models.neural_network</span> <span class="kn">import</span> <span class="n">quantization_utils</span>

<span class="c1"># load full precision model</span>
<span class="n">model_fp32</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MLModel</span><span class="p">(</span><span class="s1">&#39;model.mlmodel&#39;</span><span class="p">)</span>

<span class="n">model_fp16</span> <span class="o">=</span> <span class="n">quantization_utils</span><span class="o">.</span><span class="n">quantize_weights</span><span class="p">(</span><span class="n">model_fp32</span><span class="p">,</span> <span class="n">nbits</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="quantize-to-1-8-bits">
<h2>Quantize to 1-8 Bits<a class="headerlink" href="#quantize-to-1-8-bits" title="Permalink to this heading"></a></h2>
<p>Quantizing to 8 bits reduces the disk size to one fourth of the float 32 model. However, it may affect model accuracy, so you should always test the model after quantization, using test data. Depending on the model type, you may be able to quantize to bits lower than 8 without losing accuracy.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># quantize to 8 bit using linear mode</span>
<span class="n">model_8bit</span> <span class="o">=</span> <span class="n">quantize_weights</span><span class="p">(</span><span class="n">model_fp32</span><span class="p">,</span> <span class="n">nbits</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="c1"># quantize to 8 bit using LUT kmeans mode</span>
<span class="n">model_8bit</span> <span class="o">=</span> <span class="n">quantize_weights</span><span class="p">(</span><span class="n">model_fp32</span><span class="p">,</span> <span class="n">nbits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                             <span class="n">quantization_mode</span><span class="o">=</span><span class="s2">&quot;kmeans&quot;</span><span class="p">)</span>

<span class="c1"># quantize to 8 bit using linearsymmetric mode</span>
<span class="n">model_8bit</span> <span class="o">=</span> <span class="n">quantize_weights</span><span class="p">(</span><span class="n">model_fp32</span><span class="p">,</span> <span class="n">nbits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                             <span class="n">quantization_mode</span><span class="o">=</span><span class="s2">&quot;linear_symmetric&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>When you set <code class="docutils literal notranslate"><span class="pre">nbits</span></code> to a value between 1 and 8, you can choose one of the following quantization modes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">linear</span></code>: The default mode, which uses linear quantization for weights with a scale and bias term.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">linear_symmetric</span></code>: Symmetric quantization, with only a scale term.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">kmeans_lut</span></code>: Uses a <a class="reference external" href="https://en.wikipedia.org/wiki/K-means_clustering">k-means clustering</a> algorithm to construct a <a class="reference external" href="https://en.wikipedia.org/wiki/Lookup_table">lookup table</a> (LUT) quantization of weights.</p></li>
</ul>
<p>Try these different algorithms with your model, as some may work better than  others depending on the model type.</p>
</section>
<section id="quantization-options">
<h2>Quantization Options<a class="headerlink" href="#quantization-options" title="Permalink to this heading"></a></h2>
<p>The following options enable you to experiment with the quantization scheme so that you can find one that works best with your model.</p>
<section id="custom-lut-function">
<h3>Custom LUT Function<a class="headerlink" href="#custom-lut-function" title="Permalink to this heading"></a></h3>
<p>By default, the k-means algorithm is used to find the lookup table (LUT). However, you can provide a custom function to compute the LUT by setting <code class="docutils literal notranslate"><span class="pre">quantization_mode</span> <span class="pre">=</span> <span class="pre">&quot;custom_lut</span> <span class="pre">&quot;</span></code>.</p>
</section>
<section id="control-which-layers-are-quantized">
<h3>Control Which Layers are Quantized<a class="headerlink" href="#control-which-layers-are-quantized" title="Permalink to this heading"></a></h3>
<p>By default, all the layers that have weight parameters are quantized. However, the model accuracy may be sensitive to certain layers, which shouldn’t be quantized. You can choose to skip quantization for certain layers and experiment as follows:</p>
<ul class="simple">
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">AdvancedQuantizedLayerSelector</span></code> class, which lets you set simple properties such as layer types and weight count. For example:</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example: 8-bit symmetric linear quantization skipping bias,</span>
<span class="c1"># batchnorm, depthwise-convolution, and convolution layers</span>
<span class="c1"># with less than 4 channels or 4096 elements</span>
<span class="kn">from</span> <span class="nn">coremltools.models.neural_network.quantization_utils</span> <span class="kn">import</span> <span class="n">AdvancedQuantizedLayerSelector</span>

<span class="n">selector</span> <span class="o">=</span> <span class="n">AdvancedQuantizedLayerSelector</span><span class="p">(</span>
    <span class="n">skip_layer_types</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;batchnorm&#39;</span><span class="p">,</span> <span class="s1">&#39;bias&#39;</span><span class="p">,</span> <span class="s1">&#39;depthwiseConv&#39;</span><span class="p">],</span>
    <span class="n">minimum_conv_kernel_channels</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
    <span class="n">minimum_conv_weight_count</span><span class="o">=</span><span class="mi">4096</span>
<span class="p">)</span>

<span class="n">quantized_model</span> <span class="o">=</span> <span class="n">quantize_weights</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> 
                                   <span class="n">nbits</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                                   <span class="n">quantization_mode</span><span class="o">=</span><span class="s1">&#39;linear_symmetric&#39;</span><span class="p">,</span>
                                   <span class="n">selector</span><span class="o">=</span><span class="n">selector</span><span class="p">)</span>
</pre></div>
</div>
<p>For a list of all the layer types in the Core ML neural network model, see the <a class="reference external" href="https://apple.github.io/coremltools/mlmodel/Format/NeuralNetwork.html#neuralnetworklayer"><code class="docutils literal notranslate"><span class="pre">NeuralNetworkLayer</span></code></a> section in the Core ML Format reference for <a class="reference external" href="https://apple.github.io/coremltools/mlmodel/Format/NeuralNetwork.html">NeuralNetwork</a>.</p>
<p>For finer control, you can write a custom rule to skip (or not skip) quantizing a layer by extending the <code class="docutils literal notranslate"><span class="pre">QuantizedLayerSelector</span></code> class:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example : 8-bit linear quantization skipping the layer with name &#39;dense_2&#39;</span>
<span class="kn">from</span> <span class="nn">coremltools.models.neural_network.quantization_utils</span> <span class="kn">import</span> <span class="n">QuantizedLayerSelector</span>


<span class="k">class</span> <span class="nc">MyLayerSelector</span><span class="p">(</span><span class="n">QuantizedLayerSelector</span><span class="p">):</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MyLayerSelector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">do_quantize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layer</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">MyLayerSelector</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">do_quantize</span><span class="p">(</span><span class="n">layer</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span> <span class="ow">or</span> <span class="n">layer</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;dense_2&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>


<span class="n">selector</span> <span class="o">=</span> <span class="n">MyLayerSelector</span><span class="p">()</span>
<span class="n">quantized_model</span> <span class="o">=</span> <span class="n">quantize_weights</span><span class="p">(</span>
  <span class="n">mlmodel</span><span class="p">,</span> 
  <span class="n">nbits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span> 
  <span class="n">quantization_mode</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span> 
  <span class="n">selector</span><span class="o">=</span><span class="n">selector</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="quantization-aware-training/data-dependent-quantization.html" class="btn btn-neutral float-left" title="Training-Time Quantization" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../other-converters/libsvm-conversion.html" class="btn btn-neutral float-right" title="LibSVM" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Apple Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>