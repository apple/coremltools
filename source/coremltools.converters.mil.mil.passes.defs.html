<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MIL Graph Passes &mdash; coremltools API Reference 8.3 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/norightmargin.css?v=eea1f72d" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=8cc1add8"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Optimizers" href="coremltools.optimize.html" />
    <link rel="prev" title="MIL Ops" href="coremltools.converters.mil.mil.ops.defs.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            coremltools API Reference
          </a>
              <div class="version">
                8.3
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="coremltools.converters.html">Converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="coremltools.models.html">Model APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="coremltools.converters.mil.html">MIL Builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="coremltools.converters.mil.input_types.html">MIL Input Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="coremltools.converters.mil.mil.ops.defs.html">MIL Ops</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">MIL Graph Passes</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.cleanup">cleanup</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.const_deduplication"><code class="docutils literal notranslate"><span class="pre">const_deduplication</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.const_elimination"><code class="docutils literal notranslate"><span class="pre">const_elimination</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.dead_code_elimination"><code class="docutils literal notranslate"><span class="pre">dead_code_elimination</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.dedup_op_and_var_names"><code class="docutils literal notranslate"><span class="pre">dedup_op_and_var_names</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.expand_dynamic_linear"><code class="docutils literal notranslate"><span class="pre">expand_dynamic_linear</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.fuse_reduce_mean"><code class="docutils literal notranslate"><span class="pre">fuse_reduce_mean</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.loop_invariant_elimination"><code class="docutils literal notranslate"><span class="pre">loop_invariant_elimination</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.noop_elimination"><code class="docutils literal notranslate"><span class="pre">noop_elimination</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.remove_redundant_ops"><code class="docutils literal notranslate"><span class="pre">remove_redundant_ops</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.remove_symbolic_reshape"><code class="docutils literal notranslate"><span class="pre">remove_symbolic_reshape</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.cleanup.topological_reorder"><code class="docutils literal notranslate"><span class="pre">topological_reorder</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_activation">optimize_activation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_gelu_exact"><code class="docutils literal notranslate"><span class="pre">fuse_gelu_exact</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_gelu_tanh_approximation"><code class="docutils literal notranslate"><span class="pre">fuse_gelu_tanh_approximation</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_leaky_relu"><code class="docutils literal notranslate"><span class="pre">fuse_leaky_relu</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_prelu"><code class="docutils literal notranslate"><span class="pre">fuse_prelu</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.prelu_to_lrelu"><code class="docutils literal notranslate"><span class="pre">prelu_to_lrelu</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_conv">optimize_conv</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.add_conv_transpose_output_shape"><code class="docutils literal notranslate"><span class="pre">add_conv_transpose_output_shape</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.compose_conv1d"><code class="docutils literal notranslate"><span class="pre">compose_conv1d</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_conv_batchnorm"><code class="docutils literal notranslate"><span class="pre">fuse_conv_batchnorm</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_conv_bias"><code class="docutils literal notranslate"><span class="pre">fuse_conv_bias</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_conv_scale"><code class="docutils literal notranslate"><span class="pre">fuse_conv_scale</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_pad_conv"><code class="docutils literal notranslate"><span class="pre">fuse_pad_conv</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary">optimize_elementwise_binary</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.divide_to_multiply"><code class="docutils literal notranslate"><span class="pre">divide_to_multiply</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.select_optimization"><code class="docutils literal notranslate"><span class="pre">select_optimization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.fuse_elementwise_to_batchnorm"><code class="docutils literal notranslate"><span class="pre">fuse_elementwise_to_batchnorm</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.rank0_expand_dims_swap"><code class="docutils literal notranslate"><span class="pre">rank0_expand_dims_swap</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_linear">optimize_linear</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_linear.fuse_linear_bias"><code class="docutils literal notranslate"><span class="pre">fuse_linear_bias</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_linear.fuse_matmul_weight_bias"><code class="docutils literal notranslate"><span class="pre">fuse_matmul_weight_bias</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_linear.fuse_transpose_matmul"><code class="docutils literal notranslate"><span class="pre">fuse_transpose_matmul</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_normalization">optimize_normalization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_normalization.fuse_layernorm_or_instancenorm"><code class="docutils literal notranslate"><span class="pre">fuse_layernorm_or_instancenorm</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_quantization">optimize_quantization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.merge_affine_dequantize_with_consecutive_ops"><code class="docutils literal notranslate"><span class="pre">merge_affine_dequantize_with_consecutive_ops</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.int_op_canonicalization"><code class="docutils literal notranslate"><span class="pre">int_op_canonicalization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.nullify_redundant_quantization_zero_point"><code class="docutils literal notranslate"><span class="pre">nullify_redundant_quantization_zero_point</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.dequantize_quantize_pair_elimination"><code class="docutils literal notranslate"><span class="pre">dequantize_quantize_pair_elimination</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.distributive_quantized_binary_op_scale_normalization"><code class="docutils literal notranslate"><span class="pre">distributive_quantized_binary_op_scale_normalization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.dequantize_to_constexpr"><code class="docutils literal notranslate"><span class="pre">dequantize_to_constexpr</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops">optimize_repeat_ops</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.cast_optimization"><code class="docutils literal notranslate"><span class="pre">cast_optimization</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_paddings"><code class="docutils literal notranslate"><span class="pre">merge_consecutive_paddings</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_relus"><code class="docutils literal notranslate"><span class="pre">merge_consecutive_relus</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_reshapes"><code class="docutils literal notranslate"><span class="pre">merge_consecutive_reshapes</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_transposes"><code class="docutils literal notranslate"><span class="pre">merge_consecutive_transposes</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.reduce_transposes"><code class="docutils literal notranslate"><span class="pre">reduce_transposes</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_state">optimize_state</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_state.canonicalize_inplace_pattern"><code class="docutils literal notranslate"><span class="pre">canonicalize_inplace_pattern</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_state.prefer_state_in_downstream"><code class="docutils literal notranslate"><span class="pre">prefer_state_in_downstream</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation">optimize_tensor_operation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.concat_to_pixel_shuffle"><code class="docutils literal notranslate"><span class="pre">concat_to_pixel_shuffle</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.detect_concat_interleave"><code class="docutils literal notranslate"><span class="pre">detect_concat_interleave</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.expand_high_rank_reshape_and_transpose"><code class="docutils literal notranslate"><span class="pre">expand_high_rank_reshape_and_transpose</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.fuse_onehot_matmul_to_gather"><code class="docutils literal notranslate"><span class="pre">fuse_onehot_matmul_to_gather</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.replace_stack_reshape"><code class="docutils literal notranslate"><span class="pre">replace_stack_reshape</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.use_reflection_padding"><code class="docutils literal notranslate"><span class="pre">use_reflection_padding</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.preprocess">preprocess</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.preprocess.image_input_preprocess"><code class="docutils literal notranslate"><span class="pre">image_input_preprocess</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.preprocess.sanitize_input_output_names"><code class="docutils literal notranslate"><span class="pre">sanitize_input_output_names</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.preprocess.update_output_dtypes"><code class="docutils literal notranslate"><span class="pre">update_output_dtypes</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.quantization">quantization</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.quantization.add_fp16_cast"><code class="docutils literal notranslate"><span class="pre">add_fp16_cast</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.symbol_transform">symbol_transform</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.symbol_transform.materialize_symbolic_shape_program"><code class="docutils literal notranslate"><span class="pre">materialize_symbolic_shape_program</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#module-coremltools.converters.mil.mil.passes.defs.transformer">transformer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#coremltools.converters.mil.mil.passes.defs.transformer.scaled_dot_product_attention_sliced_q"><code class="docutils literal notranslate"><span class="pre">scaled_dot_product_attention_sliced_q</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="coremltools.optimize.html">Optimizers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://apple.github.io/coremltools/docs-guides/index.html">Guide and Examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://apple.github.io/coremltools/mlmodel/index.html">Core ML Format Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-versions.html">Previous Versions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apple/coremltools">GitHub</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">coremltools API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">MIL Graph Passes</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/source/coremltools.converters.mil.mil.passes.defs.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="mil-graph-passes">
<h1>MIL Graph Passes<a class="headerlink" href="#mil-graph-passes" title="Link to this heading"></a></h1>
<p>Graph Passes supported by the Model Intermediate Language (MIL):</p>
<section id="module-coremltools.converters.mil.mil.passes.defs.cleanup">
<span id="cleanup"></span><h2>cleanup<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.cleanup" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.const_deduplication">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">const_deduplication</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/const_deduplication.html#const_deduplication"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.const_deduplication" title="Link to this definition"></a></dt>
<dd><p>Remove duplicated large constants (tensor with 100+ elements)</p>
<p>For example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span> <span class="p">(</span><span class="n">where</span> <span class="n">weight</span> <span class="ow">and</span> <span class="n">bias</span> <span class="n">are</span> <span class="n">large</span> <span class="n">constants</span><span class="p">):</span>
    <span class="n">weight_q</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
    <span class="n">weight_k</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
    <span class="n">bias_q</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">bias_k</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">q_embedding</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight_q</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias_q</span><span class="p">)</span>
    <span class="n">k_embedding</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight_k</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias_k</span><span class="p">)</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
    <span class="n">weight_q</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">weight</span><span class="p">)</span>
    <span class="n">bias_q</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">q_embedding</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">q</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight_q</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias_q</span><span class="p">)</span>
    <span class="n">k_embedding</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">k</span><span class="p">,</span> <span class="n">weight</span><span class="o">=</span><span class="n">weight_q</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="n">bias_q</span><span class="p">)</span>
</pre></div>
</div>
<p>Concretely, this graph pass consists of two stages:</p>
<ol class="arabic">
<li><p>Deduplication of <code class="docutils literal notranslate"><span class="pre">const</span></code> op:</p>
<p>We consider a <code class="docutils literal notranslate"><span class="pre">const</span></code> as duplicated if there exists such a previous <code class="docutils literal notranslate"><span class="pre">const</span></code> that has same dtype and value</p>
</li>
<li><p>Deduplication of <code class="docutils literal notranslate"><span class="pre">constexpr_*</span></code> op:</p>
<p>We consider a <code class="docutils literal notranslate"><span class="pre">constexpr_*</span></code> as duplicated if there exists such a previous <code class="docutils literal notranslate"><span class="pre">constexpr_*</span></code> that has the same <code class="docutils literal notranslate"><span class="pre">op_type</span></code> and input attributes.</p>
</li>
</ol>
<p>Support options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">const_threshold</span></code>: Skip deduplicating <code class="docutils literal notranslate"><span class="pre">const</span></code> ops that have smaller number of elements than a threshold. Defaults to <code class="docutils literal notranslate"><span class="pre">100</span></code>. i.e. the constants with <code class="docutils literal notranslate"><span class="pre">size</span> <span class="pre">&lt;</span> <span class="pre">100</span></code> will not be deduplicated.</p></li>
</ul>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.const_elimination">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">const_elimination</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/const_elimination.html#const_elimination"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.const_elimination" title="Link to this definition"></a></dt>
<dd><p>Replace non-<code class="docutils literal notranslate"><span class="pre">const</span></code> ops that have <code class="docutils literal notranslate"><span class="pre">const</span></code> Var. Outputs are replaced with the <code class="docutils literal notranslate"><span class="pre">const</span></code> op. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">non_const_op</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># %2 is const, %3 isn&#39;t const</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">other_op</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="o">%</span><span class="mi">3</span><span class="p">)</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="n">_</span><span class="p">,</span> <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">non_const_op</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>  <span class="c1"># _ is the ignored output</span>
    <span class="o">%</span><span class="mi">2</span><span class="n">_const</span> <span class="o">=</span> <span class="n">const</span><span class="p">()</span>         <span class="c1"># %2_const name is for illustration only</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">other_op</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="n">_const</span><span class="p">,</span> <span class="o">%</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
<p>Support options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">skip_const_by_size</span></code>: Skip folding <code class="docutils literal notranslate"><span class="pre">const</span></code> ops that have larger number of elements than a threshold.</p></li>
</ul>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.dead_code_elimination">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">dead_code_elimination</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/dead_code_elimination.html#dead_code_elimination"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.dead_code_elimination" title="Link to this definition"></a></dt>
<dd><p>Eliminate unused ops in program. Ops whose outputs do not contribute to final outputs will be
deleted.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Before dead_code_elimination pass.</span>
<span class="n">main</span><span class="p">(</span><span class="o">%</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">block0</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">%</span><span class="n">const_2</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span><span class="o">*</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
    <span class="o">%</span><span class="n">const_3</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span><span class="o">*</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
    <span class="o">%</span><span class="n">tx_0</span><span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)</span><span class="o">*</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">%</span><span class="n">ty_0</span><span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)</span><span class="o">*</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="o">%</span><span class="n">matmul_0</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=%</span><span class="n">const_2</span><span class="p">,</span> <span class="n">transpose_x</span><span class="o">=%</span><span class="n">tx_0</span><span class="p">,</span> <span class="n">transpose_y</span><span class="o">=%</span><span class="n">ty_0</span><span class="p">)</span>
    <span class="o">%</span><span class="n">linear_0</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="o">=%</span><span class="n">const_2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=%</span><span class="n">const_3</span><span class="p">)</span>
  <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">linear_0</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># After dead_code_elimination pass.</span>
<span class="n">main</span><span class="p">(</span><span class="o">%</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">block0</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">%</span><span class="n">const_2</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span><span class="o">*</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
    <span class="o">%</span><span class="n">const_3</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span><span class="o">*</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
    <span class="o">%</span><span class="n">linear_0</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">x</span><span class="p">,</span> <span class="n">weight</span><span class="o">=%</span><span class="n">const_2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=%</span><span class="n">const_3</span><span class="p">)</span>
  <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">linear_0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In the example above, <code class="docutils literal notranslate"><span class="pre">%matmul_0</span></code> is an op that is not used in the computation. This op and
its input ops (<code class="docutils literal notranslate"><span class="pre">%tx_0</span></code> and <code class="docutils literal notranslate"><span class="pre">%ty_0</span></code>) are eliminated in this pass.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.dedup_op_and_var_names">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">dedup_op_and_var_names</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/dedup_op_and_var_names.html#dedup_op_and_var_names"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.dedup_op_and_var_names" title="Link to this definition"></a></dt>
<dd><p>For each function, this pass renames ops and variables with the same name
as any preceding ops/variables across all scopes in the given function,
where the precedence is implementation-specific. Note that an op name and
variable names are tracked separately, so an op may have the same name as
a variable.</p>
<p>The pass preserves input and output name. Raises ValueError if we cannot
dedup without changing the input/output var names.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prog</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp16&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;castop&quot;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;castop&quot;</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;square_last&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">x</span>

<span class="c1"># Before dedup pass, the op names are [&quot;castop&quot;, &quot;castop&quot;, &quot;square_last&quot;].</span>
<span class="c1"># After dedup pass, the op names are [&quot;castop&quot;, &quot;castop_1&quot;, &quot;square_last&quot;].</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.expand_dynamic_linear">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">expand_dynamic_linear</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/expand_dynamic_linear.html#expand_dynamic_linear"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.expand_dynamic_linear" title="Link to this definition"></a></dt>
<dd><p>Translate to <code class="docutils literal notranslate"><span class="pre">linear</span></code> when the operand is a descendant of const, since such an operand
may be folded into const or fused into constexpr later by graph passes. In op translation,
we prefer <code class="docutils literal notranslate"><span class="pre">linear</span></code> whenever possible because it requires const or constexpr <code class="docutils literal notranslate"><span class="pre">weight</span></code> and <code class="docutils literal notranslate"><span class="pre">bias</span></code>.</p>
<p>If such const folding or constexpr fusion did not happen, this pass would clean up
the too-ambitious <code class="docutils literal notranslate"><span class="pre">linear</span></code> ops by replacing them with <code class="docutils literal notranslate"><span class="pre">matmul</span></code> ops.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.fuse_reduce_mean">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">fuse_reduce_mean</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/fuse_reduce_mean.html#fuse_reduce_mean"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.fuse_reduce_mean" title="Link to this definition"></a></dt>
<dd><p>Detect the <code class="docutils literal notranslate"><span class="pre">reduce_sum</span></code> —&gt; <code class="docutils literal notranslate"><span class="pre">mul/real_div</span></code> pattern than can be mapped to <code class="docutils literal notranslate"><span class="pre">reduce_mean</span></code>.
That is, the operation <code class="docutils literal notranslate"><span class="pre">reduce_sum/count</span> <span class="pre">==</span> <span class="pre">reduce_mean</span></code>.</p>
<p><cite>Input graph</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                            <span class="n">const</span> <span class="p">(</span><span class="n">scalar</span><span class="p">)</span>
                                <span class="o">|</span>
<span class="nb">input</span> <span class="o">----&gt;</span> <span class="n">reduce_sum</span> <span class="o">----&gt;</span> <span class="n">mul</span><span class="o">/</span><span class="n">real_div</span> <span class="o">-----------&gt;</span> <span class="n">output</span>
</pre></div>
</div>
<p><cite>Output graph</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">input</span> <span class="o">--------&gt;</span> <span class="n">reduce_mean</span> <span class="o">---------&gt;</span> <span class="n">output</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.loop_invariant_elimination">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">loop_invariant_elimination</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/loop_invariant_elimination.html#loop_invariant_elimination"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.loop_invariant_elimination" title="Link to this definition"></a></dt>
<dd><p>When a block does not modify a block input var, eliminate that block
input var and use the corresponding var in the outer scope. Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Before loop_invariant_elimination pass.</span>
<span class="c1"># Notice that ``%b.x`` is constant through while loop iterates.</span>
<span class="n">main</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">),</span>
     <span class="o">%</span><span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">block0</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">%</span><span class="n">loop</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">),</span> <span class="o">%</span><span class="n">loop</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span>            <span class="n">while_loop</span><span class="p">(</span><span class="n">loop_vars</span><span class="o">=</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="p">))</span>
      <span class="n">loop_cond</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">%</span><span class="n">cond_var</span><span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)</span> <span class="o">=</span> <span class="n">some_op</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=%</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
      <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">cond_var</span><span class="p">)</span>
      <span class="n">loop_body</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">%</span><span class="n">add_0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=%</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
      <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">add_0</span><span class="p">,</span> <span class="o">%</span><span class="n">b</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
  <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">loop</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="n">loop</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># After loop_invariant_elimination pass.</span>
<span class="n">main</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">),</span>
     <span class="o">%</span><span class="n">b</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">block0</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">%</span><span class="n">loop</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">identity</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">b</span><span class="p">)</span>
    <span class="o">%</span><span class="n">loop</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span>            <span class="n">while_loop</span><span class="p">(</span><span class="n">loop_vars</span><span class="o">=</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="p">))</span>
      <span class="n">loop_cond</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">%</span><span class="n">cond_var</span><span class="p">:</span> <span class="p">(</span><span class="nb">bool</span><span class="p">)</span> <span class="o">=</span> <span class="n">some_op</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=%</span><span class="n">b</span><span class="p">)</span>
      <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">cond_var</span><span class="p">)</span>
      <span class="n">loop_body</span><span class="p">(</span><span class="o">%</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="p">{</span>
        <span class="o">%</span><span class="n">add_0</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">a</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=%</span><span class="n">b</span><span class="p">)</span>
      <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">add_0</span><span class="p">)</span>
  <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">loop</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="n">loop</span><span class="p">:</span><span class="mi">1</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>where we eliminate loop invariant <code class="docutils literal notranslate"><span class="pre">%b.x</span></code> from <code class="docutils literal notranslate"><span class="pre">while_loop</span></code>, which returns 1
instead of 2 outputs. We also preserve the return var names with identity.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.noop_elimination">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">noop_elimination</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/noop_elimination.html#noop_elimination"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.noop_elimination" title="Link to this definition"></a></dt>
<dd><p>Remove ops that have no effect.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">1</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>
    <span class="o">%</span><span class="mi">2</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="o">%</span><span class="mi">3</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="o">...</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">1</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="o">...</span>
    <span class="o">%</span><span class="mi">3</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.remove_redundant_ops">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">remove_redundant_ops</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/remove_redundant_ops.html#remove_redundant_ops"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.remove_redundant_ops" title="Link to this definition"></a></dt>
<dd><p>If there are multiple ops with “identical” inputs, then they are redundant and all but one of them can be removed.
This pass checks and removes such ops.</p>
<p>Since all inputs to ops in MIL are named, two ops with same <code class="docutils literal notranslate"><span class="pre">op_types</span></code> can be compared by comparing their
correspondingly named inputs. Inputs are treated as identical if one of the following is true:</p>
<ul class="simple">
<li><p>The input is a constant var, in which case its value should have the same dtype and numerical value.</p></li>
<li><p>The input is a non constant var, in which case it should be the same var object.</p></li>
</ul>
<p>This pass iterates over the ops, takes its first output var, and then builds a candidate op list from the child
ops of this var.
This candidate ops list contains ops of the same <code class="docutils literal notranslate"><span class="pre">op_type</span></code>, arranged in topological order.
From each of these candidate ops in the list, the second, third, and subsequent ops are pairwise compared with the first op,
and if identical to it, they are removed. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="n">op0</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">op1</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mf">4.5</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mf">4.5</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">op2</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">op3</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="mi">3</span><span class="p">)</span>

<span class="n">Output</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">0</span> <span class="o">=</span> <span class="n">op0</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">op1</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mf">4.5</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="mf">4.5</span><span class="p">)</span> <span class="c1"># this will get removed later by dead code elimination pass</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">op2</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">0</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p>In the example above, <code class="docutils literal notranslate"><span class="pre">op3</span></code> is removed and all uses of <code class="docutils literal notranslate"><span class="pre">%5</span></code> is replaced by <code class="docutils literal notranslate"><span class="pre">%4</span></code>.
For more examples, see “TestRemoveRedundantOpsPass”.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.remove_symbolic_reshape">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">remove_symbolic_reshape</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/remove_symbolic_reshape.html#remove_symbolic_reshape"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.remove_symbolic_reshape" title="Link to this definition"></a></dt>
<dd><p>Convert symbolic shape in <code class="docutils literal notranslate"><span class="pre">reshape</span></code> to integers.</p>
<p>Note: This does not perform any optimization, but simply
replaces symbols with positive integers if solved from volumetric
constraint, or -1. Therefore, this pass fails if more than one symbol
needs to be resolved to -1.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Before remove_symbolic_reshape pass.</span>
<span class="n">main</span><span class="p">(</span><span class="o">%</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">block0</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">%</span><span class="n">reshape_0_shape_0</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">i32</span><span class="p">)</span><span class="o">^</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="o">%</span><span class="n">reshape_0</span><span class="p">:</span> <span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=%</span><span class="n">reshape_0_shape_0</span><span class="p">)</span>
  <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">reshape_0</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1"># After remove_symbolic_reshape pass.</span>
<span class="n">main</span><span class="p">(</span><span class="o">%</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">s0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">block0</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">%</span><span class="n">reshape_0_shape_0x</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">i32</span><span class="p">)</span><span class="o">*</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
    <span class="o">%</span><span class="n">reshape_0</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=%</span><span class="n">reshape_0_shape_0x</span><span class="p">)</span>
  <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">reshape_0</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>TODO (<a class="reference external" href="rdar://59165842">rdar://59165842</a>): Use expand_dims, squeeze etc to use 0 instead of dynamic reshape with -1.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.cleanup.topological_reorder">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.cleanup.</span></span><span class="sig-name descname"><span class="pre">topological_reorder</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/cleanup/topological_reorder.html#topological_reorder"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.cleanup.topological_reorder" title="Link to this definition"></a></dt>
<dd><p>Topologically re-orders the list of operations in a program by places each operation closer to its
first use, or at the end if it’s not consumed by any other operation.</p>
<p>Currently, This pass re-orders only Transpose and Cast operations.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example: input program</span>
<span class="n">main</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp16&quot;</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x1_t</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1_t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span>
    <span class="n">x3</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x3_t</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x3</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x3_t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span>
    <span class="n">x5</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x6</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span>
    <span class="n">x7</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x6</span><span class="p">)</span>
    <span class="n">x8</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
<span class="p">}</span> <span class="o">-&gt;</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="n">x8</span>

<span class="c1"># After moving `cast` ops becomes</span>
<span class="n">main</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp16&quot;</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x1_t</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">x3</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x3_t</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x3</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">x5</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x6</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span>
    <span class="n">x7</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x6</span><span class="p">)</span>
    <span class="n">x8</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x3_t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1_t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span>
<span class="p">}</span> <span class="o">-&gt;</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="n">x8</span>

<span class="c1"># After moving `transpose` ops becomes</span>
<span class="n">main</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">fp32</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp16&quot;</span><span class="p">)</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x3</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x5</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x6</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x5</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span>
    <span class="n">x7</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x6</span><span class="p">)</span>
    <span class="n">x8</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">relu</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
    <span class="n">x3_t</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x3</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">x4</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x3_t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span>
    <span class="n">x1_t</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">mb</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x1_t</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span>
<span class="p">}</span> <span class="o">-&gt;</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x4</span><span class="p">,</span> <span class="n">x7</span><span class="p">,</span> <span class="n">x8</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.optimize_activation">
<span id="optimize-activation"></span><h2>optimize_activation<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_activation" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_gelu_exact">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_activation.</span></span><span class="sig-name descname"><span class="pre">fuse_gelu_exact</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_activation.html#fuse_gelu_exact"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_gelu_exact" title="Link to this definition"></a></dt>
<dd><p>Identify the pattern that corresponds to the exact version of <code class="docutils literal notranslate"><span class="pre">gelu</span></code>, and replace it with a single
<code class="docutils literal notranslate"><span class="pre">gelu</span></code> layer with <code class="docutils literal notranslate"><span class="pre">mode=EXACT</span></code>. The pattern is <code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">0.5</span> <span class="pre">*</span> <span class="pre">x</span> <span class="pre">*</span> <span class="pre">(1</span> <span class="pre">+</span> <span class="pre">erf</span> <span class="pre">(x</span> <span class="pre">/</span> <span class="pre">srqt</span> <span class="pre">(2))</span></code>, which
can be represented by one of the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">----&gt;</span> <span class="n">div</span> <span class="p">(</span><span class="mf">1.414</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="n">erf</span> <span class="o">---&gt;</span> <span class="n">add</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">mul</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="n">mul</span> <span class="o">---&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
      <span class="o">|</span>                                                                  <span class="o">^</span>
      <span class="o">|</span>                                                                  <span class="o">|</span>
      <span class="o">|-------------------------------------------------------------------</span>

<span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">----&gt;</span> <span class="n">div</span> <span class="p">(</span><span class="mf">1.414</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="n">erf</span> <span class="o">---&gt;</span> <span class="n">add</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">mul</span> <span class="o">---&gt;</span> <span class="n">mul</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
      <span class="o">|</span>                                                   <span class="o">^</span>
      <span class="o">|</span>                                                   <span class="o">|</span>
      <span class="o">|----------------------------------------------------</span>

<span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">----&gt;</span> <span class="n">div</span> <span class="p">(</span><span class="mf">1.414</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="n">erf</span> <span class="o">---&gt;</span> <span class="n">add</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">mul</span> <span class="o">------&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
      <span class="o">|</span>                                                   <span class="o">^</span>
      <span class="o">|</span>                                                   <span class="o">|</span>
      <span class="o">|---------------&gt;</span> <span class="n">mul</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">--------------------------</span>

<span class="n">All</span> <span class="n">of</span> <span class="n">them</span> <span class="n">are</span> <span class="n">converted</span> <span class="n">to</span><span class="p">:</span>
    <span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">----&gt;</span> <span class="n">gelu</span> <span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">EXACT</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_gelu_tanh_approximation">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_activation.</span></span><span class="sig-name descname"><span class="pre">fuse_gelu_tanh_approximation</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_activation.html#fuse_gelu_tanh_approximation"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_gelu_tanh_approximation" title="Link to this definition"></a></dt>
<dd><p>Identify the pattern that corresponds to the <code class="docutils literal notranslate"><span class="pre">tanh</span></code> approximate version of <code class="docutils literal notranslate"><span class="pre">gelu</span></code>, and replace it
with a single <code class="docutils literal notranslate"><span class="pre">gelu</span></code> layer with <code class="docutils literal notranslate"><span class="pre">mode=TANH_APPROXIMATION</span></code>.</p>
<p>The implementation of this pass uses the generic graph pattern matching and transform algorithm
implemented in <code class="docutils literal notranslate"><span class="pre">coremltools.converters.mil.experimental.passes.generic_pass_infrastructure</span></code> and
documented in <code class="docutils literal notranslate"><span class="pre">coremltools/converters/mil/experimental/passes/readme.md</span></code>.</p>
<p><cite>Graph for</cite> <code class="docutils literal notranslate"><span class="pre">get_gelu_pattern1()</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">x</span> <span class="pre">*</span> <span class="pre">(0.5</span> <span class="pre">*</span> <span class="pre">(tanh(((.0447)x^3</span> <span class="pre">+</span> <span class="pre">x</span> <span class="pre">)</span> <span class="pre">*</span> <span class="pre">sqrt(2/pi))</span> <span class="pre">+</span> <span class="pre">1))</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">-----&gt;</span> <span class="nb">pow</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">----&gt;</span> <span class="n">mul</span> <span class="p">(</span><span class="mf">.044715</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="n">add</span> <span class="o">-----&gt;</span> <span class="n">mul</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">pi</span><span class="p">))</span> <span class="o">---&gt;</span> <span class="n">tanh</span> <span class="o">----&gt;</span> <span class="n">add</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">----&gt;</span> <span class="n">mul</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">mul</span> <span class="o">---&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
  <span class="o">|</span>                                            <span class="o">^</span>                                                                          <span class="o">^</span>
  <span class="o">|</span>                                            <span class="o">|</span>                                                                          <span class="o">|</span>
  <span class="o">|------------------------------------------------------------------------------------------------------------------------</span>
</pre></div>
</div>
<p><cite>Graph for</cite> <code class="docutils literal notranslate"><span class="pre">get_gelu_pattern2()</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">(0.5</span> <span class="pre">*</span> <span class="pre">x)</span> <span class="pre">*</span> <span class="pre">(tanh(((.0447)x^3</span> <span class="pre">+</span> <span class="pre">x</span> <span class="pre">)</span> <span class="pre">*</span> <span class="pre">sqrt(2/pi))</span> <span class="pre">+</span> <span class="pre">1)</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               <span class="o">--------------------------------------------------------------------------------------------------------</span>
               <span class="o">^</span>                                                                                                      <span class="o">|</span>
               <span class="o">|</span>                                                                                                      <span class="n">V</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">-----&gt;</span> <span class="n">mul</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>    <span class="nb">pow</span> <span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">----&gt;</span> <span class="n">mul</span> <span class="p">(</span><span class="mf">.044715</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="n">add</span> <span class="o">-----&gt;</span> <span class="n">mul</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="o">/</span><span class="n">pi</span><span class="p">))</span> <span class="o">---&gt;</span> <span class="n">tanh</span> <span class="o">----&gt;</span> <span class="n">add</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">mul</span> <span class="o">---&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
  <span class="o">|</span>                        <span class="o">^</span>                               <span class="o">^</span>
  <span class="o">|</span>                        <span class="o">|</span>                               <span class="o">|</span>
  <span class="o">|---------------------------------------------------------</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_leaky_relu">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_activation.</span></span><span class="sig-name descname"><span class="pre">fuse_leaky_relu</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_activation.html#fuse_leaky_relu"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_leaky_relu" title="Link to this definition"></a></dt>
<dd><p>Detect the <code class="docutils literal notranslate"><span class="pre">mul</span></code> —&gt; <code class="docutils literal notranslate"><span class="pre">max</span></code> pattern than can be mapped to <code class="docutils literal notranslate"><span class="pre">leaky_relu</span></code>.</p>
<p><cite>In code form - Input</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">)</span> <span class="c1"># where 0 &lt;= alpha &lt;= 1</span>
<span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># alpha * x</span>
<span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="o">%</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># max(alpha * x, x)</span>
</pre></div>
</div>
<p><cite>In code form - Output</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">leaky_relu</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=%</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
<p><cite>In graphical form - Input graph</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>         <span class="n">const</span> <span class="p">(</span><span class="n">val</span> <span class="o">=</span> <span class="n">alpha</span><span class="p">)</span>
             <span class="o">|</span>
<span class="nb">input</span> <span class="o">----&gt;</span> <span class="n">mul</span> <span class="o">---------------&gt;</span> <span class="n">maximum</span> <span class="o">-----------&gt;</span> <span class="n">output</span>
  <span class="o">|</span>                                 <span class="o">|</span>
  <span class="o">|----------------------------------</span>
</pre></div>
</div>
<p><cite>In graphical form - Output graph</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nb">input</span> <span class="o">--------&gt;</span> <span class="n">leaky_relu</span> <span class="o">---------&gt;</span> <span class="n">output</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_prelu">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_activation.</span></span><span class="sig-name descname"><span class="pre">fuse_prelu</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_activation.html#fuse_prelu"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.fuse_prelu" title="Link to this definition"></a></dt>
<dd><p>Detect the following patterns that can be mapped to a <code class="docutils literal notranslate"><span class="pre">prelu</span></code> op.
Essentially, the <code class="docutils literal notranslate"><span class="pre">prelu</span></code> op can be broken down into the following ops:</p>
<p><code class="docutils literal notranslate"><span class="pre">y</span> <span class="pre">=</span> <span class="pre">a</span> <span class="pre">*</span> <span class="pre">relu(-1</span> <span class="pre">*</span> <span class="pre">x)</span> <span class="pre">+</span> <span class="pre">relu(x)</span></code></p>
<p><cite>Pattern 1</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>               <span class="o">|</span> <span class="o">------------&gt;</span> <span class="n">relu</span> <span class="o">--------------------|</span>
               <span class="o">|</span>                                        <span class="n">V</span>
<span class="n">x</span> <span class="p">(</span><span class="n">BCHW</span><span class="p">)</span> <span class="o">------|</span>                                       <span class="n">add</span> <span class="o">-----&gt;</span> <span class="n">y</span> <span class="p">(</span><span class="n">BCHW</span><span class="p">)</span>
               <span class="o">|</span>                                        <span class="o">^</span>
               <span class="o">--------&gt;</span> <span class="n">mul</span> <span class="o">-------&gt;</span> <span class="n">relu</span> <span class="o">-----&gt;</span> <span class="n">mul</span><span class="o">---|</span>
                          <span class="o">^</span>                        <span class="o">^</span>
                          <span class="o">|</span>                        <span class="o">|</span>
                     <span class="n">Const</span><span class="p">(</span><span class="n">val</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>            <span class="n">Const</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">C</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>This will be mapped to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="p">(</span><span class="n">BCHW</span><span class="p">)</span> <span class="o">------&gt;</span> <span class="n">prelu</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,))</span> <span class="o">---------&gt;</span> <span class="n">y</span> <span class="p">(</span><span class="n">BCHW</span><span class="p">)</span>
</pre></div>
</div>
<p><cite>Pattern 2</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                                <span class="o">|</span> <span class="o">------------&gt;</span> <span class="n">relu</span> <span class="o">--------------------|</span>
                                <span class="o">|</span>                                        <span class="n">V</span>
<span class="n">x</span> <span class="p">(</span><span class="n">BCHW</span><span class="p">)</span> <span class="o">--&gt;</span><span class="n">transpose</span><span class="p">(</span><span class="n">BHWC</span><span class="p">)</span><span class="o">----&gt;|</span>                                       <span class="n">add</span> <span class="o">-----&gt;</span> <span class="n">y</span> <span class="p">(</span><span class="n">BHWC</span><span class="p">)</span>
                                <span class="o">|</span>                                        <span class="o">^</span>
                                <span class="o">--------&gt;</span> <span class="n">mul</span> <span class="o">-------&gt;</span> <span class="n">relu</span> <span class="o">-----&gt;</span> <span class="n">mul</span><span class="o">---|</span>
                                           <span class="o">^</span>                        <span class="o">^</span>
                                           <span class="o">|</span>                        <span class="o">|</span>
                                  <span class="n">Const</span><span class="p">(</span><span class="n">val</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>    <span class="n">Const</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">C</span><span class="p">,)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">C</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">C</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">C</span><span class="p">))</span>
</pre></div>
</div>
<p>This will be mapped to:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">x</span> <span class="p">(</span><span class="n">BCHW</span><span class="p">)</span> <span class="o">------&gt;</span> <span class="n">prelu</span> <span class="o">---------&gt;</span> <span class="n">transpose</span> <span class="o">------&gt;</span> <span class="n">y</span> <span class="p">(</span><span class="n">BHWC</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_activation.prelu_to_lrelu">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_activation.</span></span><span class="sig-name descname"><span class="pre">prelu_to_lrelu</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_activation.html#prelu_to_lrelu"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_activation.prelu_to_lrelu" title="Link to this definition"></a></dt>
<dd><p>If <code class="docutils literal notranslate"><span class="pre">prelu</span></code> has the same leakage factor across all channels, it will be converted to <code class="docutils literal notranslate"><span class="pre">leaky_relu</span></code>.</p>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.optimize_conv">
<span id="optimize-conv"></span><h2>optimize_conv<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_conv" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_conv.add_conv_transpose_output_shape">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_conv.</span></span><span class="sig-name descname"><span class="pre">add_conv_transpose_output_shape</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_conv.html#add_conv_transpose_output_shape"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.add_conv_transpose_output_shape" title="Link to this definition"></a></dt>
<dd><p>The <code class="docutils literal notranslate"><span class="pre">conv_transpose</span></code> input <code class="docutils literal notranslate"><span class="pre">output_shape</span></code> is an optional input.
Since we can infer the output shape from <code class="docutils literal notranslate"><span class="pre">type_inference</span></code>, we add
<code class="docutils literal notranslate"><span class="pre">output_shape</span></code> input whenever it is known to be constant at
compile time. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
  <span class="o">%</span><span class="mi">1</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">conv_transpose</span><span class="p">(</span><span class="o">...</span><span class="p">)</span> <span class="c1"># no output_shape input.</span>

<span class="n">Result</span><span class="p">:</span>
  <span class="o">%</span><span class="mi">2</span><span class="p">:</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">i32</span><span class="p">)</span> <span class="o">=</span> <span class="n">const</span><span class="p">(</span><span class="n">val</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">39</span><span class="p">])</span>
  <span class="o">%</span><span class="mi">3</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="n">fp32</span><span class="p">)</span> <span class="o">=</span> <span class="n">conv_transpose</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">output_shape</span><span class="o">=%</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_conv.compose_conv1d">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_conv.</span></span><span class="sig-name descname"><span class="pre">compose_conv1d</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_conv.html#compose_conv1d"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.compose_conv1d" title="Link to this definition"></a></dt>
<dd><p>In <a class="reference external" href="https://github.com/tensorflow/tensorflow/blob/r1.15/tensorflow/python/ops/nn_ops.py#L1657">TensorFlow</a>,
<code class="docutils literal notranslate"><span class="pre">tf.keras.layers.Conv1D</span></code> is a composite op:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">expand</span> <span class="n">a</span> <span class="n">dummy</span> <span class="n">dim</span> <span class="o">-&gt;</span> <span class="n">Conv2D</span> <span class="o">-&gt;</span> <span class="n">squeeze</span> <span class="n">the</span> <span class="n">dummy</span> <span class="n">dim</span>
</pre></div>
</div>
<p>In <a class="reference external" href="https://github.com/pytorch/pytorch/blob/release/1.13/aten/src/ATen/native/Convolution.cpp#L1087">PyTorch</a>,
this is also true for some backends (<code class="docutils literal notranslate"><span class="pre">mkldnn</span></code> and <code class="docutils literal notranslate"><span class="pre">xpu</span></code>).</p>
<p>This decomposition wrecks the coremltools <code class="docutils literal notranslate"><span class="pre">conv1d</span></code> graph passes,
so we should recompose the fragments back to MIL <code class="docutils literal notranslate"><span class="pre">conv</span></code>, which natively supports <code class="docutils literal notranslate"><span class="pre">conv1d</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pattern</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">Given</span><span class="p">:</span>
        <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">expand_dims</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">expand_dims</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="o">%</span><span class="mf">1.</span><span class="n">rank</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
        <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="n">axes</span><span class="o">=-</span><span class="mi">2</span><span class="p">)</span> <span class="ow">or</span> <span class="n">squeeze</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="o">...</span>

    <span class="n">Result</span><span class="p">:</span>
        <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">...</span>

<span class="n">Pattern</span> <span class="mi">2</span> <span class="p">(</span><span class="n">TensorFlow</span> <span class="n">channel_last</span><span class="p">):</span>
    <span class="n">Given</span><span class="p">:</span>
        <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">expand_dims</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="n">expand_dims</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="o">%</span><span class="mf">1.</span><span class="n">rank</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span>
        <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">squeeze</span><span class="p">(</span><span class="o">%</span><span class="mi">5</span><span class="p">,</span> <span class="n">axes</span><span class="o">=-</span><span class="mi">3</span><span class="p">)</span> <span class="ow">or</span> <span class="n">squeeze</span><span class="p">(</span><span class="o">%</span><span class="mi">5</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="o">...</span>

    <span class="n">Result</span><span class="p">:</span>
        <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span>
        <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="o">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_conv_batchnorm">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_conv.</span></span><span class="sig-name descname"><span class="pre">fuse_conv_batchnorm</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_conv.html#fuse_conv_batchnorm"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_conv_batchnorm" title="Link to this definition"></a></dt>
<dd><p>Fuse the following <code class="docutils literal notranslate"><span class="pre">batch_norm</span></code> layer into <code class="docutils literal notranslate"><span class="pre">conv</span></code> and <code class="docutils literal notranslate"><span class="pre">conv_transpose</span></code>.
That is, convert <code class="docutils literal notranslate"><span class="pre">conv</span> <span class="pre">+</span> <span class="pre">batch_norm</span></code> to <code class="docutils literal notranslate"><span class="pre">conv</span></code>, by modifying the weight and bias in the <code class="docutils literal notranslate"><span class="pre">conv</span></code> layer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">batch_norm</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">...</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_conv_bias">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_conv.</span></span><span class="sig-name descname"><span class="pre">fuse_conv_bias</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_conv.html#fuse_conv_bias"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_conv_bias" title="Link to this definition"></a></dt>
<dd><p>Fold <code class="docutils literal notranslate"><span class="pre">add</span></code>/<code class="docutils literal notranslate"><span class="pre">sub</span></code> into <code class="docutils literal notranslate"><span class="pre">bias</span></code> of <code class="docutils literal notranslate"><span class="pre">conv</span></code> and <code class="docutils literal notranslate"><span class="pre">conv_transpose</span></code>.
That is, convert <code class="docutils literal notranslate"><span class="pre">conv</span> <span class="pre">+</span> <span class="pre">add/sub</span></code> to <code class="docutils literal notranslate"><span class="pre">conv</span></code>, when <code class="docutils literal notranslate"><span class="pre">add</span></code>/<code class="docutils literal notranslate"><span class="pre">sub</span></code> is adding a constant.</p>
<p>Two patterns are supported:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Pattern</span> <span class="mi">1</span><span class="p">:</span>
<span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span> <span class="c1"># where constant has shape (1,C,1)/(C,1) for 1d conv, (1,C,1,1)/(C,1,1) for 2d conv etc</span>
    <span class="o">...</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>

<span class="n">Pattern</span> <span class="mi">2</span><span class="p">:</span>
<span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span> <span class="c1"># where constant has a broacasable shape</span>
    <span class="o">...</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_conv_scale">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_conv.</span></span><span class="sig-name descname"><span class="pre">fuse_conv_scale</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_conv.html#fuse_conv_scale"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_conv_scale" title="Link to this definition"></a></dt>
<dd><p>Fold <code class="docutils literal notranslate"><span class="pre">mul</span></code>/<code class="docutils literal notranslate"><span class="pre">div</span></code> into <code class="docutils literal notranslate"><span class="pre">conv</span></code>/<code class="docutils literal notranslate"><span class="pre">conv_transpose</span></code> by updating the weight/bias of the convolution layers.</p>
<p>The scale <code class="docutils literal notranslate"><span class="pre">const</span></code> can be a single number (scalar) or a vector with a broadcastable shape.
For example, if the output of the <code class="docutils literal notranslate"><span class="pre">conv</span></code>/<code class="docutils literal notranslate"><span class="pre">deconv</span></code> layer is <code class="docutils literal notranslate"><span class="pre">(B,</span> <span class="pre">Cout,</span> <span class="pre">H,</span> <span class="pre">W)</span></code>,
<code class="docutils literal notranslate"><span class="pre">const</span></code> of shape <code class="docutils literal notranslate"><span class="pre">(Cout,</span> <span class="pre">1,</span> <span class="pre">1)</span></code> and <code class="docutils literal notranslate"><span class="pre">(1,</span> <span class="pre">Cout,</span> <span class="pre">1,</span> <span class="pre">1)</span></code> are allowed.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span> <span class="c1"># where constant is the scale constant</span>
    <span class="o">...</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">conv</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_pad_conv">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_conv.</span></span><span class="sig-name descname"><span class="pre">fuse_pad_conv</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_conv.html#fuse_pad_conv"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_conv.fuse_pad_conv" title="Link to this definition"></a></dt>
<dd><p>When we observe <code class="docutils literal notranslate"><span class="pre">pad</span> <span class="pre">-&gt;</span> <span class="pre">transpose</span> <span class="pre">-&gt;</span> <span class="pre">conv</span></code>, we move the <code class="docutils literal notranslate"><span class="pre">pad</span></code> to be next to <code class="docutils literal notranslate"><span class="pre">conv</span></code>.
This allows us to meld <code class="docutils literal notranslate"><span class="pre">pad</span> <span class="pre">+</span> <span class="pre">conv</span></code> if possible.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Given:
    %1 = pad(%0, ...)
    %2 = transpose(%1, ...)
    %3 = conv(%2, ...)
    ...

Result:
    %1.a = transpose(%0, ...)
    $2.a = pad(%1.a, ...)
    %3 = conv(%2.a)
    ...
</pre></div>
</div>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary">
<span id="optimize-elementwise-binary"></span><h2>optimize_elementwise_binary<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.divide_to_multiply">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.</span></span><span class="sig-name descname"><span class="pre">divide_to_multiply</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_elementwise_binary.html#divide_to_multiply"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.divide_to_multiply" title="Link to this definition"></a></dt>
<dd><p>Convert divide into multiply if the divisor is <code class="docutils literal notranslate"><span class="pre">const</span></code>.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.select_optimization">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.</span></span><span class="sig-name descname"><span class="pre">select_optimization</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_elementwise_binary.html#select_optimization"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.select_optimization" title="Link to this definition"></a></dt>
<dd><p>For <code class="docutils literal notranslate"><span class="pre">select(cond,</span> <span class="pre">a,</span> <span class="pre">b)</span></code>, there are 2 cases where we can replace it with a single simpler op</p>
<ol class="arabic">
<li><p>If <code class="docutils literal notranslate"><span class="pre">cond</span></code> is a const scalar (or a const tensor but all elements are the same, which is
equivalent to a scalar), then we replace <code class="docutils literal notranslate"><span class="pre">select(cond,</span> <span class="pre">a,</span> <span class="pre">b)</span></code> with simply <code class="docutils literal notranslate"><span class="pre">a</span></code> or <code class="docutils literal notranslate"><span class="pre">b</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>

    <span class="n">const</span><span class="p">(</span><span class="n">scalar</span> <span class="n">cond</span><span class="p">)</span> <span class="o">-|</span>
                        <span class="o">|</span>
    <span class="n">a</span> <span class="o">------------------|-&gt;</span> <span class="n">select</span> <span class="o">-&gt;</span> <span class="n">output</span>
                        <span class="o">|</span>
    <span class="n">b</span> <span class="o">------------------|</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>

    <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
        <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">output</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">output</span>
</pre></div>
</div>
</li>
<li><p>If <code class="docutils literal notranslate"><span class="pre">cond</span></code> is a more complicated const, and <code class="docutils literal notranslate"><span class="pre">a</span></code> is an inf const,
then we replace <code class="docutils literal notranslate"><span class="pre">a</span></code> with <code class="docutils literal notranslate"><span class="pre">select(cond,</span> <span class="pre">a,</span> <span class="pre">0)</span></code>, then return <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">+</span> <span class="pre">b</span></code></p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Input graph:

    const(cond) -|
                 |
    const(±inf) -|-&gt; select -&gt; output
                 |
    b -----------|

Output graph:

    select(cond, ±inf, 0) -|
                           |-&gt; add -&gt; output
    b ---------------------|
</pre></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">select(cond,</span> <span class="pre">±inf,</span> <span class="pre">0))</span></code> will further get eliminated by
<code class="docutils literal notranslate"><span class="pre">const_elimination</span></code>, so in the end the op in graph is simply <code class="docutils literal notranslate"><span class="pre">add</span></code></p>
<p>This replacement is based on floating-point arithmetic</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inf</span> <span class="o">+</span> <span class="n">b</span> <span class="o">=</span> <span class="n">inf</span>
<span class="o">-</span><span class="n">inf</span> <span class="o">+</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">inf</span>
<span class="mi">0</span> <span class="o">+</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span>
</pre></div>
</div>
<p>PS: if <code class="docutils literal notranslate"><span class="pre">a</span></code> is not inf const but <code class="docutils literal notranslate"><span class="pre">b</span></code> is, then we would swap <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code></p>
</div></blockquote>
</li>
</ol>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.fuse_elementwise_to_batchnorm">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.</span></span><span class="sig-name descname"><span class="pre">fuse_elementwise_to_batchnorm</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_elementwise_binary.html#fuse_elementwise_to_batchnorm"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.fuse_elementwise_to_batchnorm" title="Link to this definition"></a></dt>
<dd><p>Fold <code class="docutils literal notranslate"><span class="pre">mul</span></code> + <code class="docutils literal notranslate"><span class="pre">add</span></code> into a <code class="docutils literal notranslate"><span class="pre">batchnorm</span></code>
if the <code class="docutils literal notranslate"><span class="pre">const</span></code> feeding into the <code class="docutils literal notranslate"><span class="pre">mul</span></code>/<code class="docutils literal notranslate"><span class="pre">add</span></code> is of shape <code class="docutils literal notranslate"><span class="pre">(1,C,1,1)</span></code> or <code class="docutils literal notranslate"><span class="pre">(C,1,1)</span></code>
and input to <code class="docutils literal notranslate"><span class="pre">mul</span></code> is of rank 4.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
         <span class="p">[</span><span class="n">Const</span><span class="p">]</span>   <span class="p">[</span><span class="n">Const</span><span class="p">]</span>
            <span class="o">|</span>         <span class="o">|</span>
            <span class="n">V</span>         <span class="n">V</span>
<span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="n">Mul</span><span class="p">]</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="n">Add</span><span class="p">]</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="n">That</span> <span class="ow">is</span><span class="p">,</span>

    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">op1</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="n">constant</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">op2</span><span class="p">(</span><span class="o">%</span><span class="mi">4</span><span class="p">)</span>
    <span class="o">...</span>

<span class="n">Result</span><span class="p">:</span>

<span class="p">[</span><span class="o">...</span><span class="p">]</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="n">BatchNorm</span><span class="p">]</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="n">That</span> <span class="ow">is</span><span class="p">,</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">op1</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">batchnorm</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">op2</span><span class="p">(</span><span class="o">%</span><span class="mi">4</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.rank0_expand_dims_swap">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.</span></span><span class="sig-name descname"><span class="pre">rank0_expand_dims_swap</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_elementwise_binary.html#rank0_expand_dims_swap"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_elementwise_binary.rank0_expand_dims_swap" title="Link to this definition"></a></dt>
<dd><p>Identify the pattern of a <code class="docutils literal notranslate"><span class="pre">rank-0</span></code> binary elementwise operation followed by an <code class="docutils literal notranslate"><span class="pre">expand_dims</span></code> op.
In the MIL backend, the output of the <code class="docutils literal notranslate"><span class="pre">elementwise</span></code> op becomes rank 1. Hence, an <code class="docutils literal notranslate"><span class="pre">expand_dims</span></code> op
should be added after both of the <code class="docutils literal notranslate"><span class="pre">rank-0</span></code> tensors, and the final <code class="docutils literal notranslate"><span class="pre">expand_dims</span></code> should be removed.
If the output var of the binary elementwise op is consumed by more than one op, a <code class="docutils literal notranslate"><span class="pre">squeeze</span></code> op
is inserted.</p>
<p><cite>Input</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">...</span><span class="p">](</span><span class="n">rank</span><span class="o">-</span><span class="mi">0</span><span class="p">)</span> <span class="o">--&gt;</span> <span class="n">sub</span> <span class="o">--&gt;</span> <span class="n">expand_dims</span> <span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
                   <span class="o">^</span>   <span class="o">|</span>
                   <span class="o">|</span>   <span class="o">|--&gt;</span> <span class="n">op2</span>
                   <span class="o">|</span>   <span class="o">|</span>
                   <span class="o">|</span>   <span class="o">|--&gt;</span> <span class="n">op3</span>
                   <span class="o">|</span>
             <span class="p">[</span><span class="n">scalar</span> <span class="n">const</span><span class="p">]</span>
</pre></div>
</div>
<p><cite>Output</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="o">...</span><span class="p">](</span><span class="n">rank</span><span class="o">-</span><span class="mi">0</span><span class="p">)</span> <span class="o">--&gt;</span> <span class="n">expand_dims</span> <span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">--&gt;</span> <span class="n">sub</span> <span class="o">--&gt;</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>
                                              <span class="o">^</span>   <span class="o">|</span>
                                              <span class="o">|</span>   <span class="o">|--&gt;</span> <span class="n">squeeze</span> <span class="o">---&gt;</span> <span class="n">op2</span>
                                              <span class="o">|</span>                <span class="o">|</span>
                                              <span class="o">|</span>                <span class="o">|--&gt;</span> <span class="n">op3</span>
                                              <span class="o">|</span>
                                        <span class="n">expand_dims</span> <span class="p">(</span><span class="n">axes</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                              <span class="o">^</span>
                                              <span class="o">|</span>
                                              <span class="o">|</span>
                                        <span class="p">[</span><span class="n">scalar</span> <span class="n">const</span><span class="p">]</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.optimize_linear">
<span id="optimize-linear"></span><h2>optimize_linear<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_linear" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_linear.fuse_linear_bias">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_linear.</span></span><span class="sig-name descname"><span class="pre">fuse_linear_bias</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_linear.html#fuse_linear_bias"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_linear.fuse_linear_bias" title="Link to this definition"></a></dt>
<dd><p>Convert <code class="docutils literal notranslate"><span class="pre">linear</span> <span class="pre">+</span> <span class="pre">add/sub</span></code> to a single <code class="docutils literal notranslate"><span class="pre">linear</span></code> by updating the weight and bias of the <code class="docutils literal notranslate"><span class="pre">linear</span></code> layer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Example</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">Original</span><span class="p">:</span>
        <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=%</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=%</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># %2 is a rank-2 const tensor (weight)</span>
                                              <span class="c1"># %3 is a rank-1 const tensor (bias)</span>
        <span class="o">...</span>
        <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">4</span><span class="p">,</span> <span class="n">y</span><span class="o">=%</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># %5 is a const tensor with same shape as %3</span>

    <span class="n">Result</span><span class="p">:</span>
        <span class="o">%</span><span class="mi">8</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=%</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=%</span><span class="mi">7</span><span class="p">)</span> <span class="c1"># where %7 is a new const tensor with value</span>
                                              <span class="c1"># %7 = %3 + %6</span>

<span class="n">Example</span> <span class="mi">2</span><span class="p">:</span>
    <span class="n">Original</span><span class="p">:</span>
        <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=%</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=%</span><span class="mi">3</span><span class="p">)</span> <span class="c1"># %2 is a rank-2 const tensor (weight)</span>
                                              <span class="c1"># %3 is a rank-1 const tensor (bias)</span>
        <span class="o">...</span>
        <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">sub</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">5</span><span class="p">,</span> <span class="n">y</span><span class="o">=%</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># %5 is a const tensor with a broacasable shape with %3.</span>
                               <span class="n">i</span><span class="o">.</span><span class="n">e</span><span class="o">.</span> <span class="k">if</span> <span class="o">%</span><span class="mi">3</span> <span class="n">has</span> <span class="n">shape</span> <span class="p">(</span><span class="n">Dout</span><span class="p">),</span> <span class="o">%</span><span class="mi">5</span> <span class="n">could</span> <span class="n">be</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Dout</span><span class="p">)</span><span class="o">.</span>

    <span class="n">Result</span><span class="p">:</span>
        <span class="o">%</span><span class="mi">9</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=%</span><span class="mi">7</span><span class="p">,</span> <span class="n">bias</span><span class="o">=%</span><span class="mi">8</span><span class="p">)</span> <span class="c1"># where %7 is a new const tensor with value %7 = -%2</span>
                                              <span class="c1"># %8 = %5 - %3</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_linear.fuse_matmul_weight_bias">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_linear.</span></span><span class="sig-name descname"><span class="pre">fuse_matmul_weight_bias</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_linear.html#fuse_matmul_weight_bias"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_linear.fuse_matmul_weight_bias" title="Link to this definition"></a></dt>
<dd><p>Convert <code class="docutils literal notranslate"><span class="pre">matmul</span> <span class="pre">+</span> <span class="pre">add/sub</span></code> to <code class="docutils literal notranslate"><span class="pre">linear</span></code> whenever possible.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">1</span><span class="p">,</span> <span class="n">y</span><span class="o">=%</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># %1 or %2 is const and rank 2 (weight)</span>
    <span class="o">...</span>
    <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">3</span><span class="p">,</span> <span class="n">y</span><span class="o">=%</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># %4 is const. add(x=%4, y=%3) is equivalent</span>
                         <span class="c1"># sub is similar.</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="c1"># assuming %2 above is const and rank 2</span>
    <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">linear</span><span class="p">(</span><span class="n">x</span><span class="o">=%</span><span class="mi">1</span><span class="p">,</span> <span class="n">weight</span><span class="o">=%</span><span class="mi">2</span><span class="p">,</span> <span class="n">bias</span><span class="o">=%</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_linear.fuse_transpose_matmul">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_linear.</span></span><span class="sig-name descname"><span class="pre">fuse_transpose_matmul</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_linear.html#fuse_transpose_matmul"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_linear.fuse_transpose_matmul" title="Link to this definition"></a></dt>
<dd><p>Fuse <code class="docutils literal notranslate"><span class="pre">transpose</span> <span class="pre">+</span> <span class="pre">matmul</span></code> to <code class="docutils literal notranslate"><span class="pre">matmul</span></code> if possible,
since <code class="docutils literal notranslate"><span class="pre">matmul</span></code> has args <code class="docutils literal notranslate"><span class="pre">transpose_x</span></code> and <code class="docutils literal notranslate"><span class="pre">transpose_y</span></code> to transpose last 2 dims</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Positive</span> <span class="n">example</span><span class="p">:</span>
    <span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-|</span>
                                     <span class="o">|-&gt;</span> <span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">transposed_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">transposed_y</span><span class="p">)</span>
        <span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">-|</span>

    <span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">transpose_x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transpose_y</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">Negative</span> <span class="n">example</span><span class="p">:</span>
    <span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-|</span>
                                        <span class="o">|-&gt;</span> <span class="n">matmul</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">transposed_x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">transposed_y</span><span class="p">)</span>
        <span class="n">transpose</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="o">-|</span>

    <span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
        <span class="n">Same</span> <span class="n">to</span> <span class="nb">input</span> <span class="n">graph</span><span class="p">,</span> <span class="n">nothing</span> <span class="n">changes</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.optimize_normalization">
<span id="optimize-normalization"></span><h2>optimize_normalization<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_normalization" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_normalization.fuse_layernorm_or_instancenorm">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_normalization.</span></span><span class="sig-name descname"><span class="pre">fuse_layernorm_or_instancenorm</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_normalization.html#fuse_layernorm_or_instancenorm"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_normalization.fuse_layernorm_or_instancenorm" title="Link to this definition"></a></dt>
<dd><p>A graph optimization pass on PyMIL to detect and fuse several variants of <code class="docutils literal notranslate"><span class="pre">layer_norm</span></code> or
<code class="docutils literal notranslate"><span class="pre">instance_norm</span></code>. Pattern 1 corresponds to either <code class="docutils literal notranslate"><span class="pre">layer_norm</span></code> or <code class="docutils literal notranslate"><span class="pre">instance_norm</span></code>. Patterns 2-4
are <code class="docutils literal notranslate"><span class="pre">instance_norm</span></code>. Pattern 5 is <code class="docutils literal notranslate"><span class="pre">layer_norm</span></code>. You can find these patterns in the methods for
this class in the source code. To quickly view the source code, click the <strong>[source]</strong> button at
the end of the class definition.</p>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.optimize_quantization">
<span id="optimize-quantization"></span><h2>optimize_quantization<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_quantization" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_quantization.merge_affine_dequantize_with_consecutive_ops">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_quantization.</span></span><span class="sig-name descname"><span class="pre">merge_affine_dequantize_with_consecutive_ops</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_quantization.html#merge_affine_dequantize_with_consecutive_ops"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.merge_affine_dequantize_with_consecutive_ops" title="Link to this definition"></a></dt>
<dd><p>This graph pass does const folding to a chain of supported ops starts with a
<code class="docutils literal notranslate"><span class="pre">constexpr_affine_dequantize</span></code> op. More types of op are supported when quantization
is tensor-wise, and only a subset is supported for channel-wise. For example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
    <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">constexpr_affine_dequantize</span> <span class="o">-&gt;</span> <span class="n">transpose</span> <span class="o">-&gt;</span> <span class="n">expand_dims</span> <span class="o">-&gt;</span> <span class="n">out</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
    <span class="n">new_data</span> <span class="o">-&gt;</span> <span class="n">constexpr_affine_dequantize</span> <span class="o">-&gt;</span> <span class="n">out</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">new_data</span></code> is computed by <code class="docutils literal notranslate"><span class="pre">data</span> <span class="pre">-&gt;</span> <span class="pre">transpose</span> <span class="pre">-&gt;</span> <span class="pre">expand_dims</span></code>.</p>
<p>Note that, the graph pass only supports const folding of a single linked list pattern.
For example, the following pattern will not be changed</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="o">|-&gt;</span> <span class="n">constexpr_affine_dequantize</span> <span class="o">-&gt;</span> <span class="n">transpose</span> <span class="o">-&gt;</span> <span class="n">out</span>
<span class="n">data</span> <span class="o">-|</span>
      <span class="o">|-&gt;</span> <span class="n">constexpr_affine_dequantize</span> <span class="o">-&gt;</span> <span class="n">reshape</span> <span class="o">-&gt;</span> <span class="n">out_2</span>
</pre></div>
</div>
<p>since the quantized data is used by multiple <code class="docutils literal notranslate"><span class="pre">constexpr</span></code></p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_quantization.int_op_canonicalization">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_quantization.</span></span><span class="sig-name descname"><span class="pre">int_op_canonicalization</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_quantization.html#int_op_canonicalization"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.int_op_canonicalization" title="Link to this definition"></a></dt>
<dd><p>For general quantized operators, in Core ML, we represent them as
<code class="docutils literal notranslate"><span class="pre">dequantize</span> <span class="pre">-&gt;</span> <span class="pre">the</span> <span class="pre">floating-point</span> <span class="pre">version</span> <span class="pre">of</span> <span class="pre">this</span> <span class="pre">operator</span> <span class="pre">-&gt;</span> <span class="pre">quantize</span></code>,
because mathematically it is the floating-point tensor rather than
its quantized integer representation that gets operated upon.</p>
<p>For some quantized operators that do not involve floating-point arithmetic,
however, it is unnecessary to prepend <code class="docutils literal notranslate"><span class="pre">dequantize</span></code> and append <code class="docutils literal notranslate"><span class="pre">quantize</span></code>.
Examples are:</p>
<ul class="simple">
<li><p>reshape</p></li>
</ul>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_quantization.nullify_redundant_quantization_zero_point">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_quantization.</span></span><span class="sig-name descname"><span class="pre">nullify_redundant_quantization_zero_point</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_quantization.html#nullify_redundant_quantization_zero_point"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.nullify_redundant_quantization_zero_point" title="Link to this definition"></a></dt>
<dd><p>In Core ML quantization, the performance is better when <code class="docutils literal notranslate"><span class="pre">zero</span> <span class="pre">point</span> <span class="pre">=</span> <span class="pre">0</span></code>,
so we try to make <code class="docutils literal notranslate"><span class="pre">zero</span> <span class="pre">point</span> <span class="pre">=</span> <span class="pre">0</span></code> if possible:</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">zero</span> <span class="pre">point</span> <span class="pre">=</span> <span class="pre">-128</span></code></dt><dd><ul>
<li><p>this must be an int8 quantization</p></li>
<li><p>equivalent to uint8 quantization with 0 zero point</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">zero</span> <span class="pre">point</span> <span class="pre">=</span> <span class="pre">128</span></code></dt><dd><ul>
<li><p>this must be an uint8 quantization</p></li>
<li><p>equivalent to int8 quantization with 0 zero point</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Since <code class="docutils literal notranslate"><span class="pre">zero</span> <span class="pre">point</span> <span class="pre">=</span> <span class="pre">0</span></code> is equivalent to <code class="docutils literal notranslate"><span class="pre">zero</span> <span class="pre">point</span> <span class="pre">=</span> <span class="pre">None</span></code> in Core ML semantics,
we further canonicalize to <code class="docutils literal notranslate"><span class="pre">zero</span> <span class="pre">point</span> <span class="pre">=</span> <span class="pre">None</span></code> to:</p>
<ul class="simple">
<li><p>make further graph passes easier</p></li>
<li><p>avoid serializing trivial 0</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">zero</span> <span class="pre">point</span> <span class="pre">=</span> <span class="pre">0</span></code> case can be canonicalized trivially</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">op</span><span class="p">:</span>

    <span class="n">quantize</span><span class="o">/</span><span class="n">dequantize</span><span class="p">(</span><span class="n">zero_point</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="n">Output</span> <span class="n">op</span><span class="p">:</span>

    <span class="n">quantize</span><span class="o">/</span><span class="n">dequantize</span><span class="p">(</span><span class="n">zero_point</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
</pre></div>
</div>
<p>To guarantee the conservation of output regardless the zero-point shift
in <code class="docutils literal notranslate"><span class="pre">zero</span> <span class="pre">point</span> <span class="pre">=</span> <span class="pre">±128</span></code> cases, we would only transform:</p>
<ul class="simple">
<li><p>const dequantize, where we fuse the zero-point shift into the const</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Input op:

    dequantize(input=const, zero_point=±128)

Output op:

    dequantize(input=const∓128, zero_point=None)
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">quantize</span> <span class="pre">-&gt;</span> <span class="pre">dequantize</span></code>, where we nullify both simultaneously</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Input graph:

    input -&gt; quantize(zero_point=±128) -&gt; dequantize(zero_point=±128) -&gt; output

Output graph:

    input -&gt; quantize(zero_point=None) -&gt; dequantize(zero_point=None) -&gt; output
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_quantization.dequantize_quantize_pair_elimination">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_quantization.</span></span><span class="sig-name descname"><span class="pre">dequantize_quantize_pair_elimination</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_quantization.html#dequantize_quantize_pair_elimination"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.dequantize_quantize_pair_elimination" title="Link to this definition"></a></dt>
<dd><p>When a <code class="docutils literal notranslate"><span class="pre">dequantize</span></code> is followed by an identical <code class="docutils literal notranslate"><span class="pre">quantize</span></code> (same scale,
zero point, axis), they cancel out and can be eliminated</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
    <span class="nb">input</span> <span class="o">-&gt;</span> <span class="n">dequantize</span> <span class="o">-&gt;</span> <span class="n">quantize</span> <span class="o">-&gt;</span> <span class="n">output</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
    <span class="nb">input</span> <span class="o">-&gt;</span> <span class="n">output</span>
</pre></div>
</div>
<p>When the pattern has branches (dequantize has multiple children), we cannot
eliminate the whole pair, but can still shorten the path. More specifically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
    <span class="n">op1</span> <span class="o">-&gt;</span> <span class="n">dequantize</span> <span class="o">-&gt;</span> <span class="n">quantize</span> <span class="o">-&gt;</span> <span class="n">op2</span>
                 <span class="o">|</span>
                 <span class="o">|-&gt;</span> <span class="n">some_other_op</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
    <span class="n">op1</span> <span class="o">-&gt;</span> <span class="n">dequantize</span> <span class="o">-&gt;</span> <span class="n">some_other_op</span>
     <span class="o">|</span>
     <span class="o">|-&gt;</span> <span class="n">op2</span>
</pre></div>
</div>
<p>PS: On the other hand, the reversed pattern, i.e., <code class="docutils literal notranslate"><span class="pre">quantize</span> <span class="pre">-&gt;</span> <span class="pre">dequantize</span></code>,
is not redundant, since that is the pattern which naturally occurs when a
quantized op is converted.
In current activation quantization conversion, a quantized op becomes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dequantize</span> <span class="o">-&gt;</span> <span class="n">regular</span> <span class="n">op</span> <span class="o">-&gt;</span> <span class="n">quantize</span>
</pre></div>
</div>
<p>so if we have a sequence of quantized ops, we will get</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dequantize</span> <span class="o">-&gt;</span> <span class="n">regular</span> <span class="n">op1</span> <span class="o">-&gt;</span> <span class="n">quantize</span> <span class="o">-&gt;</span> <span class="n">dequantize</span> <span class="o">-&gt;</span> <span class="n">regular</span> <span class="n">op2</span> <span class="o">-&gt;</span> <span class="n">quantize</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">quantize</span> <span class="pre">-&gt;</span> <span class="pre">dequantize</span></code> pair in the middle is not redundant, even if
they have identical scales and zero points and axes, since removing them will lead to
loss of information about the quantization parameters of the output var of op1</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_quantization.distributive_quantized_binary_op_scale_normalization">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_quantization.</span></span><span class="sig-name descname"><span class="pre">distributive_quantized_binary_op_scale_normalization</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_quantization.html#distributive_quantized_binary_op_scale_normalization"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.distributive_quantized_binary_op_scale_normalization" title="Link to this definition"></a></dt>
<dd><p>In the backend, for better performance, quantized op can have 1 input scale
fused within the quantized op kernel. For binary ops, there are 2 inputs,
but only 1 can get fused. For example, for quantized <code class="docutils literal notranslate"><span class="pre">add</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MIL</span> <span class="n">graph</span> <span class="p">(</span><span class="n">consists</span> <span class="n">of</span> <span class="n">MIL</span> <span class="n">ops</span><span class="p">):</span>

    <span class="n">dequantize</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s_x</span><span class="p">,</span> <span class="n">zp_x</span><span class="p">)</span> <span class="o">-|</span>
    <span class="n">x_fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">zp_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">s_x</span>   <span class="o">|</span>
                              <span class="o">|-&gt;</span>  <span class="n">add</span><span class="p">(</span><span class="n">x_fp</span><span class="p">,</span> <span class="n">y_fp</span><span class="p">)</span>   <span class="o">-&gt;</span> <span class="n">quantize</span><span class="p">(</span><span class="n">z_fp</span><span class="p">,</span> <span class="n">s_z</span><span class="p">,</span> <span class="n">zp_z</span><span class="p">)</span>
    <span class="n">dequantize</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">s_y</span><span class="p">,</span> <span class="n">zp_y</span><span class="p">)</span> <span class="o">-|</span>   <span class="n">z_fp</span> <span class="o">=</span> <span class="n">x_fp</span> <span class="o">+</span> <span class="n">y_fp</span>      <span class="n">z</span> <span class="o">=</span> <span class="n">z_fp</span> <span class="o">/</span> <span class="n">s_z</span> <span class="o">+</span> <span class="n">zp_z</span>
    <span class="n">y_fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">zp_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">s_y</span>

<span class="n">Backend</span> <span class="n">graph</span> <span class="p">(</span><span class="n">consists</span> <span class="n">of</span> <span class="n">backend</span> <span class="n">instructions</span><span class="p">,</span> <span class="n">usually</span> <span class="n">including</span> <span class="o">+</span> <span class="o">-</span> <span class="o">*</span> <span class="o">/</span> <span class="ow">and</span> <span class="n">fused</span> <span class="o">*+</span><span class="p">):</span>

    <span class="n">x_shift</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">zp_x</span> <span class="o">-------------------------|</span>
                                                <span class="o">|-&gt;</span> <span class="n">z_fp</span> <span class="o">=</span> <span class="n">s_x</span> <span class="o">*</span> <span class="n">x_shift</span> <span class="o">+</span> <span class="n">y_fp</span> <span class="o">-&gt;</span> <span class="n">z</span> <span class="o">=</span> <span class="n">z_fp</span> <span class="o">/</span> <span class="n">s_z</span> <span class="o">+</span> <span class="n">zp_z</span>
    <span class="n">y_shift</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">zp_y</span> <span class="o">-&gt;</span> <span class="n">y_fp</span> <span class="o">=</span> <span class="n">s_y</span> <span class="o">*</span> <span class="n">y_shift</span> <span class="o">-|</span>
</pre></div>
</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code> are the inputs, <code class="docutils literal notranslate"><span class="pre">z</span></code> is the output,
<code class="docutils literal notranslate"><span class="pre">s</span></code> and <code class="docutils literal notranslate"><span class="pre">zp</span></code> are the corresponding scale and zero point.</p>
<p>The reason why fusing one scale leads to better performance is,
instead of 2 instructions <code class="docutils literal notranslate"><span class="pre">x_fp</span> <span class="pre">=</span> <span class="pre">s_x</span> <span class="pre">*</span> <span class="pre">x_shift</span></code> and <code class="docutils literal notranslate"><span class="pre">z_fp</span> <span class="pre">=</span> <span class="pre">x_fp</span> <span class="pre">+</span> <span class="pre">y_fp</span></code>,
a single <code class="docutils literal notranslate"><span class="pre">z_fp</span> <span class="pre">=</span> <span class="pre">x_shift</span> <span class="pre">*</span> <span class="pre">s_x</span> <span class="pre">+</span> <span class="pre">y_fp</span></code> instruction achieves the same result.</p>
<p>In this pass, we normalize <code class="docutils literal notranslate"><span class="pre">s_y</span></code> to 1, so the <code class="docutils literal notranslate"><span class="pre">y_fp</span> <span class="pre">=</span> <span class="pre">s_y</span> <span class="pre">*</span> <span class="pre">y_shift</span></code>
instruction can get skipped as well, leading to even better performance.
This pass only applies to distributive binary ops such as <code class="docutils literal notranslate"><span class="pre">add</span></code> and <code class="docutils literal notranslate"><span class="pre">sub</span></code></p>
<p>Appendix: Mathematical and Computer-Scientific Details</p>
<p>Mathematically, for a binary operator <code class="docutils literal notranslate"><span class="pre">.op.</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">z_fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">zp_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">s_x</span> <span class="o">.</span><span class="n">op</span><span class="o">.</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">zp_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">s_y</span>
     <span class="o">=</span> <span class="n">s_y</span> <span class="o">*</span> <span class="p">[(</span><span class="n">x</span> <span class="o">-</span> <span class="n">zp_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">s_x</span><span class="o">/</span><span class="n">s_y</span> <span class="o">.</span><span class="n">op</span><span class="o">.</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">zp_y</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>The corresponding pseudo code is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># before</span>
<span class="n">z_fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">zp_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">s_x</span> <span class="o">.</span><span class="n">op</span><span class="o">.</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">zp_y</span><span class="p">)</span> <span class="o">*</span> <span class="n">s_y</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">z_fp</span> <span class="o">/</span> <span class="n">s</span> <span class="o">-</span> <span class="n">zp_z</span>

<span class="c1"># after</span>
<span class="n">z_fp_modified</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">zp_x</span><span class="p">)</span> <span class="o">*</span> <span class="n">s_x</span><span class="o">/</span><span class="n">s_y</span> <span class="o">.</span><span class="n">op</span><span class="o">.</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">zp_y</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.0</span>
<span class="n">z</span> <span class="o">=</span> <span class="n">z_fp_modified</span> <span class="o">/</span> <span class="p">(</span><span class="n">s_z</span><span class="o">/</span><span class="n">s_y</span><span class="p">)</span> <span class="o">-</span> <span class="n">zp_z</span>
</pre></div>
</div>
<p>Concretely, as a MIL graph pass</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
    <span class="n">dequantize</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">s_x</span><span class="p">)</span> <span class="o">-|</span>
                           <span class="o">|-&gt;</span> <span class="n">op</span> <span class="o">-&gt;</span> <span class="n">quantize</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">s_z</span><span class="p">)</span>
    <span class="n">dequantize</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">s_y</span><span class="p">)</span> <span class="o">-|</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
    <span class="n">dequantize</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">s_x</span><span class="o">/</span><span class="n">s_y</span><span class="p">)</span> <span class="o">-|</span>
                               <span class="o">|-&gt;</span> <span class="n">op</span> <span class="o">-&gt;</span> <span class="n">quantize</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">s_z</span><span class="o">/</span><span class="n">s_y</span><span class="p">)</span>
    <span class="n">dequantize</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>     <span class="o">-|</span>
</pre></div>
</div>
<p>PS: we only support scalar <code class="docutils literal notranslate"><span class="pre">s_y</span></code> for now. If <code class="docutils literal notranslate"><span class="pre">s_y</span></code> is not scalar but
<code class="docutils literal notranslate"><span class="pre">s_x</span></code> is, we would swap <code class="docutils literal notranslate"><span class="pre">x</span></code> and <code class="docutils literal notranslate"><span class="pre">y</span></code>. Support for both-vector case is
to be explored, due to the broadcasting complication.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_quantization.dequantize_to_constexpr">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_quantization.</span></span><span class="sig-name descname"><span class="pre">dequantize_to_constexpr</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_quantization.html#dequantize_to_constexpr"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_quantization.dequantize_to_constexpr" title="Link to this definition"></a></dt>
<dd><p><code class="docutils literal notranslate"><span class="pre">dequantize</span></code> op with constant input is equivalent to <code class="docutils literal notranslate"><span class="pre">constexpr_affine_dequantize</span></code>.
This is one of the canonicalization pass that transforms all such
<code class="docutils literal notranslate"><span class="pre">dequantize</span></code> ops to respective <code class="docutils literal notranslate"><span class="pre">constexpr_affine_dequantize</span></code> ops.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>

    <span class="n">dequantize</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">const</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">downstream</span> <span class="n">op</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>

    <span class="n">constexpr_affine_dequantize</span> <span class="o">-&gt;</span> <span class="n">downstream</span> <span class="n">op</span>
</pre></div>
</div>
<p>This pass is being performed because constant tensors being propagated
through <code class="docutils literal notranslate"><span class="pre">dequantize</span></code> op would be serialized in bloated/decompressed fashion,
whereas with <code class="docutils literal notranslate"><span class="pre">constexpr_affine_dequantize</span></code>,
constant weights/tensors remain compressed at serialization.</p>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops">
<span id="optimize-repeat-ops"></span><h2>optimize_repeat_ops<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.cast_optimization">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.</span></span><span class="sig-name descname"><span class="pre">cast_optimization</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_repeat_ops.html#cast_optimization"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.cast_optimization" title="Link to this definition"></a></dt>
<dd><p>This optimization pass performs the following:</p>
<ul class="simple">
<li><p>Removes redundant <code class="docutils literal notranslate"><span class="pre">cast</span></code> op; that is, <code class="docutils literal notranslate"><span class="pre">cast</span></code> where source and destination tensors have same dtypes.</p></li>
<li><p>Fuses two consecutive <cite>cast</cite> ops if applicable, repeatedly.</p></li>
</ul>
<p>This is a non-algebraic translation which assumes that the upcasting doesn’t change the user’s intent.</p>
<ol class="arabic">
<li><p>Example for redundant <code class="docutils literal notranslate"><span class="pre">cast</span></code> op removal:
.. code-block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   Input graph:
   input(fp16) -&gt; cast(dtype=&quot;fp16&quot;) -&gt; relu -&gt; out

   Output graph:
   input -&gt; relu -&gt; out

The input and output tensors for the ``cast`` op are both with type of ``fp16``.
Hence, it can be removed.
</pre></div>
</div>
</li>
<li><p>Example for two <code class="docutils literal notranslate"><span class="pre">cast</span></code> ops fusion:
.. code-block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   <span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
   <span class="nb">input</span><span class="p">(</span><span class="n">int8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp16&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out</span>

   <span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
   <span class="nb">input</span><span class="p">(</span><span class="n">int8</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">cast</span><span class="p">(</span><span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;fp32&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">out</span>

<span class="n">The</span> <span class="n">data</span> <span class="nb">range</span> <span class="ow">and</span> <span class="n">resolution</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">graph</span> <span class="n">are</span> <span class="n">limited</span> <span class="n">by</span> <span class="n">the</span> <span class="n">int8</span> <span class="nb">input</span><span class="p">,</span>
<span class="n">so</span> <span class="n">the</span> <span class="n">fusion</span> <span class="ow">is</span> <span class="n">allowed</span><span class="o">.</span>
</pre></div>
</div>
</li>
<li><p>Negative example for two <code class="docutils literal notranslate"><span class="pre">cast</span></code> ops fusion:
.. code-block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   Input graph:
   input(fp32) -&gt; cast(dtype=&quot;bool&quot;) -&gt; cast(dtype=&quot;fp16&quot;) -&gt; out

   Output graph:
   Same as input graph.

The above two ``cast`` ops cannot be merged, since after the first cast,
the resolution of the numerical output is downcasted to binary (``0, 1``).
If we fuse them, the output would be in the range and resolution of ``fp16`` instead.
</pre></div>
</div>
</li>
<li><p>Another Negative example for two <code class="docutils literal notranslate"><span class="pre">cast</span></code> ops fusion:
.. code-block:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>   Input graph:
   input(int32) -&gt; cast(dtype=&quot;int8&quot;) -&gt; cast(dtype=&quot;uint8&quot;) -&gt; out

   Output graph:
   Same as input graph.

The above two ``cast`` ops cannot be merged, since in the original graph,
by going through two casts, the output numerical range is capped to ``[0, 127]``.
However, if two ``cast`` ops are reduced to 1 ``cast(dtype=&quot;uint8&quot;)``, the output
numerical would in the range of ``[0, 255]``. The fusion would cause numerical
issue for the numbers between ``[128, 255]``, which is prohibited.
</pre></div>
</div>
</li>
</ol>
<p>In general, two <code class="docutils literal notranslate"><span class="pre">cast</span></code> ops can be merged if the output data range and resolution is not affected.</p>
<p>For more examples, please see the unittests that start with prefix <code class="docutils literal notranslate"><span class="pre">TestCastOptimization</span></code> in <code class="docutils literal notranslate"><span class="pre">test_passes.py</span></code>.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_paddings">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.</span></span><span class="sig-name descname"><span class="pre">merge_consecutive_paddings</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_repeat_ops.html#merge_consecutive_paddings"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_paddings" title="Link to this definition"></a></dt>
<dd><p>Identify two consecutive <code class="docutils literal notranslate"><span class="pre">pad</span></code> layers which could be merged into a single <code class="docutils literal notranslate"><span class="pre">pad</span></code> layer.</p>
<p>This is possible only if one of the following conditions is satisfied:</p>
<ul class="simple">
<li><p>The paddings are “constant” and have the same <code class="docutils literal notranslate"><span class="pre">constant_val</span></code>.</p></li>
<li><p>The paddings act along different axes.</p></li>
</ul>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
<span class="nb">input</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">------&gt;</span> <span class="n">pad</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect) -----&gt; pad([1, 1, 0, 0], mode=&#39;</span><span class="n">reflect</span><span class="s1">&#39;) ---&gt; out(1, 2, 8, 10)</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
<span class="nb">input</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">------&gt;</span> <span class="n">pad</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reflect) ---&gt; out(1, 2, 8, 10)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_relus">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.</span></span><span class="sig-name descname"><span class="pre">merge_consecutive_relus</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_repeat_ops.html#merge_consecutive_relus"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_relus" title="Link to this definition"></a></dt>
<dd><p>Identify consecutive <code class="docutils literal notranslate"><span class="pre">relu</span></code> layers which could be merged into a single <code class="docutils literal notranslate"><span class="pre">relu</span></code> layer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
<span class="nb">input</span> <span class="o">------&gt;</span> <span class="n">relu</span> <span class="o">-----&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">relu</span> <span class="n">layers</span> <span class="o">---&gt;</span> <span class="n">out</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
<span class="nb">input</span> <span class="o">------&gt;</span> <span class="n">relu</span> <span class="o">---&gt;</span> <span class="n">out</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_reshapes">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.</span></span><span class="sig-name descname"><span class="pre">merge_consecutive_reshapes</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_repeat_ops.html#merge_consecutive_reshapes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_reshapes" title="Link to this definition"></a></dt>
<dd><p>Identify consecutive <code class="docutils literal notranslate"><span class="pre">reshape</span></code> ops which could be merged into a single <code class="docutils literal notranslate"><span class="pre">reshape</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
<span class="nb">input</span> <span class="o">-&gt;</span> <span class="n">reshape</span> <span class="o">-&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">reshapes</span> <span class="o">-&gt;</span> <span class="n">output</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
<span class="nb">input</span> <span class="o">-&gt;</span> <span class="n">reshape</span> <span class="o">-&gt;</span> <span class="n">output</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_transposes">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.</span></span><span class="sig-name descname"><span class="pre">merge_consecutive_transposes</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_repeat_ops.html#merge_consecutive_transposes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.merge_consecutive_transposes" title="Link to this definition"></a></dt>
<dd><p>Identify consecutive ‘transpose’ layers which could be merged into a single ‘transpose’ layer.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
<span class="nb">input</span> <span class="o">------&gt;</span> <span class="n">transpose</span> <span class="o">-----&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">transpose</span> <span class="n">layers</span> <span class="o">---&gt;</span> <span class="n">out</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
<span class="nb">input</span> <span class="o">------&gt;</span> <span class="n">transpose</span> <span class="o">---&gt;</span> <span class="n">out</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.reduce_transposes">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.</span></span><span class="sig-name descname"><span class="pre">reduce_transposes</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_repeat_ops.html#reduce_transposes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_repeat_ops.reduce_transposes" title="Link to this definition"></a></dt>
<dd><p>Reduce transposes when it is applicable. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Example 1</span>
    <span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
    <span class="nb">input</span> <span class="o">-----&gt;</span> <span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">-----&gt;</span> <span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">---&gt;</span> <span class="n">out</span>

    <span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
    <span class="nb">input</span> <span class="o">-----&gt;</span> <span class="n">identity</span> <span class="o">-----&gt;</span> <span class="n">out</span>

<span class="c1"># Example 2</span>
    <span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
    <span class="nb">input</span><span class="o">----&gt;</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">----&gt;</span><span class="n">relu</span><span class="o">----&gt;</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">---&gt;</span><span class="n">out</span>

    <span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
    <span class="nb">input</span><span class="o">-----&gt;</span><span class="n">relu</span><span class="o">-----&gt;</span><span class="n">out</span>

<span class="c1"># Example 3</span>
    <span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">---&gt;</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">-----&gt;</span><span class="n">relu</span><span class="o">----&gt;</span><span class="n">pool</span><span class="o">-----&gt;</span><span class="n">out1</span>
                                                       <span class="o">|</span>
                                                       <span class="o">|</span>
                                                       <span class="o">---&gt;</span><span class="n">relu</span><span class="o">-----&gt;</span><span class="n">log</span><span class="o">----&gt;</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span><span class="o">----&gt;</span><span class="n">out2</span>

    <span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>
    <span class="nb">input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span><span class="o">-----&gt;</span><span class="n">relu</span><span class="o">----&gt;</span><span class="n">transpose</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">----&gt;</span><span class="n">pool</span><span class="o">-----&gt;</span><span class="n">out1</span>
                           <span class="o">|</span>
                           <span class="o">|</span>
                           <span class="o">---&gt;</span><span class="n">relu</span><span class="o">-----&gt;</span><span class="n">log</span><span class="o">----&gt;</span><span class="n">out2</span>
</pre></div>
</div>
<p>Please see <code class="docutils literal notranslate"><span class="pre">TransposeOptimizationPass</span></code> for more details.</p>
<p class="rubric">Notes</p>
<p>This pass is divided into 3 phases:</p>
<p><cite>1st phase:</cite> Information gathering.</p>
<ul class="simple">
<li><p>Plug in Identity ops for all output nodes. This allows us to treat all ops uniformly during traversal.</p></li>
<li><p>Block is traversed in the topological order, starting from the ops connected to the inputs.</p></li>
<li><p>During the traversal, a value is associated with every var in the block.
This value can be either of type <code class="docutils literal notranslate"><span class="pre">_HypotheticalValue</span></code> or <code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code>.
The main purpose of type <code class="docutils literal notranslate"><span class="pre">_HypotheticalValue</span></code> is to indicate that it is <cite>not</cite> of type <code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code> represents either one or multiple transpose ops with the same perm value. This information
is stored in this class. It also wraps a <code class="docutils literal notranslate"><span class="pre">_HypotheticalValue</span></code> that was the last hypothetical value which was generated
prior to the origin of <code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code>.</p></li>
<li><p>Each op decides which type of hypothetical value to associate with its output vars, based on its op type,
attributes, and the types of the hypothetical values of its input vars.</p></li>
<li><p>Ops are classified into 4 categories: <cite>unary like</cite>, <cite>axis update</cite>, <cite>transpose</cite>, and <cite>materialize</cite> (for all the rest).</p></li>
<li><dl class="simple">
<dt>Transpose ops are the ops from which a <code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code> originate.</dt><dd><ul>
<li><p>If the input to it is a <code class="docutils literal notranslate"><span class="pre">_HypotheticalValue</span></code>, its output will be a <code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code>,
indicating that this <code class="docutils literal notranslate"><span class="pre">transpose</span></code> op is available to get cancelled downstream.</p></li>
<li><dl class="simple">
<dt>If the input to it is a <code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code>, then it is checked whether this op cancels it or not.</dt><dd><ul>
<li><p>If the op cancels it, a <code class="docutils literal notranslate"><span class="pre">_HypotheticalValue</span></code> value is generated at the output and the information about this <code class="docutils literal notranslate"><span class="pre">transpose</span></code> cancellation
is recorded in the dictionary <code class="docutils literal notranslate"><span class="pre">transpose_op_to_cancel_ops</span></code>.</p></li>
<li><p>If the op does not cancel, the current <code class="docutils literal notranslate"><span class="pre">transpose</span></code> op is categrorized as a <cite>materialize</cite> op. Therefore, the information in
dictionary <code class="docutils literal notranslate"><span class="pre">transpose_op_to_materialize_ops</span></code> is updated accordingly. The output of the op is now mapped to a
<code class="docutils literal notranslate"><span class="pre">_HypotheticalValue</span></code>.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</dd>
</dl>
</li>
<li><p>Unary like ops: These simply transfer their input hypothetical value type to the output.</p></li>
<li><p>Axis update ops: If a <code class="docutils literal notranslate"><span class="pre">transpose</span></code> can pass through them, they are treated like a unary op and the dictionary
<code class="docutils literal notranslate"><span class="pre">transpose_op_to_axis_update_ops</span></code> is updated. If the op cannot be updated in any manner to
allow a <code class="docutils literal notranslate"><span class="pre">transpose</span></code> to pass through, this op is then categorized as a <cite>materialize</cite> op and handled accordingly.</p></li>
<li><p>Materialize ops: All <code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code> input vars, if present, materialize here. Output of this op
is always of type <code class="docutils literal notranslate"><span class="pre">_HypotheticalValue</span></code>. If the input is a <code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code>, update the dictionary
<code class="docutils literal notranslate"><span class="pre">transpose_op_to_materialize_ops</span></code>.</p></li>
<li><p>To treat an op like a unary op, add its type to <code class="docutils literal notranslate"><span class="pre">_UNARY_LIKE_OP_TYPES</span></code>. In future changes we want to make this process
automatic by detecting an op as a <cite>unary like</cite> by its “traits”.</p></li>
<li><p>To treat an op like <cite>axis update</cite> op, add a class specific to the op implementing the class <code class="docutils literal notranslate"><span class="pre">TransformAxisUpdateOps</span></code>.
For examples, see classes <code class="docutils literal notranslate"><span class="pre">_TransformConcat</span></code>, <code class="docutils literal notranslate"><span class="pre">_TransformPad</span></code>, and so on. The dictionary <code class="docutils literal notranslate"><span class="pre">AXIS_UPDATE_OPS</span></code> is automatically filled
in by the decorator <code class="docutils literal notranslate"><span class="pre">_TransposeOptimization.register_axis_update_op</span></code>.</p></li>
</ul>
<p><cite>2nd phase:</cite> Determining which <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops to remove from the graph.</p>
<p>All <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops that have a corresponding compliment op in dict <code class="docutils literal notranslate"><span class="pre">transpose_op_to_cancel_ops</span></code> is a candidate.
However, you need to ensure the following:</p>
<ul class="simple">
<li><p>If a <code class="docutils literal notranslate"><span class="pre">transpose</span></code> op is removed, then all of its <code class="docutils literal notranslate"><span class="pre">cancel</span></code> ops in <code class="docutils literal notranslate"><span class="pre">transpose_op_to_cancel_ops</span></code> must also be removed,
to ensure correctness of the graph. The same is true in the reverse direction as well;
that is, for every <code class="docutils literal notranslate"><span class="pre">cancel</span></code> op that is removed, all its parent <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops upstream must also be removed.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops should be removed only if the number of <code class="docutils literal notranslate"><span class="pre">cancel</span></code> ops is greater than the number of <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops
that would get freshly introduced to the block as a result of materialization ops. Currently in the algorithm,
each materialization op/output var (dicts <code class="docutils literal notranslate"><span class="pre">transpose_op_to_materialize_ops</span></code>/<code class="docutils literal notranslate"><span class="pre">old_output_vars</span></code>)
results in one more <code class="docutils literal notranslate"><span class="pre">transpose</span></code> op, although this can be further optimized in the future.</p></li>
</ul>
<p>To resolve this, we recognize that nodes consisting of sets <code class="docutils literal notranslate"><span class="pre">(a)</span></code> and <code class="docutils literal notranslate"><span class="pre">(b)</span></code> form a bipartitle graph, where,
<code class="docutils literal notranslate"><span class="pre">(a)</span> <span class="pre">==</span></code> starting <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops (originators of <code class="docutils literal notranslate"><span class="pre">_LazyTransposeHypotheticalValue</span></code>)
and <code class="docutils literal notranslate"><span class="pre">(b)</span> <span class="pre">==</span></code> set of <code class="docutils literal notranslate"><span class="pre">transpose</span></code> <code class="docutils literal notranslate"><span class="pre">cancel</span></code> ops and <code class="docutils literal notranslate"><span class="pre">materialize</span></code> ops.</p>
<ul class="simple">
<li><p>In this bipartite graph, we find all the connected components for each connected component.
Either the entire set of <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops in it are removed/materialized, or none
of them are touched.</p></li>
<li><p>Thus for each set, a determination is made based on counting the number of <code class="docutils literal notranslate"><span class="pre">cancel</span></code> ops and <code class="docutils literal notranslate"><span class="pre">materialize</span></code> ops.</p></li>
<li><p>Based on this determination, the final set of <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops to be removed is updated.</p></li>
</ul>
<p><cite>3rd phase:</cite> Transforming the graph.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">transpose</span></code> starting ops and the <code class="docutils literal notranslate"><span class="pre">cancel</span></code> ops are removed.</p></li>
<li><p>Axis update ops, affected by these <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops, are updated.</p></li>
<li><p>Transposes are materialized; that is, added just before the <code class="docutils literal notranslate"><span class="pre">materialize</span></code> ops, which are linked to the starting <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops.
The starting <code class="docutils literal notranslate"><span class="pre">transpose</span></code> op can be materialized (inserted) multiple times, before each of the <code class="docutils literal notranslate"><span class="pre">materialize</span></code> ops downstream.</p></li>
<li><p>Block outputs are handled in a similar fashion as the <cite>materialize</cite> ops.</p></li>
<li><p>Type inference on all ops is invoked after all the transformations.</p></li>
<li><p>All Identity ops that are plugged into the graph to treat outputs as materialized are removed.</p></li>
</ul>
<p><cite>Debugging</cite></p>
<p>If the <code class="docutils literal notranslate"><span class="pre">debug</span></code> flag is set to <code class="docutils literal notranslate"><span class="pre">True</span></code>, the block before and after the transformation is plotted,
with transpose nodes highlighted.</p>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.optimize_state">
<span id="optimize-state"></span><h2>optimize_state<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_state" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_state.canonicalize_inplace_pattern">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_state.</span></span><span class="sig-name descname"><span class="pre">canonicalize_inplace_pattern</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_state.html#canonicalize_inplace_pattern"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_state.canonicalize_inplace_pattern" title="Link to this definition"></a></dt>
<dd><p>As a functional-graph framework, Core ML represents in-place operation as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">read_state</span> <span class="o">-&gt;</span> <span class="n">functional</span> <span class="n">operation</span> <span class="o">-&gt;</span> <span class="n">write_state</span>
</pre></div>
</div>
<p>Due to the non-uniqueness of topological order, in the list representation of ops,
<code class="docutils literal notranslate"><span class="pre">write_state</span></code> can be anywhere after the functional op. We prefer the canonical order,
i.e. have <code class="docutils literal notranslate"><span class="pre">write_state</span></code> immediately follow the functional op</p>
<p>In practice</p>
<p>1. In PyMIL, we do not use <code class="docutils literal notranslate"><span class="pre">write_state</span></code> op. Instead, we use <code class="docutils literal notranslate"><span class="pre">coreml_update_state</span></code>,
which is the composition of <code class="docutils literal notranslate"><span class="pre">write_state</span> <span class="pre">-&gt;</span> <span class="pre">read_state</span></code></p>
<ol class="arabic simple" start="2">
<li><p>The <code class="docutils literal notranslate"><span class="pre">read_state</span></code> op does not matter in the pattern match and transform</p></li>
</ol>
<p>So we will match</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">functional</span> <span class="n">operation</span> <span class="o">-&gt;</span> <span class="n">coreml_update_state</span>
</pre></div>
</div>
<p>then reorder the <code class="docutils literal notranslate"><span class="pre">coreml_update_state</span></code>. For example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>

    <span class="n">mul</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">add</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">coreml_update_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">mul</span><span class="p">)</span>

<span class="n">Return</span><span class="p">:</span>

    <span class="n">mul</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">coreml_update_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">mul</span><span class="p">)</span>
    <span class="n">add</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_state.prefer_state_in_downstream">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_state.</span></span><span class="sig-name descname"><span class="pre">prefer_state_in_downstream</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_state.html#prefer_state_in_downstream"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_state.prefer_state_in_downstream" title="Link to this definition"></a></dt>
<dd><p>As a functional-graph framework, Core ML represents in-place operation as</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">read_state</span> <span class="o">-&gt;</span> <span class="n">functional</span> <span class="n">operation</span> <span class="o">-&gt;</span> <span class="n">write_state</span>
</pre></div>
</div>
<p>When the output of the in-place operation is used downstream,
there are 2 possible patterns, one reuses state memory</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">read_state</span> <span class="o">-&gt;</span> <span class="n">functional</span> <span class="n">operation</span> <span class="o">-&gt;</span> <span class="n">write_state</span> <span class="o">-&gt;</span> <span class="n">read_state</span> <span class="o">-&gt;</span> <span class="o">...</span>
</pre></div>
</div>
<p>the other wastes memory for keeping functional output</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>                                    <span class="o">|-&gt;</span> <span class="n">write_state</span>
<span class="n">read_state</span> <span class="o">-&gt;</span> <span class="n">functional</span> <span class="n">operation</span> <span class="o">-|</span>
                                    <span class="o">|-&gt;</span> <span class="o">...</span>
</pre></div>
</div>
<p>We prefer the reuse-state one</p>
<p>In practice</p>
<p>1. In PyMIL, we do not use <code class="docutils literal notranslate"><span class="pre">write_state</span></code> op. Instead, we use <code class="docutils literal notranslate"><span class="pre">coreml_update_state</span></code>,
which is the composition of <code class="docutils literal notranslate"><span class="pre">write_state</span> <span class="pre">-&gt;</span> <span class="pre">read_state</span></code></p>
<p>2. With canonical inplace pattern (guaranteed by graph pass <code class="docutils literal notranslate"><span class="pre">canonicalize_inplace_pattern</span></code>),
simply replace the usage of functional output with <code class="docutils literal notranslate"><span class="pre">coreml_update_state</span></code> output is enough</p>
<p>For example</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>

    <span class="n">mul</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">coreml_update_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">mul</span><span class="p">)</span>
    <span class="n">add</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">mul</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="n">Return</span><span class="p">:</span>

    <span class="n">mul</span> <span class="o">=</span> <span class="n">mul</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    <span class="n">update</span> <span class="o">=</span> <span class="n">coreml_update_state</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">mul</span><span class="p">)</span>
    <span class="n">add</span> <span class="o">=</span> <span class="n">add</span><span class="p">(</span><span class="n">update</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation">
<span id="optimize-tensor-operation"></span><h2>optimize_tensor_operation<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.concat_to_pixel_shuffle">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.</span></span><span class="sig-name descname"><span class="pre">concat_to_pixel_shuffle</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_tensor_operation.html#concat_to_pixel_shuffle"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.concat_to_pixel_shuffle" title="Link to this definition"></a></dt>
<dd><p>Identify nested, interleaved <code class="docutils literal notranslate"><span class="pre">concat</span></code> ops which can be replaced by a single <code class="docutils literal notranslate"><span class="pre">concat</span></code> and a <cite>pixel shuffle</cite> layer.</p>
<p>This pattern occurs with the faster up-convolution from the FCRN model (Laina et al., 2016).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Before the concat_to_pixel_shuffle pass.</span>
<span class="nb">input</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">-------------------</span>
                                    <span class="o">|</span>
                                    <span class="n">v</span>
<span class="nb">input</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">concat</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">interleave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">concat</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">interleave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">----&gt;</span> <span class="n">output</span>
                                                                            <span class="o">^</span>
                                                                            <span class="o">|</span>
<span class="nb">input</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">concat</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">interleave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">--------------------</span>
            <span class="o">|</span>                       <span class="o">^</span>
            <span class="o">|</span>                       <span class="o">|</span>
<span class="nb">input</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">-------------------</span>

<span class="c1"># After the concat_to_pixel_shuffle pass.</span>
<span class="nb">input</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">---------------</span>
                                <span class="o">|</span>
                                <span class="n">v</span>
<span class="nb">input</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">concat</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interleave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="o">-----&gt;</span> <span class="n">pixel_shuffle</span><span class="p">(</span><span class="n">upscale_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="o">----&gt;</span> <span class="n">output</span>
                                <span class="o">^</span>
                                <span class="o">|</span>
<span class="nb">input</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">--------------|</span>
                                <span class="o">|</span>
                                <span class="o">|</span>
<span class="nb">input</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span><span class="p">)</span> <span class="o">---------------</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.detect_concat_interleave">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.</span></span><span class="sig-name descname"><span class="pre">detect_concat_interleave</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_tensor_operation.html#detect_concat_interleave"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.detect_concat_interleave" title="Link to this definition"></a></dt>
<dd><p>Detect the pattern <code class="docutils literal notranslate"><span class="pre">concat--&gt;reshape---&gt;transpose---&gt;reshape</span></code>, where <code class="docutils literal notranslate"><span class="pre">concat</span></code> is
along the channel axis <code class="docutils literal notranslate"><span class="pre">(axis=-3)</span></code>, and map this pattern to the <code class="docutils literal notranslate"><span class="pre">concat</span></code> with <code class="docutils literal notranslate"><span class="pre">interleave</span></code> op.</p>
<p>This pattern occurs, for example, in the <code class="docutils literal notranslate"><span class="pre">shufflenet</span></code> model in <code class="docutils literal notranslate"><span class="pre">torchvision</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="o">%</span><span class="mf">1.</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="mf">1.</span><span class="n">b</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">interleave</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="c1">#shape = (B, n*C, H, W)</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">)</span> <span class="c1">#shape = (B, n, C, H, W)</span>
    <span class="o">%</span><span class="mi">5</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="mi">4</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span> <span class="c1"># shape = (B, C, n, H, W)</span>
    <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="mi">5</span><span class="p">)</span> <span class="c1"># shape = (B, C*n, H, W)</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">6</span> <span class="o">=</span> <span class="n">concat</span><span class="p">(</span><span class="o">%</span><span class="mf">1.</span><span class="n">a</span><span class="p">,</span> <span class="o">%</span><span class="mf">1.</span><span class="n">b</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">3</span><span class="p">,</span> <span class="n">interleave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.expand_high_rank_reshape_and_transpose">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.</span></span><span class="sig-name descname"><span class="pre">expand_high_rank_reshape_and_transpose</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_tensor_operation.html#expand_high_rank_reshape_and_transpose"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.expand_high_rank_reshape_and_transpose" title="Link to this definition"></a></dt>
<dd><p>Detect the pattern <code class="docutils literal notranslate"><span class="pre">reshape_1--&gt;transpose--&gt;reshape_2</span></code>, where <code class="docutils literal notranslate"><span class="pre">reshape_1</span></code> has
an output tensor with <code class="docutils literal notranslate"><span class="pre">rank</span> <span class="pre">&gt;=</span> <span class="pre">6</span></code>, and <code class="docutils literal notranslate"><span class="pre">reshape_2</span></code> produces a tensor with <code class="docutils literal notranslate"><span class="pre">rank</span> <span class="pre">&lt;=</span> <span class="pre">5</span></code>.</p>
<p>In general, we can expand this pattern into a sequence of rank 4 <code class="docutils literal notranslate"><span class="pre">reshape</span></code> and <code class="docutils literal notranslate"><span class="pre">transpose</span></code> ops,
which is supported by the Core ML runtime.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">d4</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">dn</span><span class="p">))</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">(</span><span class="n">p1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">pn</span><span class="p">))</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span> <span class="n">o3</span><span class="p">,</span> <span class="n">o4</span><span class="p">,</span> <span class="n">o5</span><span class="p">))</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="o">%</span><span class="n">t1</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="n">x</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">y11</span><span class="p">,</span> <span class="n">y12</span><span class="p">,</span> <span class="n">y13</span><span class="p">,</span> <span class="n">y14</span><span class="p">))</span>
    <span class="o">%</span><span class="n">h1</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="n">t1</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="o">%</span><span class="n">t2</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="n">h1</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">y21</span><span class="p">,</span> <span class="n">y22</span><span class="p">,</span> <span class="n">y23</span><span class="p">,</span> <span class="mi">214</span><span class="p">))</span>
    <span class="o">%</span><span class="n">h2</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="n">t2</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="o">....</span>
    <span class="o">%</span><span class="n">hn</span> <span class="o">=</span> <span class="n">transpose</span><span class="p">(</span><span class="o">%</span><span class="n">tn</span><span class="p">,</span> <span class="n">perm</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">])</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="n">hn</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">o1</span><span class="p">,</span> <span class="n">o2</span><span class="p">,</span> <span class="n">o3</span><span class="p">,</span> <span class="n">o4</span><span class="p">,</span> <span class="n">o5</span><span class="p">))</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.fuse_onehot_matmul_to_gather">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.</span></span><span class="sig-name descname"><span class="pre">fuse_onehot_matmul_to_gather</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_tensor_operation.html#fuse_onehot_matmul_to_gather"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.fuse_onehot_matmul_to_gather" title="Link to this definition"></a></dt>
<dd><p>Detect if <code class="docutils literal notranslate"><span class="pre">onehot</span> <span class="pre">(axis=-1,</span> <span class="pre">on_value=1,</span> <span class="pre">off_value=0)</span></code> is followed by a <code class="docutils literal notranslate"><span class="pre">matmul</span></code> op (no bias).
If so, they can be replaced by a <code class="docutils literal notranslate"><span class="pre">gather</span></code> op.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">one_hot</span><span class="p">(</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="n">on_value</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">off_value</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">const</span><span class="p">()</span> <span class="c1"># rank 2</span>
    <span class="o">%</span><span class="mi">4</span>  <span class="o">=</span> <span class="n">matmul</span><span class="p">(</span><span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="o">%</span><span class="mi">3</span><span class="p">)</span>

<span class="n">Output</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">gather</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.replace_stack_reshape">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.</span></span><span class="sig-name descname"><span class="pre">replace_stack_reshape</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_tensor_operation.html#replace_stack_reshape"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.replace_stack_reshape" title="Link to this definition"></a></dt>
<dd><p>A stack followed by a reshape layer can be replaced by a <code class="docutils literal notranslate"><span class="pre">concat</span></code> if the reshape
simply removes the new axis and doubles the size of one of the axes next to it.</p>
<p>If the new axis is reshaped to the “right” (that is, the axis just after it is
doubled), then we can use a <code class="docutils literal notranslate"><span class="pre">concat</span></code>. If it is reshaped to the “left” (the axis
just before it is doubled), then the <code class="docutils literal notranslate"><span class="pre">concat</span></code> needs to set the <code class="docutils literal notranslate"><span class="pre">interleaved</span></code> flag.</p>
<p>Examples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">stack</span><span class="p">((</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="o">%</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># shape = (1, 5, 2, 3, 4)</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">concat</span><span class="p">((</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span><span class="o">%</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">interleave</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># shape = (1, 10, 3, 4)</span>

<span class="n">Given</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">3</span> <span class="o">=</span> <span class="n">stack</span><span class="p">((</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># shape = (1, 2, 5, 3, 4)</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">reshape</span><span class="p">(</span><span class="o">%</span><span class="mi">3</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">])</span>

<span class="n">Result</span><span class="p">:</span>
    <span class="o">%</span><span class="mi">1</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">2</span> <span class="o">=</span> <span class="n">tensor</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
    <span class="o">%</span><span class="mi">4</span> <span class="o">=</span> <span class="n">concat</span><span class="p">((</span><span class="o">%</span><span class="mi">1</span><span class="p">,</span> <span class="o">%</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># shape = (1, 10, 3, 4)</span>
</pre></div>
</div>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.use_reflection_padding">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.</span></span><span class="sig-name descname"><span class="pre">use_reflection_padding</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/optimize_tensor_operation.html#use_reflection_padding"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.optimize_tensor_operation.use_reflection_padding" title="Link to this definition"></a></dt>
<dd><p>Identify a reflection padding layer composed out of <cite>slices</cite> and <cite>concats</cite>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Input</span> <span class="n">graph</span><span class="p">:</span>

        <span class="o">-------------------------------------------------------------------------------------</span> <span class="o">|</span>
        <span class="o">|</span>                                                                                     <span class="n">v</span>
<span class="nb">input</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">------&gt;</span> <span class="n">slice_by_index</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">-----&gt;</span> <span class="n">concat</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span> <span class="o">---&gt;</span> <span class="n">out</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="o">|</span>                                                                                     <span class="o">^</span>
        <span class="o">----------------&gt;</span> <span class="n">slice_by_index</span><span class="p">(</span><span class="n">begin</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="n">end</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-------------|</span>

<span class="n">Output</span> <span class="n">graph</span><span class="p">:</span>

<span class="nb">input</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-----</span><span class="mi">0</span><span class="o">&gt;</span> <span class="n">pad</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="n">reflect</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">-----&gt;</span> <span class="n">out</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.preprocess">
<span id="preprocess"></span><h2>preprocess<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.preprocess" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.preprocess.image_input_preprocess">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.preprocess.</span></span><span class="sig-name descname"><span class="pre">image_input_preprocess</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/preprocess.html#image_input_preprocess"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.preprocess.image_input_preprocess" title="Link to this definition"></a></dt>
<dd><p>Plug in to <code class="docutils literal notranslate"><span class="pre">transpose</span></code> image input in NHWC format to NCHW format.</p>
<p>Follow these steps:</p>
<ol class="arabic">
<li><p>Check whether there are any inputs that the users specify as ImageType.</p></li>
<li><p>Check the channel’s dimension for all inputs that are ImageType.</p>
<blockquote>
<div><ol class="loweralpha simple">
<li><p><code class="docutils literal notranslate"><span class="pre">channel_first</span> <span class="pre">==</span> <span class="pre">True</span></code>
We do not modify this input, since <code class="docutils literal notranslate"><span class="pre">channel_first</span></code> is the intended
behaviour for feeding images for optimal performance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">channel_first</span> <span class="pre">==</span> <span class="pre">False</span></code>
We convert the input into a “channel_first” input, and plug in a
<code class="docutils literal notranslate"><span class="pre">transpose</span></code> for the input to maintain the remaining graph’s dimensionality.</p></li>
</ol>
</div></blockquote>
</li>
</ol>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.preprocess.sanitize_input_output_names">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.preprocess.</span></span><span class="sig-name descname"><span class="pre">sanitize_input_output_names</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/preprocess.html#sanitize_input_output_names"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.preprocess.sanitize_input_output_names" title="Link to this definition"></a></dt>
<dd><p>Sanitize the names of model input and output vars to make sure
that they are of the format as described in the NameSanitizer class; that is,
of the format <code class="docutils literal notranslate"><span class="pre">[a-zA-Z_][a-zA-Z0-9_]*</span></code>.</p>
</dd></dl>

<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.preprocess.update_output_dtypes">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.preprocess.</span></span><span class="sig-name descname"><span class="pre">update_output_dtypes</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/preprocess.html#update_output_dtypes"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.preprocess.update_output_dtypes" title="Link to this definition"></a></dt>
<dd><p>Update the dtypes of output vars of each function block to match the dtypes
provided in <code class="docutils literal notranslate"><span class="pre">function.output_types</span></code>. The output types for the main function
is populated by the <code class="docutils literal notranslate"><span class="pre">outputs</span></code> argument provided by the user in the <code class="docutils literal notranslate"><span class="pre">coremltools.convert()</span></code> API.
This graph pass assumes that the list of outputs in <code class="docutils literal notranslate"><span class="pre">function.output_types</span></code> (if not <code class="docutils literal notranslate"><span class="pre">None</span></code>),
are in the same order as the output vars.</p>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.quantization">
<span id="quantization"></span><h2>quantization<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.quantization" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.quantization.add_fp16_cast">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.quantization.</span></span><span class="sig-name descname"><span class="pre">add_fp16_cast</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">op_selector</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/quantization.html#add_fp16_cast"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.quantization.add_fp16_cast" title="Link to this definition"></a></dt>
<dd><p>For each input of dtype float32, inject a <code class="docutils literal notranslate"><span class="pre">cast</span></code> op to change it to float16 dtype.</p>
<p>For each output of dtype float16, inject a <code class="docutils literal notranslate"><span class="pre">cast</span></code> op to change it back to float32.</p>
<p>This pass is the registered interface for FP16ComputePrecision, which makes it consistent with
other passes’ interfaces.</p>
<p>Support options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">skip_ops_by_type</span></code>: Skip op types specified by comma-separated string; for example, <code class="docutils literal notranslate"><span class="pre">&quot;mul,const&quot;</span></code>.</p></li>
</ul>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.symbol_transform">
<span id="symbol-transform"></span><h2>symbol_transform<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.symbol_transform" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.symbol_transform.materialize_symbolic_shape_program">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.symbol_transform.</span></span><span class="sig-name descname"><span class="pre">materialize_symbolic_shape_program</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/symbol_transform.html#materialize_symbolic_shape_program"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.symbol_transform.materialize_symbolic_shape_program" title="Link to this definition"></a></dt>
<dd><p>If we realize that only a few fixed shapes are used in a symbolic-shape model,
we may prefer materialization into a fixed-shape (multifunction) model,
which has the potential to be further optimized</p>
<p>Supported options:</p>
<ul class="simple">
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">function_name_to_materialization_map</span></code>: Dict[str, Dict[str, Tuple[int]]]</dt><dd><p>A dictionary specifying the name of new functions to be created,
and for each new function what is the new fixed shapes for inputs.
If a new function has the same name as an old function,
then the old function will be overridden</p>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt><code class="docutils literal notranslate"><span class="pre">source_function_name</span></code>: str</dt><dd><p>The name of the source symbolic-shape function to be materialized, default = main</p>
</dd>
</dl>
</li>
</ul>
<p>Example:</p>
<p>Suppose we have a symbolic shape model with 2 symbols <code class="docutils literal notranslate"><span class="pre">is0</span></code> and <code class="docutils literal notranslate"><span class="pre">is1</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">symbolic_shape_mlmodel</span><span class="p">:</span> <span class="n">ct</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">MLModel</span>
<span class="n">symbolic_shape_prog</span> <span class="o">=</span> <span class="n">symbolic_shape_mlmodel</span><span class="o">.</span><span class="n">_mil_program</span>
</pre></div>
</div>
<p>We may invoke this graph pass to materialize some fixed shapes (e.g. <code class="docutils literal notranslate"><span class="pre">is0</span> <span class="pre">=</span> <span class="pre">2,</span> <span class="pre">is1</span> <span class="pre">=</span> <span class="pre">5</span></code>
and <code class="docutils literal notranslate"><span class="pre">is0</span> <span class="pre">=</span> <span class="pre">4,</span> <span class="pre">is1</span> <span class="pre">=</span> <span class="pre">7</span></code>), then run every other optimization passes</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pass_pipeline</span><span class="p">:</span> <span class="n">PassPipeline</span> <span class="o">=</span> <span class="n">ct</span><span class="o">.</span><span class="n">PassPipeline</span><span class="o">.</span><span class="n">DEFAULT</span>
<span class="n">pass_pipeline</span><span class="o">.</span><span class="n">insert_pass</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;common::materialize_symbolic_shape_program&quot;</span><span class="p">)</span>
<span class="n">pass_pipeline</span><span class="o">.</span><span class="n">set_options</span><span class="p">(</span>
    <span class="s2">&quot;common::materialize_symbolic_shape_program&quot;</span><span class="p">,</span>
    <span class="p">{</span>
        <span class="s2">&quot;function_name_to_materialization_map&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="c1"># As an example, let us assume the input is x (is0, is1, 1024)</span>
            <span class="s2">&quot;materialization_2_5&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)},</span>
            <span class="s2">&quot;materialization_4_7&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1024</span><span class="p">)},</span>
        <span class="p">}</span>
    <span class="p">},</span>
<span class="p">)</span>
<span class="n">PassPipelineManager</span><span class="o">.</span><span class="n">apply_pipeline</span><span class="p">(</span><span class="n">symbolic_shape_prog</span><span class="p">,</span> <span class="n">pass_pipeline</span><span class="p">)</span>
</pre></div>
</div>
<p>We will arrive at</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">main</span><span class="p">[</span><span class="n">CoreML8</span><span class="p">](</span><span class="o">%</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">is0</span><span class="p">,</span> <span class="n">is1</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">fp16</span><span class="p">)(</span><span class="n">Tensor</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">block0</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">y</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">materialization_2_5</span><span class="p">[</span><span class="n">CoreML8</span><span class="p">](</span><span class="o">%</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">fp16</span><span class="p">)(</span><span class="n">Tensor</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">block5</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">y</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">materialization_4_7</span><span class="p">[</span><span class="n">CoreML8</span><span class="p">](</span><span class="o">%</span><span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">fp16</span><span class="p">)(</span><span class="n">Tensor</span><span class="p">))</span> <span class="p">{</span>
  <span class="n">block6</span><span class="p">()</span> <span class="p">{</span>
    <span class="o">...</span>
  <span class="p">}</span> <span class="o">-&gt;</span> <span class="p">(</span><span class="o">%</span><span class="n">y</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</dd></dl>

</section>
<section id="module-coremltools.converters.mil.mil.passes.defs.transformer">
<span id="transformer"></span><h2>transformer<a class="headerlink" href="#module-coremltools.converters.mil.mil.passes.defs.transformer" title="Link to this heading"></a></h2>
<dl class="py class">
<dt class="sig sig-object py" id="coremltools.converters.mil.mil.passes.defs.transformer.scaled_dot_product_attention_sliced_q">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">coremltools.converters.mil.mil.passes.defs.transformer.</span></span><span class="sig-name descname"><span class="pre">scaled_dot_product_attention_sliced_q</span></span><a class="reference internal" href="../_modules/coremltools/converters/mil/mil/passes/defs/transformer.html#scaled_dot_product_attention_sliced_q"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#coremltools.converters.mil.mil.passes.defs.transformer.scaled_dot_product_attention_sliced_q" title="Link to this definition"></a></dt>
<dd><p>Replace the ios18.scaled_dot_product_attention operation with a memory efficient
implementation of attention calculation based on slicing Q. The benefits are clearly
visible for higher Q sequence lengths, though.</p>
<dl class="simple">
<dt>Graph pass options:</dt><dd><ul class="simple">
<li><p>min_seq_length: int
Only operations working with Q of sequence length greater or equal to this value will be transformed.</p></li>
<li><p>seq_length_divider: int
Defines the size of the chunks of Q being processed in SDPA (chunk_size = seq_length / seq_length_divider)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="coremltools.converters.mil.mil.ops.defs.html" class="btn btn-neutral float-left" title="MIL Ops" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="coremltools.optimize.html" class="btn btn-neutral float-right" title="Optimizers" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Apple Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>