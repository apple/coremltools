

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>coremltools.models.ml_program.experimental.remote_device &mdash; coremltools API Reference 8.1 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/graphviz.css?v=fd3f3429" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/sg_gallery.css?v=d2d258e8" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/sg_gallery-binder.css?v=f4aeca0c" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/sg_gallery-dataframe.css?v=2082cf3c" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/sg_gallery-rendered-html.css?v=1277b6f3" />
      <link rel="stylesheet" type="text/css" href="../../../../../_static/css/norightmargin.css?v=eea1f72d" />

  
      <script src="../../../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../../../_static/documentation_options.js?v=1f41a3ab"></script>
      <script src="../../../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../../index.html" class="icon icon-home">
            coremltools API Reference
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">API Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/coremltools.converters.html">Converters</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/coremltools.models.html">Model APIs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/coremltools.converters.mil.html">MIL Builder</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/coremltools.converters.mil.input_types.html">MIL Input Types</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/coremltools.converters.mil.mil.ops.defs.html">MIL Ops</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/coremltools.converters.mil.mil.passes.defs.html">MIL Graph Passes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/coremltools.optimize.html">Optimizers</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Resources</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://apple.github.io/coremltools/docs-guides/index.html">Guide and Examples</a></li>
<li class="toctree-l1"><a class="reference external" href="https://apple.github.io/coremltools/mlmodel/index.html">Core ML Format Specification</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../../source/api-versions.html">Previous Versions</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apple/coremltools">GitHub</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../../index.html">coremltools API Reference</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">coremltools.models.ml_program.experimental.remote_device</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for coremltools.models.ml_program.experimental.remote_device</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2025, Apple Inc. All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Use of this source code is governed by a BSD-3-clause license that can be</span>
<span class="c1"># found in the LICENSE.txt file or at https://opensource.org/licenses/BSD-3-Clause</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">shutil</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_shutil</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">subprocess</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_subprocess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tempfile</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_tempfile</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_uuid</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span> <span class="k">as</span> <span class="n">_ABC</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">abstractmethod</span> <span class="k">as</span> <span class="n">_abstractmethod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapping</span> <span class="k">as</span> <span class="n">_Mapping</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections.abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">Sequence</span> <span class="k">as</span> <span class="n">_Sequence</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span> <span class="k">as</span> <span class="n">_dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span> <span class="k">as</span> <span class="n">_Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span> <span class="k">as</span> <span class="n">_Path</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span> <span class="k">as</span> <span class="n">_Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">BinaryIO</span> <span class="k">as</span> <span class="n">_BinaryIO</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span> <span class="k">as</span> <span class="n">_Dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span> <span class="k">as</span> <span class="n">_List</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span> <span class="k">as</span> <span class="n">_Optional</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Tuple</span> <span class="k">as</span> <span class="n">_Tuple</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span> <span class="k">as</span> <span class="n">_Type</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span> <span class="k">as</span> <span class="n">_Union</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">tqdm</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">_tqdm</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">coremltools</span><span class="w"> </span><span class="kn">import</span> <span class="n">ComputeUnit</span> <span class="k">as</span> <span class="n">_ComputeUnit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">coremltools</span><span class="w"> </span><span class="kn">import</span> <span class="n">_logger</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.model_structure_path</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelStructurePath</span>


<div class="viewcode-block" id="AppSigningCredentials">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.AppSigningCredentials">[docs]</a>
<span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">AppSigningCredentials</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the credentials required for signing an iOS application.</span>

<span class="sd">    This class encapsulates the essential information needed for code signing an iOS app,</span>
<span class="sd">    including the development team identifier and optionally the bundle identifier.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    development_team : Optional[str]</span>
<span class="sd">        The development team identifier associated with the Apple Developer account.</span>

<span class="sd">    provisioning_profile_uuid : Optional[str]</span>
<span class="sd">        The UUID of the provisioning profile. This is used to specify which provisioning</span>
<span class="sd">        profile should be applied during the code-signing process.</span>

<span class="sd">    bundle_identifier : Optional[str]</span>
<span class="sd">        The bundle identifier for the application. This is an optional parameter that, if provided,</span>
<span class="sd">        should be in the format of a reverse domain name (e.g., &quot;com.example.app&quot;). If None, the</span>
<span class="sd">        bundle identifier from the project&#39;s settings will be used.</span>

<span class="sd">    Notes</span>
<span class="sd">    -----</span>
<span class="sd">       Either ``provisioning_profile_uuid`` or ``development_team`` must be provided:</span>
<span class="sd">        - If ``provisioning_profile_uuid`` is provided, then ``bundle_identifier`` must match</span>
<span class="sd">          the one defined in the provisioning profile.</span>

<span class="sd">        - If ``development_team`` is provided, Xcode will automatically create and manage</span>
<span class="sd">          a provisioning profile during the build process.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">development_team</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">provisioning_profile_uuid</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">bundle_identifier</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="DeviceType">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.DeviceType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DeviceType</span><span class="p">(</span><span class="n">_Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enumeration of device types.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    MAC : str</span>
<span class="sd">       Represents a Mac device.</span>

<span class="sd">    IPHONE : str</span>
<span class="sd">       Represents an iPhone device.</span>

<span class="sd">    IPAD : str</span>
<span class="sd">       Represents an iPad device</span>

<span class="sd">    APPLETV : str</span>
<span class="sd">       Represents an Apple TV device.</span>

<span class="sd">    WATCH : str</span>
<span class="sd">       Represents an Apple Watch device.</span>

<span class="sd">    HOMEPOD : str</span>
<span class="sd">       Represents a HomePod device.</span>

<span class="sd">    UNKNOWN : str</span>
<span class="sd">        Represents an unknown device type.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">MAC</span> <span class="o">=</span> <span class="s2">&quot;mac&quot;</span>
    <span class="n">IPHONE</span> <span class="o">=</span> <span class="s2">&quot;iphone&quot;</span>
    <span class="n">IPAD</span> <span class="o">=</span> <span class="s2">&quot;ipad&quot;</span>
    <span class="n">APPLETV</span> <span class="o">=</span> <span class="s2">&quot;apppletv&quot;</span>
    <span class="n">WATCH</span> <span class="o">=</span> <span class="s2">&quot;applewatch&quot;</span>
    <span class="n">HOMEPOD</span> <span class="o">=</span> <span class="s2">&quot;homepod&quot;</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_missing_</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">UNKNOWN</span></div>



<div class="viewcode-block" id="DeviceState">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.DeviceState">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DeviceState</span><span class="p">(</span><span class="n">_Enum</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Enumeration of device states.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    CONNECTING : str</span>
<span class="sd">        The device is connecting.</span>

<span class="sd">    CONNECTED : str</span>
<span class="sd">        The device is connected.</span>

<span class="sd">    AVAILABLE : str</span>
<span class="sd">        The device is available for use.</span>

<span class="sd">    UNAVAILABLE : str</span>
<span class="sd">        The device is not available for use.</span>

<span class="sd">    DISCONNECTED :str</span>
<span class="sd">        The device is disconnected.</span>

<span class="sd">    UNKNOWN : str</span>
<span class="sd">        Represents an unknown device state.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">CONNECTING</span> <span class="o">=</span> <span class="s2">&quot;connecting&quot;</span>
    <span class="n">CONNECTED</span> <span class="o">=</span> <span class="s2">&quot;connected&quot;</span>
    <span class="n">AVAILABLE</span> <span class="o">=</span> <span class="s2">&quot;available&quot;</span>
    <span class="n">UNAVAILABLE</span> <span class="o">=</span> <span class="s2">&quot;unavailable&quot;</span>
    <span class="n">DISCONNECTED</span> <span class="o">=</span> <span class="s2">&quot;disconnected&quot;</span>
    <span class="n">UNKNOWN</span> <span class="o">=</span> <span class="s2">&quot;unknown&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_missing_</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DeviceState</span><span class="o">.</span><span class="n">UNKNOWN</span></div>



<div class="viewcode-block" id="Device">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.Device">[docs]</a>
<span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">Device</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a device.</span>

<span class="sd">    Attributes</span>
<span class="sd">    -----------</span>
<span class="sd">    name : str</span>
<span class="sd">        The name of the device.</span>

<span class="sd">    type : DeviceType</span>
<span class="sd">        The type of the device.</span>

<span class="sd">    identifier : str</span>
<span class="sd">        A unique identifier for the device.</span>

<span class="sd">    udid : str</span>
<span class="sd">        The device identifier.</span>

<span class="sd">    os_version : str</span>
<span class="sd">        The operating system version of the device.</span>

<span class="sd">    os_build_number : str</span>
<span class="sd">        The build number of the os.</span>

<span class="sd">    developer_mode_state : str</span>
<span class="sd">        The state of developer mode on the device.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">type</span><span class="p">:</span> <span class="n">DeviceType</span>
    <span class="n">identifier</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">udid</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">os_version</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">os_build_number</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">developer_mode_state</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">DeviceState</span>
    <span class="n">session</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;_AppSession&quot;</span><span class="p">]]</span>

<div class="viewcode-block" id="Device.get_devices">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.Device.get_devices">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_devices</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_List</span><span class="p">[</span><span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;Device&quot;</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a list of available devices.</span>

<span class="sd">        This method fetches and returns a list of all accessible devices</span>
<span class="sd">        using the DeviceCtl utility.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[Device]</span>
<span class="sd">            A list of Device objects representing the available devices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span></div>


<div class="viewcode-block" id="Device.get_connected_devices">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.Device.get_connected_devices">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_connected_devices</span><span class="p">(</span><span class="n">device_type</span><span class="p">:</span> <span class="n">DeviceType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_List</span><span class="p">[</span><span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;Device&quot;</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a list of connected devices of a specified type.</span>

<span class="sd">        This function uses the DeviceCtl utility to fetch all accessible devices and filters them</span>
<span class="sd">        based on the following criteria:</span>
<span class="sd">        1. The device is in a connected state</span>
<span class="sd">        2. The device matches the specified device_type</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device_type : DeviceType</span>
<span class="sd">            The type of device to filter for (e.g., iPhone, iPad, Apple TV).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[Device]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">is_device_connected</span><span class="p">(</span><span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">device</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">DeviceState</span><span class="o">.</span><span class="n">CONNECTED</span> <span class="ow">and</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">device_type</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">device</span> <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">Device</span><span class="o">.</span><span class="n">get_devices</span><span class="p">()</span> <span class="k">if</span> <span class="n">is_device_connected</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)]</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_install_and_launch_app</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">app_path</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">working_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;_AppSession&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Install and launch an application on the device.</span>

<span class="sd">         This method takes the path to an application, installs it on the device</span>
<span class="sd">         associated with this instance, and then launches the application.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">         app_path : Path</span>
<span class="sd">             The path to the application file or directory to be installed.</span>
<span class="sd">             This should be a valid path object pointing to the app bundle.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AppSession</span>
<span class="sd">             An AppSession object representing the launched application session.</span>
<span class="sd">             This object typically contains:</span>
<span class="sd">             - process: The subprocess object for the running application.</span>
<span class="sd">             - device: The Device object on which the app was installed and launched.</span>
<span class="sd">             - bundle_identifier: The bundle ID of the installed and launched application.</span>
<span class="sd">             - database_uuid: The database UUID of the installed application.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">install_and_launch_app</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">app_path</span><span class="o">=</span><span class="n">app_path</span><span class="p">,</span>
            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_launch_app</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">app_path</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">working_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;_AppSession&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">         Install and launch an application on the device.</span>

<span class="sd">         This method takes the path to an application, installs it on the device</span>
<span class="sd">         associated with this instance, and then launches the application.</span>

<span class="sd">         Parameters</span>
<span class="sd">         ----------</span>
<span class="sd">         app_path : Path</span>
<span class="sd">             The path to the application file or directory to be installed.</span>
<span class="sd">             This should be a valid path object pointing to the app bundle.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AppSession</span>
<span class="sd">             An AppSession object representing the launched application session.</span>
<span class="sd">             This object typically contains:</span>
<span class="sd">             - process: The subprocess object for the running application.</span>
<span class="sd">             - device: The Device object on which the app was installed and launched.</span>
<span class="sd">             - bundle_identifier: The bundle ID of the installed and launched application.</span>
<span class="sd">             - database_uuid: The database UUID of the installed application.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">launch_app</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">app_path</span><span class="o">=</span><span class="n">app_path</span><span class="p">,</span>
            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_build_and_launch_model_runner_app</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">build_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">working_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">AppSigningCredentials</span> <span class="o">=</span> <span class="n">AppSigningCredentials</span><span class="p">(),</span>
        <span class="n">clean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;_AppSession&quot;</span><span class="p">]:</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">command_exists</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check if a command exists in the system&#39;s PATH.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">_shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">command_exists</span><span class="p">(</span><span class="s2">&quot;xcodebuild&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;xcodebuild&#39; command is required. Please ensure that Xcode Command Line Tools are installed and accessible.&quot;</span>
            <span class="p">)</span>

        <span class="n">app_path</span> <span class="o">=</span> <span class="n">_ModelRunnerAppBuilder</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">build_directory</span><span class="o">=</span><span class="n">build_directory</span><span class="p">,</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">clean</span><span class="o">=</span><span class="n">clean</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_install_and_launch_app</span><span class="p">(</span>
            <span class="n">app_path</span><span class="o">=</span><span class="n">app_path</span><span class="p">,</span>
            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Device.prepare_for_model_debugging">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.Device.prepare_for_model_debugging">[docs]</a>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">prepare_for_model_debugging</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">AppSigningCredentials</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">working_directory</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">clean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;Device&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prepares the device for model debugging by building and launching the model runner app.</span>

<span class="sd">        This method checks if the device is in the correct state for debugging, sets up the working</span>
<span class="sd">        directory, builds the ``modelrunner`` application, and launches it on the device.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        credentials : Optional[AppSigningCredentials</span>
<span class="sd">            The credentials required for signing ``modelrunner`` application.</span>

<span class="sd">        working_directory: Optional[Path]</span>
<span class="sd">            The directory utilized for storing files required for building and communicating</span>
<span class="sd">            with the ``modelrunner`` application. If None, a temporary director will be created.</span>
<span class="sd">            Defaults to None.</span>

<span class="sd">        clean : bool</span>
<span class="sd">            If True, performs a clean build. Defaults to False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Device</span>
<span class="sd">            A new Device instance with the prepared session.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">report_progress</span><span class="p">(</span>
            <span class="n">future</span><span class="p">:</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">,</span>
            <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
            <span class="n">delay</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">with</span> <span class="n">_tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span><span class="n">desc</span><span class="o">=</span><span class="n">message</span><span class="p">,</span> <span class="n">bar_format</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1m</span><span class="si">{desc}</span><span class="s2"> </span><span class="si">{elapsed}</span><span class="s2">s</span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
                <span class="k">while</span> <span class="ow">not</span> <span class="n">future</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="k">await</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">)</span>
                    <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">DeviceState</span><span class="o">.</span><span class="n">CONNECTED</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The device cannot be used for model debugging. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;Current state: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">. &quot;</span>
                <span class="s2">&quot;Required: State must be CONNECTED.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">working_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">working_directory</span> <span class="o">=</span> <span class="n">_tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">working_directory</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">working_directory</span> <span class="o">=</span> <span class="n">_Path</span><span class="p">(</span><span class="n">working_directory</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">working_directory</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The specified working directory &#39;</span><span class="si">{</span><span class="n">working_directory</span><span class="si">}</span><span class="s2">&#39; is invalid. Please ensure it exists and is a directory.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">credentials</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">credentials</span> <span class="o">=</span> <span class="n">AppSigningCredentials</span><span class="p">(</span>
                <span class="n">development_team</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="n">bundle_identifier</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">provisioning_profile_uuid</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">build_directory</span> <span class="o">=</span> <span class="n">working_directory</span> <span class="o">/</span> <span class="s2">&quot;build&quot;</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

        <span class="n">session_future</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_build_and_launch_model_runner_app</span><span class="p">,</span>
            <span class="n">working_directory</span><span class="p">,</span>
            <span class="n">build_directory</span><span class="p">,</span>
            <span class="n">credentials</span><span class="p">,</span>
            <span class="n">clean</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">progress_task</span> <span class="o">=</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
            <span class="n">report_progress</span><span class="p">(</span>
                <span class="n">future</span><span class="o">=</span><span class="n">session_future</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Setting up &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; for model debugging. This may take a few moments...&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">session</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="k">await</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="n">session_future</span><span class="p">,</span> <span class="n">progress_task</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">progress_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>  <span class="c1"># Ensure progress task is cancelled</span>

        <span class="k">return</span> <span class="n">Device</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="nb">type</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
            <span class="n">identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span>
            <span class="n">udid</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">udid</span><span class="p">,</span>
            <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span>
            <span class="n">os_version</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">os_version</span><span class="p">,</span>
            <span class="n">os_build_number</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">os_build_number</span><span class="p">,</span>
            <span class="n">developer_mode_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">developer_mode_state</span><span class="p">,</span>
            <span class="n">session</span><span class="o">=</span><span class="n">session</span><span class="p">,</span>
        <span class="p">)</span></div>
</div>


<span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_DataTransferInfo</span><span class="p">:</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span>


<span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_AppInstallationInfo</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents the result of an application installation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">bundle_identifier</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">database_uuid</span><span class="p">:</span> <span class="nb">str</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_AppSession</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a session for an application running on a device.</span>

<span class="sd">    This class manages the lifecycle of an application session, including</span>
<span class="sd">    file transfers to and from the application.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">process</span><span class="p">:</span> <span class="n">_subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">,</span>
        <span class="n">installation_info</span><span class="p">:</span> <span class="n">_AppInstallationInfo</span><span class="p">,</span>
        <span class="n">working_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize an AppSession.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device : Device</span>
<span class="sd">            The device on which the application is running.</span>

<span class="sd">        process : subprocess.Popen</span>
<span class="sd">            The subprocess representing the launched application.</span>

<span class="sd">        installation_info : str</span>
<span class="sd">            The application installation info.</span>

<span class="sd">        working_directory: Path</span>
<span class="sd">            The directory utilized for storing files required for communication.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AppSession</span>
<span class="sd">            An AppSession object representing the running instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">installation_info</span> <span class="o">=</span> <span class="n">installation_info</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span> <span class="o">=</span> <span class="n">process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">working_directory</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the application session.</span>

<span class="sd">        This method terminates the subprocess associated with the application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the application session is still active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool:</span>
<span class="sd">            True if the application is still running, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">poll</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_process</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">poll</span> <span class="ow">is</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bundle_identifier</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Bundle identifier of the application.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str:</span>
<span class="sd">           Returns the bundle identifier of the application.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">installation_info</span><span class="o">.</span><span class="n">bundle_identifier</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send_file_to_app</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">source_path</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_DataTransferInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a file to the application on the device.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        source_path : Path</span>
<span class="sd">            The path to the file to be sent.</span>

<span class="sd">        destination : str</span>
<span class="sd">            The destination path within the application&#39;s sandbox.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataTransferInfo</span>
<span class="sd">            Information about the file transfer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">send_file_to_app</span><span class="p">(</span>
            <span class="n">bundle_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_identifier</span><span class="p">,</span>
            <span class="n">source_path</span><span class="o">=</span><span class="n">source_path</span><span class="p">,</span>
            <span class="n">destination</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">receive_file_from_app</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">destination_path</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_DataTransferInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive a file from the application on the device.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        destination_path : Path</span>
<span class="sd">            The path where the received file will be saved.</span>

<span class="sd">        source : str</span>
<span class="sd">            The source path of the file within the application&#39;s sandbox.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataTransferInfo</span>
<span class="sd">            Information about the file transfer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">receive_file_from_app</span><span class="p">(</span>
            <span class="n">bundle_identifier</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bundle_identifier</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">destination_path</span><span class="o">=</span><span class="n">destination_path</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
        <span class="p">)</span>

<span class="k">class</span><span class="w"> </span><span class="nc">_DeviceCtlError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Custom exception for device ctl errors.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[Error Code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">error_code</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_DeviceCtl</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The DeviceCtl class provides a set of methods to perform various operations</span>
<span class="sd">    on devices, such as listing connected devices, installing and launching applications,</span>
<span class="sd">    transferring files, and more. It serves as a high-level interface to the &#39;xcrun devicectl&#39;</span>
<span class="sd">    and related command-line tools.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_validation_done</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate</span><span class="p">():</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">command_exists</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check if a command exists in the system&#39;s PATH.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">_shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform validation checks.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_validation_done</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">command_exists</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="s2">&quot;devicectl&quot;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;The &#39;devicectl&#39; command is required. Please ensure that you have the latest version of Xcode Command Line Tools installed.&quot;</span>
                <span class="p">)</span>
        <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_validation_done</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_run_command</span><span class="p">(</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">]:</span>
        <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_validate</span><span class="p">()</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing devicectl command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">_tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">()</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">bytes</span><span class="p">())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">_subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> -j </span><span class="si">{</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">stdout</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                    <span class="n">stderr</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                    <span class="n">stdin</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">output</span><span class="o">.</span><span class="n">check_returncode</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">_subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span>
                    <span class="n">error_code</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
                    <span class="n">message</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">as</span> <span class="n">json_data</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">_json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_run_command_async</span><span class="p">(</span>
        <span class="n">command</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">:</span>
        <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_validate</span><span class="p">()</span>
        <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing devicectl command: </span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span>
            <span class="n">command</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stdin</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_check_tools</span><span class="p">():</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">command_exists</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check if a command exists in the system&#39;s PATH.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">_shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">command_exists</span><span class="p">(</span><span class="s2">&quot;devicectl&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;devicectl&#39; command is required. Please ensure that you have the latest version of Xcode Command Line Tools installed.&quot;</span>
            <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">install_app</span><span class="p">(</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">app_path</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AppInstallationInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Install an application on the specified device.</span>

<span class="sd">        This method attempts to install an application on the given device using the</span>
<span class="sd">        &#39;xcrun devicectl&#39; command-line tool. It parses the installation result and</span>
<span class="sd">        returns information about the installed application.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device: Device</span>
<span class="sd">            The target device on which to install the application.</span>

<span class="sd">        app_path: Path</span>
<span class="sd">            The path to the application file (.ipa or .app) to be installed. This should</span>
<span class="sd">            be a Path object pointing to a valid application file.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AppInstallationInfo</span>
<span class="sd">            If successful, returns an AppInstallationInfo object containing:</span>
<span class="sd">            - bundle_identifier: The bundle ID of the installed application.</span>
<span class="sd">            - database_uuid: The database UUID assigned to the installed application.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_run_command</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;xcrun devicectl device install app -d </span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">app_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;App installation failed: No result data returned&quot;</span><span class="p">)</span>

        <span class="n">installed_applications</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;installedApplications&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">installed_applications</span><span class="p">,</span> <span class="n">_Sequence</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;App installation failed: Invalid installed applications data&quot;</span><span class="p">)</span>

        <span class="n">installed_application</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">installed_applications</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">installed_application</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;App installation failed: No applications were installed&quot;</span><span class="p">)</span>

        <span class="n">bundle_identifier</span> <span class="o">=</span> <span class="n">installed_application</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bundleID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">database_uuid</span> <span class="o">=</span> <span class="n">installed_application</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;databaseUUID&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_AppInstallationInfo</span><span class="p">(</span>
            <span class="n">bundle_identifier</span><span class="o">=</span><span class="n">bundle_identifier</span><span class="p">,</span>
            <span class="n">database_uuid</span><span class="o">=</span><span class="n">database_uuid</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">launch_app</span><span class="p">(</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">installation_info</span><span class="p">:</span> <span class="n">_AppInstallationInfo</span><span class="p">,</span>
        <span class="n">working_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AppSession</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Launch an installed application on the specified device and create a DeviceSession.</span>

<span class="sd">        This method launches an application that has been previously installed on the device</span>
<span class="sd">        using the &#39;xcrun devicectl&#39; command-line tool. It starts the app in console mode and</span>
<span class="sd">        returns a DeviceSession object representing the running application session.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device: Device</span>
<span class="sd">            The target device on which to launch the application.</span>

<span class="sd">        installation_info : AppInstallationInfo</span>
<span class="sd">            The result of a previous app installation, containing the bundle identifier</span>
<span class="sd">            and database UUID of the installed application.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AppSession:</span>
<span class="sd">            An AppSession object representing the launched application session. This object contains:</span>
<span class="sd">            - process: The subprocess object for the running &#39;xcrun devicectl&#39; command.</span>
<span class="sd">            - device: The Device on which the app was launched.</span>
<span class="sd">            - bundle_identifier: The bundle ID of the launched application.</span>
<span class="sd">            - database_uuid: The database UUID of the launched application.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_run_command_async</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;xcrun devicectl device process launch --console -d </span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">installation_info</span><span class="o">.</span><span class="n">bundle_identifier</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">_AppSession</span><span class="p">(</span>
            <span class="n">process</span><span class="o">=</span><span class="n">process</span><span class="p">,</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">installation_info</span><span class="o">=</span><span class="n">installation_info</span><span class="p">,</span>
            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">install_and_launch_app</span><span class="p">(</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">app_path</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">working_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_AppSession</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Install and launch an application on the specified device in a single operation.</span>

<span class="sd">        This method combines the process of installing an application and launching it</span>
<span class="sd">        on the target device. It first installs the app using the provided app path,</span>
<span class="sd">        and then immediately launches the newly installed application.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device : Device</span>
<span class="sd">            The target device on which to install and launch the application.</span>

<span class="sd">        app_path : Path</span>
<span class="sd">            The path to the application file (.ipa or .app) to be installed.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _AppSession:</span>
<span class="sd">            An _AppSession object representing the launched application session.</span>
<span class="sd">            This object typically contains:</span>
<span class="sd">            - process: The subprocess object for the running application.</span>
<span class="sd">            - device: The Device object on which the app was installed and launched.</span>
<span class="sd">            - bundle_identifier: The bundle ID of the installed and launched application.</span>
<span class="sd">            - database_uuid: The database UUID of the installed application.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">installation_info</span> <span class="o">=</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">install_app</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">app_path</span><span class="o">=</span><span class="n">app_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">launch_app</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">installation_info</span><span class="o">=</span><span class="n">installation_info</span><span class="p">,</span>
            <span class="n">working_directory</span><span class="o">=</span><span class="n">working_directory</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_data_transfer_result</span><span class="p">(</span>
        <span class="n">json_data</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_DataTransferInfo</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;No &#39;result&#39; field in the JSON data&quot;</span><span class="p">)</span>

        <span class="n">source</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;No &#39;source&#39; field in the result data&quot;</span><span class="p">)</span>

        <span class="n">destination</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;destination&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">destination</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;No &#39;destination&#39; field in the result data&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">_DataTransferInfo</span><span class="p">(</span>
            <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
            <span class="n">destination</span><span class="o">=</span><span class="n">destination</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send_file_to_app</span><span class="p">(</span>
        <span class="n">bundle_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">source_path</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">destination</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_DataTransferInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a file to a specific application&#39;s data container on the target device.</span>

<span class="sd">        This method uses the &#39;devicectl&#39; command-line tool to copy a file from the host</span>
<span class="sd">        machine to an application&#39;s data container on the specified device.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bundle_identifier: str</span>
<span class="sd">            The bundle identifier of the target application on the device.</span>

<span class="sd">        source_path : Path</span>
<span class="sd">            The path to the file on the host machine that should be sent to the device.</span>
<span class="sd">            This should be a Path object pointing to an existing file.</span>

<span class="sd">        destination: str</span>
<span class="sd">            The destination path within the app&#39;s data container where the file should</span>
<span class="sd">            be copied. This is relative to the app&#39;s container root.</span>

<span class="sd">        device: Device</span>
<span class="sd">            The target device to which the file will be sent.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        _DataTransferInfo</span>
<span class="sd">            An object containing information about the completed file transfer, typically</span>
<span class="sd">            including:</span>
<span class="sd">            - source: The source path of the transferred file.</span>
<span class="sd">            - destination: The destination path of the transferred file on the device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;devicectl device copy to &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-d </span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;--source </span><span class="si">{</span><span class="n">source_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DeviceType</span><span class="o">.</span><span class="n">MAC</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;--user mobile &#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;--domain-type=appDataContainer &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;--domain-identifier=</span><span class="si">{</span><span class="n">bundle_identifier</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;--destination </span><span class="si">{</span><span class="n">destination</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_run_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_parse_data_transfer_result</span><span class="p">(</span><span class="n">json_data</span><span class="o">=</span><span class="n">json_data</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">receive_file_from_app</span><span class="p">(</span>
        <span class="n">bundle_identifier</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">destination_path</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_DataTransferInfo</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a file from a specific application&#39;s data container on the target device.</span>

<span class="sd">        This method uses the &#39;devicectl&#39; command-line tool to copy a file from an application&#39;s</span>
<span class="sd">        data container on the specified device to the host machine.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        bundle_identifier : str</span>
<span class="sd">            The bundle identifier of the source application on the device.</span>
<span class="sd">            This identifies the app&#39;s data container from which the file will be copied.</span>

<span class="sd">        source : str</span>
<span class="sd">            The source path of the file within the app&#39;s data container on the device.</span>
<span class="sd">            This path is relative to the app&#39;s container root.</span>

<span class="sd">        destination_path : Path</span>
<span class="sd">            The path on the host machine where the file should be saved.</span>
<span class="sd">            This should be a Path object pointing to the desired location for the received file.</span>

<span class="sd">        device : Device</span>
<span class="sd">            The source device from which the file will be retrieved. This object should have</span>
<span class="sd">            an &#39;identifier&#39; attribute that uniquely identifies the device.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataTransferInfo</span>
<span class="sd">            An object containing information about the completed file transfer, typically</span>
<span class="sd">            including:</span>
<span class="sd">            - source: The source path of the transferred file on the device.</span>
<span class="sd">            - destination: The destination path of the transferred file on the host machine.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;devicectl device copy from &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-d </span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">identifier</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;--source </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">DeviceType</span><span class="o">.</span><span class="n">MAC</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;--user mobile &#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;--domain-type=appDataContainer &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;--domain-identifier=</span><span class="si">{</span><span class="n">bundle_identifier</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;--destination </span><span class="si">{</span><span class="n">destination_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_run_command</span><span class="p">(</span><span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_parse_data_transfer_result</span><span class="p">(</span><span class="n">json_data</span><span class="o">=</span><span class="n">json_data</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_devices</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">_List</span><span class="p">[</span><span class="n">Device</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieve a list of all available devices connected to the host.</span>

<span class="sd">        This method uses the &#39;xcrun devicectl&#39; command-line tool to fetch information</span>
<span class="sd">        about all connected devices and parses the result to create Device objects.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List[Device]</span>
<span class="sd">            A list of Device objects, each representing a connected device.</span>
<span class="sd">            Each Device object typically contains:</span>
<span class="sd">            - name: The name of the device.</span>
<span class="sd">            - identifier: A unique identifier for the device.</span>
<span class="sd">            - os_version: The operating system version of the device.</span>
<span class="sd">            - os_build_number: The build number of the operating system.</span>
<span class="sd">            - developer_mode_state: The state of developer mode on the device.</span>
<span class="sd">            - type: The type of the device (e.g., iPhone, iPad, Mac).</span>
<span class="sd">            - state: The current state of the device (e.g., connected, available).</span>
<span class="sd">            - udid: The Unique Device Identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">_DeviceCtl</span><span class="o">.</span><span class="n">_run_command</span><span class="p">(</span><span class="s2">&quot;xcrun devicectl list devices&quot;</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">json_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;No &#39;result&#39; field in the JSON data&quot;</span><span class="p">)</span>

        <span class="n">devices</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">_Sequence</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;No &#39;devices&#39; field in the JSON data&quot;</span><span class="p">)</span>

        <span class="n">result</span><span class="p">:</span> <span class="n">_List</span><span class="p">[</span><span class="n">Device</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
            <span class="n">device_properties</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deviceProperties&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">hardware_properties</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hardwareProperties&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">connection_properties</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;connectionProperties&quot;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device_properties</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;No &#39;deviceProperties&#39; field in the JSON data&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hardware_properties</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;No &#39;hardwareProperties&#39; field in the JSON data&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">connection_properties</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="s2">&quot;No &#39;connectionProperties&#39; field in the JSON data&quot;</span><span class="p">)</span>

            <span class="nb">type</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">UNKNOWN</span>
            <span class="n">identifier</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;identifier&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="nb">type</span> <span class="o">=</span> <span class="n">DeviceType</span><span class="p">(</span><span class="n">hardware_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deviceType&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">udid</span> <span class="o">=</span> <span class="n">hardware_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;udid&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

            <span class="n">name</span> <span class="o">=</span> <span class="n">device_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">identifier</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">udid</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                <span class="ow">or</span> <span class="nb">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">UNKNOWN</span>
            <span class="p">):</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing device identifier=</span><span class="si">{</span><span class="n">identifier</span><span class="si">}</span><span class="s2"> or udid=</span><span class="si">{</span><span class="n">udid</span><span class="si">}</span><span class="s2"> or type=</span><span class="si">{</span><span class="nb">type</span><span class="si">}</span><span class="s2">, skipping.&quot;</span>
                <span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">os_version</span> <span class="o">=</span> <span class="n">device_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;osVersionNumber&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">os_build_number</span> <span class="o">=</span> <span class="n">device_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;osBuildUpdate&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">developer_mode_state</span> <span class="o">=</span> <span class="n">device_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;developerModeStatus&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">DeviceState</span><span class="o">.</span><span class="n">UNKNOWN</span>
            <span class="n">tunnel_state</span> <span class="o">=</span> <span class="n">connection_properties</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;tunnelState&quot;</span><span class="p">,</span> <span class="n">DeviceState</span><span class="o">.</span><span class="n">UNKNOWN</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">DeviceState</span><span class="p">(</span><span class="n">tunnel_state</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="n">device</span> <span class="o">=</span> <span class="n">Device</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">identifier</span><span class="o">=</span><span class="n">identifier</span><span class="p">,</span>
                <span class="n">os_version</span><span class="o">=</span><span class="n">os_version</span><span class="p">,</span>
                <span class="n">os_build_number</span><span class="o">=</span><span class="n">os_build_number</span><span class="p">,</span>
                <span class="n">developer_mode_state</span><span class="o">=</span><span class="n">developer_mode_state</span><span class="p">,</span>
                <span class="nb">type</span><span class="o">=</span><span class="nb">type</span><span class="p">,</span>
                <span class="n">state</span><span class="o">=</span><span class="n">state</span><span class="p">,</span>
                <span class="n">udid</span><span class="o">=</span><span class="n">udid</span><span class="p">,</span>
                <span class="n">session</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_AppBuilder</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A utility class for building Xcode projects for different device types.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Error</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Custom exception for build errors.&quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">error_code</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">error_code</span> <span class="o">=</span> <span class="n">error_code</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;[Error Code </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">error_code</span><span class="si">}</span><span class="s2">] </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_scheme_name</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">workspace_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the appropriate scheme name based on the workspace name and device type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        workspace_name: str</span>
<span class="sd">            The name of the Xcode workspace.</span>

<span class="sd">        device: Device</span>
<span class="sd">            The target device for which the scheme is being determined.</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        str:</span>
<span class="sd">            The scheme name to use for the build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">WATCH</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">workspace_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">-watchos&quot;</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">IPHONE</span>
            <span class="ow">or</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">IPAD</span>
            <span class="ow">or</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">MAC</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">workspace_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No scheme for device=</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">, type = </span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_sdk_name</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">AppSigningCredentials</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the SDK name for the given device type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device: Device</span>
<span class="sd">            The target device for which the SDK name is being determined.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The SDK name to use for the build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">MAC</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;macosx&quot;</span>
        <span class="k">elif</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">IPHONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;iphoneos&quot;</span>
        <span class="k">elif</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">IPAD</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;iphoneos&quot;</span>
        <span class="k">elif</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">WATCH</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;watchos&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No sdk for device=</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">, type = </span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_destination</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the destination string for ``xcodebuild`` based on the device type.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device : Device</span>
<span class="sd">            The target device for which the destination string is being determined.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The destination string to use for the ``xcodebuild`` command.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">MAC</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;platform=macOS,arch=arm64,x86_64,id=</span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">udid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">IPHONE</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;platform=iOS,id=</span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">udid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">IPAD</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;platform=iOS,id=</span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">udid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">elif</span> <span class="n">device</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">DeviceType</span><span class="o">.</span><span class="n">WATCH</span><span class="p">:</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;platform=watchOS,arch=arm64_32,id=</span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">udid</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No destination for device=</span><span class="si">{</span><span class="n">device</span><span class="si">}</span><span class="s2">, type = </span><span class="si">{</span><span class="n">device</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_build_path</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">build_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the build path for the given device and build directory.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device : Device</span>
<span class="sd">            The target device for which the build path is being determined.</span>

<span class="sd">        build_directory : Path</span>
<span class="sd">            The base build directory.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            The full path where the build artifacts will be stored.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">build_directory</span> <span class="o">/</span> <span class="n">device</span><span class="o">.</span><span class="n">udid</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">check_app_signing_credentials</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">AppSigningCredentials</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">provisioning_profile_uuid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
            <span class="n">credentials</span><span class="o">.</span><span class="n">development_team</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Invalid signing credentials: Either &#39;provisioning_profile_uuid&#39; or &#39;development_team&#39; must be provided.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;Note:</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- When using &#39;provisioning_profile_uuid&#39;, ensure &#39;bundle_identifier&#39; matches the profile&#39;s bundle ID</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="s2">&quot;- When using &#39;development_team&#39;, Xcode will automatically manage provisioning profiles&quot;</span>
            <span class="p">)</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">build_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">workspace_path</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">AppSigningCredentials</span><span class="p">,</span>
        <span class="n">clean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the Xcode project for the specified device.</span>

<span class="sd">        This method handles the entire build process, including cleaning if requested,</span>
<span class="sd">        setting up the build directory, and running the ``xcodebuild`` command.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        device: Device</span>
<span class="sd">            The target device for which to build the app.</span>

<span class="sd">        build_directory: Path</span>
<span class="sd">            The directory where build artifacts will be stored.</span>

<span class="sd">        workspace_path: Path</span>
<span class="sd">            The path to the Xcode workspace file.</span>

<span class="sd">        credentials: AppSigningCredentials</span>
<span class="sd">            The application code signing credentials.</span>

<span class="sd">        clean: bool</span>
<span class="sd">            Whether to clean the build directory before building (default is False).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            The path to the built .app file if successful, None otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">check_app_signing_credentials</span><span class="p">(</span><span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">)</span>

        <span class="n">build_path</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_build_path</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">build_directory</span><span class="o">=</span><span class="n">build_directory</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">clean</span> <span class="ow">and</span> <span class="n">build_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">build_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">build_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.app&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="n">build_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">workspace_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Workspace path=</span><span class="si">{</span><span class="n">workspace_path</span><span class="si">}</span><span class="s2"> is not a directory.&quot;</span><span class="p">)</span>

        <span class="n">workspace_name</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">workspace_path</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">bundle_identifier</span> <span class="o">=</span> <span class="n">credentials</span><span class="o">.</span><span class="n">bundle_identifier</span>
        <span class="n">bundle_identifier</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">bundle_identifier</span> <span class="k">if</span> <span class="n">bundle_identifier</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;com.coremltools.modelrunnerd&quot;</span>
        <span class="p">)</span>

        <span class="n">command</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;xcodebuild -workspace </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">workspace_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-scheme </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_scheme_name</span><span class="p">(</span><span class="n">workspace_name</span><span class="o">=</span><span class="w"> </span><span class="n">workspace_name</span><span class="p">,</span><span class="w"> </span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-sdk </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_sdk_name</span><span class="p">(</span><span class="n">device</span><span class="p">,</span><span class="w"> </span><span class="n">credentials</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;-destination </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="n">get_destination</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;-configuration Release &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;SYMROOT=</span><span class="si">{</span><span class="n">build_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;CODE_SIGN_STYLE=AUTOMATIC &quot;</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">credentials</span><span class="o">.</span><span class="n">provisioning_profile_uuid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;PROVISIONING_PROFILE=</span><span class="si">{</span><span class="n">credentials</span><span class="o">.</span><span class="n">provisioning_profile_uuid</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="s2">&quot;-allowProvisioningUpdates -allowProvisioningDeviceRegistration &quot;</span>

        <span class="k">if</span> <span class="n">credentials</span><span class="o">.</span><span class="n">development_team</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">credentials</span><span class="o">.</span><span class="n">development_team</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;DEVELOPMENT_TEAM=</span><span class="si">{</span><span class="n">credentials</span><span class="o">.</span><span class="n">development_team</span><span class="si">}</span><span class="s2"> &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">command</span> <span class="o">+=</span> <span class="s1">&#39;CODE_SIGN_IDENTITY=&quot;-&quot; &#39;</span>

        <span class="n">command</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;PRODUCT_BUNDLE_IDENTIFIER=</span><span class="si">{</span><span class="n">bundle_identifier</span><span class="si">}</span><span class="s2"> &quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">_subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">command</span><span class="p">,</span>
                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
                <span class="n">stderr</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">,</span>
                <span class="n">stdin</span><span class="o">=</span><span class="n">_subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">output</span><span class="o">.</span><span class="n">check_returncode</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">_subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_AppBuilder</span><span class="o">.</span><span class="n">Error</span><span class="p">(</span>
                <span class="n">error_code</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="n">e</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">build_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*.app&quot;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_ModelRunnerAppBuilder</span><span class="p">(</span><span class="n">_AppBuilder</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A utility class for building the modelrunner Xcode project.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_get_project_path</span><span class="p">():</span>
        <span class="k">return</span> <span class="n">_Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span> <span class="o">/</span> <span class="s2">&quot;modelrunner&quot;</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">build</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">build_directory</span><span class="p">:</span> <span class="n">_Path</span><span class="p">,</span>
        <span class="n">credentials</span><span class="p">:</span> <span class="n">AppSigningCredentials</span><span class="p">,</span>
        <span class="n">clean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Build the ``modelrunner`` Xcode project for the specified device.</span>

<span class="sd">        This method handles the entire build process, including cleaning if requested,</span>
<span class="sd">        setting up the build directory, and running the ``xcodebuild`` command.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        -----------</span>
<span class="sd">        device: Device</span>
<span class="sd">            The target device for which to build the app.</span>

<span class="sd">        build_directory: Path</span>
<span class="sd">            The directory where build artifacts will be stored.</span>

<span class="sd">        clean: bool</span>
<span class="sd">            Whether to clean the build directory before building (default is False).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Path</span>
<span class="sd">            The path to the built .app file if successful, None otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">command_exists</span><span class="p">(</span><span class="n">command</span><span class="p">):</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;Check if a command exists in the system&#39;s PATH.&quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">_shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

        <span class="n">project_path</span> <span class="o">=</span> <span class="n">_ModelRunnerAppBuilder</span><span class="o">.</span><span class="n">_get_project_path</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">project_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Model runner directory not found at expected path: </span><span class="si">{</span><span class="n">project_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">workspace_path</span> <span class="o">=</span> <span class="n">project_path</span> <span class="o">/</span> <span class="s2">&quot;ModelRunner.xcworkspace&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">workspace_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Workspace directory not found at expected path: </span><span class="si">{</span><span class="n">workspace_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">command_exists</span><span class="p">(</span><span class="s2">&quot;xcodebuild&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The &#39;xcodebuild&#39; command is required. Please ensure that Xcode Command Line Tools are installed and accessible.&quot;</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
            <span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span>
            <span class="n">build_directory</span><span class="o">=</span><span class="n">build_directory</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
            <span class="n">workspace_path</span><span class="o">=</span><span class="n">workspace_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">(),</span>
            <span class="n">credentials</span><span class="o">=</span><span class="n">credentials</span><span class="p">,</span>
            <span class="n">clean</span><span class="o">=</span><span class="n">clean</span><span class="p">,</span>
        <span class="p">)</span>


<span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_JSONRPCRequest</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a JSON-RPC request.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">params</span><span class="p">:</span> <span class="nb">any</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_JSONRPCError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a JSON-RPC error.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="n">message</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Error </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">code</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_JSONRPCResponse</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a JSON-RPC response with an associated resource.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Any</span><span class="p">]</span>
    <span class="n">error</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_JSONRPCError</span><span class="p">]</span>
    <span class="n">resource</span><span class="p">:</span> <span class="n">_Path</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_JSONRPCSocket</span><span class="p">(</span><span class="n">_ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An abstract base class representing a JSON-RPC socket for communication.</span>

<span class="sd">    This class defines the interface for sending JSON-RPC requests and receiving</span>
<span class="sd">    responses, potentially with associated resources.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@_abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">_JSONRPCRequest</span><span class="p">,</span>
        <span class="n">resource_path</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a JSON-RPC request through the socket.</span>

<span class="sd">        This method is responsible for transmitting a JSON-RPC request, optionally</span>
<span class="sd">        with an associated resource.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        request: JSONRPCRequest</span>
<span class="sd">            The JSON-RPC request to be sent.</span>

<span class="sd">        resource_path: Optional[Path]</span>
<span class="sd">            The path to an associated resource file, if any. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@_abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">receive</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_JSONRPCResponse</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive a JSON-RPC response for a given request ID.</span>

<span class="sd">        This method is responsible for receiving and returning a JSON-RPC response</span>
<span class="sd">        associated with a specific request ID, potentially including resource information.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id: str</span>
<span class="sd">            The ID of the JSON-RPC request for which to receive the response.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[JSONRPCResourcefulResponse]</span>
<span class="sd">            The received JSON-RPC response, potentially including resource information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="nd">@_abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the socket is active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool:</span>
<span class="sd">            True if the socket is active, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_DeviceCtlSocket</span><span class="p">(</span><span class="n">_JSONRPCSocket</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for managing communication with a device application using JSON-RPC over a custom socket-like interface.</span>

<span class="sd">    This class handles sending requests to and receiving responses from an application running on a device.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_error</span><span class="p">(</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_JSONRPCError</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error = </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not a dict&quot;</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;code&quot;</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="s2">&quot;message&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">_JSONRPCError</span><span class="p">(</span>
            <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="p">,</span>
            <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">source</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a new DeviceCtlSocket instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        device: Device</span>
<span class="sd">            The device object.</span>

<span class="sd">        working_dir: Path</span>
<span class="sd">            The base working directory for storing temporary files and resources.</span>

<span class="sd">        source: str</span>
<span class="sd">            The source identifier for the communication.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">/</span> <span class="nb">str</span><span class="p">(</span><span class="n">_uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">requests_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">/</span> <span class="s2">&quot;requests&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">responses_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">working_directory</span> <span class="o">/</span> <span class="s2">&quot;responses&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">send</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">_JSONRPCRequest</span><span class="p">,</span>
        <span class="n">resource_path</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Send a JSON-RPC request to the device application.</span>

<span class="sd">        This method prepares and sends a JSON-RPC request, optionally including a resource file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        request: JSONRPCRequest</span>
<span class="sd">           The JSON-RPC request to send.</span>

<span class="sd">        resource_path: Optional[Path]</span>
<span class="sd">           Path to a resource file to be sent with the request.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        DataTransferInfo</span>
<span class="sd">           Information about the data transfer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">message</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;jsonrpc&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;2.0&quot;</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">id</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span>
        <span class="n">message</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span>

        <span class="n">requests_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">requests_directory</span> <span class="o">/</span> <span class="n">request</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="n">requests_directory</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">requests_directory</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">resource_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resource_name</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">resource_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">send_file_to_app</span><span class="p">(</span>
                <span class="n">resource_path</span><span class="p">,</span>
                <span class="n">destination</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/requests/resources/</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">message</span><span class="p">[</span><span class="s2">&quot;resource&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_name</span>

        <span class="n">requests_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">message_json_file</span> <span class="o">=</span> <span class="n">requests_directory</span> <span class="o">/</span> <span class="s2">&quot;message.json&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">message_json_file</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">json_string</span> <span class="o">=</span> <span class="n">_json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">send_file_to_app</span><span class="p">(</span>
            <span class="n">message_json_file</span><span class="p">,</span>
            <span class="n">destination</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/requests/messages/</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">/message.json&quot;</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">receive</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_JSONRPCResponse</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Receive a JSON-RPC response from the device application.</span>

<span class="sd">        This method retrieves and parses a JSON-RPC response, including any associated resource files.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        id : str</span>
<span class="sd">            The ID of the request for which to receive the response.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Optional[JSONRPCResponse]</span>
<span class="sd">            The received response, or None if no response is available.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">responses_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">responses_directory</span> <span class="o">/</span> <span class="nb">id</span>
        <span class="k">if</span> <span class="n">responses_directory</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="n">_shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">responses_directory</span><span class="o">.</span><span class="n">resolve</span><span class="p">())</span>

        <span class="n">responses_directory</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">receive_file_from_app</span><span class="p">(</span>
            <span class="n">destination_path</span><span class="o">=</span><span class="n">responses_directory</span> <span class="o">/</span> <span class="s2">&quot;message.json&quot;</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/responses/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/message.json&quot;</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">message_json_file</span> <span class="o">=</span> <span class="n">responses_directory</span> <span class="o">/</span> <span class="s2">&quot;message.json&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">message_json_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response for request-id</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> is missing message.json file.&quot;</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">resource</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">resource_name</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">message_json_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="n">_json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response for request-id</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> is malformed </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="n">response_id</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">response_id</span> <span class="o">!=</span> <span class="nb">id</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Response for request-id</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> is malformed </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="n">result</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">error</span> <span class="o">=</span> <span class="n">_DeviceCtlSocket</span><span class="o">.</span><span class="n">_parse_error</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
            <span class="n">resource_name</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;resource&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Response for request-id</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> is malformed </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">, missing result=</span><span class="si">{</span><span class="n">result</span><span class="si">}</span><span class="s2"> or error=</span><span class="si">{</span><span class="n">error</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="n">resource</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">resource_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">resource_payload</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">receive_file_from_app</span><span class="p">(</span>
                <span class="n">destination_path</span><span class="o">=</span><span class="n">responses_directory</span> <span class="o">/</span> <span class="n">resource_name</span><span class="p">,</span>
                <span class="n">source</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="si">}</span><span class="s2">/responses/</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">resource_payload</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Response for request-id=</span><span class="si">{</span><span class="nb">id</span><span class="si">}</span><span class="s2"> is missing resource file=</span><span class="si">{</span><span class="n">resource_name</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

            <span class="n">resource</span> <span class="o">=</span> <span class="n">responses_directory</span> <span class="o">/</span> <span class="n">resource_name</span>

        <span class="k">return</span> <span class="n">_JSONRPCResponse</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">id</span><span class="p">,</span>
            <span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">,</span>
            <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">,</span>
            <span class="n">resource</span><span class="o">=</span><span class="n">resource</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the socket is active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the socket is active, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">is_alive</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_RemoteService</span><span class="p">(</span><span class="n">_ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An abstract base class representing a remote service capable of executing methods.</span>

<span class="sd">    This class defines the interface for remote method invocation, allowing</span>
<span class="sd">    for asynchronous calls with optional resource handling.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_method</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">_Any</span><span class="p">,</span>
        <span class="n">resource</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Tuple</span><span class="p">[</span><span class="n">_Any</span><span class="p">,</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Path</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronously call a method on the remote service.</span>

<span class="sd">        This method is responsible for invoking a named method on the remote service,</span>
<span class="sd">        passing the provided parameters, and optionally handling a resource.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            The name of the method to be called on the remote service.</span>

<span class="sd">        params: Any</span>
<span class="sd">            The parameters to be passed to the remote method. This can be of any type, depending on what the remote method expects.</span>


<span class="sd">        resource: Optional[Path]</span>
<span class="sd">            A path to a resource that may be required or modified by the method call. Defaults to None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[Any, Optional[Path]]</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">                - The result of the method call (Any type)</span>
<span class="sd">                - An optional Path object, which may represent a new or modified resource</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fire_and_forget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">_Any</span><span class="p">,</span>
        <span class="n">resource</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a method asynchronously without waiting for its completion.</span>

<span class="sd">        This method uses the event loop&#39;s executor to run the `call_method` function</span>
<span class="sd">        in a separate thread, allowing the calling code to continue execution</span>
<span class="sd">        immediately without waiting for the method to complete.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            The name of the method to call on the remote device.</span>

<span class="sd">        params: Any</span>
<span class="sd">            The parameters to pass to the method. Can be any JSON-serializable object.</span>

<span class="sd">        resource: Optional[Path]</span>
<span class="sd">            Path to a resource file to be sent with the request. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the service is active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool:</span>
<span class="sd">            True if the service is active, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_DeviceCtlRemoteService</span><span class="p">(</span><span class="n">_RemoteService</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A service class for managing device control operations using a DeviceCtlSocket.</span>

<span class="sd">    This class provides an asynchronous interface for calling methods on a remote device</span>
<span class="sd">    using JSON-RPC over a custom socket implementation.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">socket</span><span class="p">:</span> <span class="n">_DeviceCtlSocket</span><span class="p">,</span> <span class="n">poll_time</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a DeviceCtlService instance.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        socket: DeviceCtlSocket</span>
<span class="sd">            The socket used for communication with the device.</span>

<span class="sd">        poll_time: float</span>
<span class="sd">            The time interval (in seconds) between polling for responses. Defaults to 0.5 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">socket</span> <span class="o">=</span> <span class="n">socket</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poll_time</span> <span class="o">=</span> <span class="n">poll_time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_attempts</span> <span class="o">=</span> <span class="n">max_attempts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_loop</span> <span class="o">=</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">working_dir</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Path</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the working directory of the associated socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">working_dir</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">call_method</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">_Any</span><span class="p">,</span>
        <span class="n">resource</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Tuple</span><span class="p">[</span><span class="n">_Any</span><span class="p">,</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Path</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Asynchronously call a method on the remote device.</span>

<span class="sd">        This method sends a JSON-RPC request to the device and waits for the response.</span>
<span class="sd">        It handles the creation of the request, sending it through the socket, and polling</span>
<span class="sd">        for the response.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            The name of the method to call on the remote device.</span>

<span class="sd">        params: Any</span>
<span class="sd">            The parameters to pass to the method. Can be any JSON-serializable object.</span>

<span class="sd">        resource: Optional[Path]</span>
<span class="sd">            Path to a resource file to be sent with the request. Defaults to None.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Tuple[Any, Optional[Path]]</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - The result of the method call (Any)</span>
<span class="sd">            - The path to any resource returned by the method (Optional[Path])</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">should_throw_exception</span><span class="p">(</span><span class="n">attempt</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">is_alive</span> <span class="ow">or</span> <span class="p">(</span><span class="n">attempt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_attempts</span>

        <span class="n">request</span> <span class="o">=</span> <span class="n">_JSONRPCRequest</span><span class="p">(</span>
            <span class="nb">id</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">_uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">()),</span>
            <span class="n">method</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="n">_tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1mInitiating data transfer to &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">. Attempts </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">resource</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Resource file </span><span class="si">{</span><span class="n">resource</span><span class="o">.</span><span class="n">absolute</span><span class="p">()</span><span class="si">}</span><span class="s2"> does not exist.&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">send</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="n">_DeviceCtlError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to send request: </span><span class="si">{</span><span class="n">request</span><span class="si">}</span><span class="s2">, code: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span><span class="si">}</span><span class="s2">, message: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">should_throw_exception</span><span class="p">(</span><span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="k">await</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poll_time</span><span class="p">)</span>

        <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="n">_tqdm</span><span class="o">.</span><span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_attempts</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\033</span><span class="s2">[1mInitiating data transfer from </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">device</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">. Attempts </span><span class="se">\033</span><span class="s2">[0m&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_event_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
                    <span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">receive</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">id</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="n">_DeviceCtlError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to receive response of id: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">, code: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">error_code</span><span class="si">}</span><span class="s2">, message: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">should_throw_exception</span><span class="p">(</span><span class="n">attempt</span><span class="o">=</span><span class="n">attempt</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">e</span>

            <span class="k">await</span> <span class="n">_asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poll_time</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">error</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="n">error_code</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">code</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">response</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">result</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">resource</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">fire_and_forget</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">params</span><span class="p">:</span> <span class="n">_Any</span><span class="p">,</span>
        <span class="n">resource</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Executes a method asynchronously without waiting for its completion.</span>

<span class="sd">        This method uses the event loop&#39;s executor to run the `call_method` function</span>
<span class="sd">        in a separate thread, allowing the calling code to continue execution</span>
<span class="sd">        immediately without waiting for the method to complete.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            The name of the method to call on the remote device.</span>

<span class="sd">        params: Any</span>
<span class="sd">            The parameters to pass to the method. Can be any JSON-serializable object.</span>

<span class="sd">        resource: Optional[Path]</span>
<span class="sd">            Path to a resource file to be sent with the request. Defaults to None.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_event_loop</span><span class="o">.</span><span class="n">run_in_executor</span><span class="p">(</span>
            <span class="kc">None</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">call_method</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">resource</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_alive</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks if the socket is active.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool:</span>
<span class="sd">            True if the socket is active, False otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">socket</span><span class="o">.</span><span class="n">is_alive</span>


<span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_TensorStorage</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Represents a segment of data with an offset and size.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">offset</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">size</span><span class="p">:</span> <span class="nb">int</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">as_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the TensorStorage to a dictionary.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Any]</span>
<span class="sd">            A dictionary representation of the TensorStorage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;offset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">size</span><span class="p">}</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;_TensorStorage&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TensorStorage instance from a dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dict: Dict[str, Any]</span>
<span class="sd">            A dictionary containing &#39;offset&#39; and &#39;size&#39; keys.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TensorStorage</span>
<span class="sd">            A new TensorStorage instance.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_TensorStorage</span><span class="p">(</span>
            <span class="n">offset</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;offset&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
            <span class="n">size</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;size&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
        <span class="p">)</span>


<span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">_TensorDescriptor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Describes the properties of a tensor.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">DataType</span><span class="p">(</span><span class="n">_Enum</span><span class="p">):</span>
        <span class="n">Float16</span> <span class="o">=</span> <span class="s2">&quot;Float16&quot;</span>
        <span class="n">Float32</span> <span class="o">=</span> <span class="s2">&quot;Float32&quot;</span>
        <span class="n">Float64</span> <span class="o">=</span> <span class="s2">&quot;Float64&quot;</span>
        <span class="n">Int32</span> <span class="o">=</span> <span class="s2">&quot;Int32&quot;</span>

    <span class="n">shape</span><span class="p">:</span> <span class="n">_List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">strides</span><span class="p">:</span> <span class="n">_List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span>
    <span class="n">data_type</span><span class="p">:</span> <span class="n">DataType</span>
    <span class="n">storage</span><span class="p">:</span> <span class="n">_TensorStorage</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_multi_array_dtype</span><span class="p">(</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">dtype</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">float16</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">Float16</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">float32</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">Float32</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">float64</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">Float64</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">_np</span><span class="o">.</span><span class="n">int32</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">Int32</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> is not supported&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_to_numpy_dtype</span><span class="p">(</span>
        <span class="n">dtype</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">Float16</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">float16</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">Float32</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">float32</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">Float64</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">float64</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">Int32</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">int32</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">dtype</span><span class="si">}</span><span class="s2"> is not supported&quot;</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_array</span><span class="p">(</span>
        <span class="n">array</span><span class="p">:</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
        <span class="n">file</span><span class="p">:</span> <span class="n">_BinaryIO</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;_TensorDescriptor&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TensorDescriptor from a numpy array and write the data to a binary file.</span>

<span class="sd">        This static method converts a numpy array into a TensorDescriptor and writes the</span>
<span class="sd">        array data to the provided binary file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        array: np.array</span>
<span class="sd">            The numpy array to convert.</span>

<span class="sd">        file: BinaryIO</span>
<span class="sd">            A binary file object to which the array data will be written.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TensorDescriptor</span>
<span class="sd">             A new TensorDescriptor instance representing the input array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shape</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">//</span> <span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">strides</span><span class="p">)]</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">_to_multi_array_dtype</span><span class="p">(</span><span class="n">array</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>

        <span class="n">offset</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
        <span class="n">buffer</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">tobytes</span><span class="p">()</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span>

        <span class="n">storage</span> <span class="o">=</span> <span class="n">_TensorStorage</span><span class="p">(</span>
            <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">_TensorDescriptor</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span>
            <span class="n">strides</span><span class="o">=</span><span class="n">strides</span><span class="p">,</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">data_type</span><span class="p">,</span>
            <span class="n">storage</span><span class="o">=</span><span class="n">storage</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_array</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">file</span><span class="p">:</span> <span class="n">_BinaryIO</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the TensorDescriptor back to a numpy array, reading data from a binary file.</span>

<span class="sd">        This method reconstructs a numpy array from the TensorDescriptor, reading the necessary</span>
<span class="sd">        data from the provided binary file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        file: BinaryIO</span>
<span class="sd">            A binary file object from which to read the array data.</span>
<span class="sd">            This file should be openable in binary read mode (&#39;rb&#39;).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        np.array</span>
<span class="sd">            A numpy array reconstructed from the TensorDescriptor and file data.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">data_type</span> <span class="o">=</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">_to_numpy_dtype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">frombuffer</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">data_type</span><span class="p">)</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="o">*</span> <span class="n">result</span><span class="o">.</span><span class="n">itemsize</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">strides</span><span class="p">]</span>
        <span class="n">strided_view</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">lib</span><span class="o">.</span><span class="n">stride_tricks</span><span class="o">.</span><span class="n">as_strided</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">strides</span><span class="p">)</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">strided_view</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">as_dict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the TensorDescriptor to a dictionary representation.</span>

<span class="sd">        This method creates a dictionary containing all the attributes of the TensorDescriptor,</span>
<span class="sd">        with keys matching the attribute names.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, Any]</span>
<span class="sd">            A dictionary representation of the TensorDescriptor with the following keys:</span>
<span class="sd">                - &#39;shape&#39;: List[int], the shape of the tensor</span>
<span class="sd">                - &#39;strides&#39;: List[int], the strides of the tensor</span>
<span class="sd">                - &#39;dataType&#39;: str, the string representation of the data type</span>
<span class="sd">                - &#39;storage&#39;: Dict, the dictionary representation of the TensorStorage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;shape&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;strides&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">strides</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;dataType&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data_type</span><span class="o">.</span><span class="n">value</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;storage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">storage</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span>
        <span class="nb">dict</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;_TensorDescriptor&quot;</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a TensorDescriptor instance from a dictionary.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dict: Dict[str, Any]</span>
<span class="sd">            A dictionary containing the TensorDescriptor attributes.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        TensorDescriptor</span>
<span class="sd">            A new TensorDescriptor instance created from the dictionary data.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">_TensorDescriptor</span><span class="p">(</span>
            <span class="n">shape</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;shape&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">strides</span><span class="o">=</span><span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strides&quot;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="n">data_type</span><span class="o">=</span><span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="p">(</span>
                <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dataType&quot;</span><span class="p">,</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">DataType</span><span class="o">.</span><span class="n">Float32</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
            <span class="p">),</span>
            <span class="n">storage</span><span class="o">=</span><span class="n">_TensorStorage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;storage&quot;</span><span class="p">,</span> <span class="p">{})),</span>
        <span class="p">)</span>


<div class="viewcode-block" id="ComputePlan">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.ComputePlan">[docs]</a>
<span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ComputePlan</span><span class="p">:</span>
<div class="viewcode-block" id="ComputePlan.CPUDevice">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.ComputePlan.CPUDevice">[docs]</a>
    <span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">CPUDevice</span><span class="p">:</span>
        <span class="nd">@staticmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="s2">&quot;ComputePlan.CPUDevice&quot;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ComputePlan</span><span class="o">.</span><span class="n">CPUDevice</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;cpu&quot;</span><span class="p">:</span> <span class="p">{}}</span></div>


<div class="viewcode-block" id="ComputePlan.GPUDevice">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.ComputePlan.GPUDevice">[docs]</a>
    <span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">GPUDevice</span><span class="p">:</span>
        <span class="nd">@staticmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="s2">&quot;ComputePlan.GPUDevice&quot;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;gpu&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ComputePlan</span><span class="o">.</span><span class="n">GPUDevice</span><span class="p">()</span> <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;gpu&quot;</span><span class="p">:</span> <span class="p">{}}</span></div>


<div class="viewcode-block" id="ComputePlan.NeuralEngineDevice">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.ComputePlan.NeuralEngineDevice">[docs]</a>
    <span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">NeuralEngineDevice</span><span class="p">:</span>
        <span class="n">total_core_count</span><span class="p">:</span> <span class="nb">int</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="s2">&quot;ComputePlan.NeuralEngineDevice&quot;</span><span class="p">]:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;neuralEngine&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="n">total_core_count</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;totalCoreCount&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">ComputePlan</span><span class="o">.</span><span class="n">NeuralEngineDevice</span><span class="p">(</span><span class="n">total_core_count</span><span class="o">=</span><span class="n">total_core_count</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;neuralEngine&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;totalCoreCount&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_core_count</span><span class="p">}}</span></div>


    <span class="n">Device</span> <span class="o">=</span> <span class="n">_Union</span><span class="p">[</span>
        <span class="s2">&quot;ComputePlan.CPUDevice&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ComputePlan.GPUDevice&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ComputePlan.NeuralEngineDevice&quot;</span><span class="p">,</span>
    <span class="p">]</span>

<div class="viewcode-block" id="ComputePlan.DeviceUsage">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.ComputePlan.DeviceUsage">[docs]</a>
    <span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">DeviceUsage</span><span class="p">:</span>
        <span class="n">preferred</span><span class="p">:</span> <span class="s2">&quot;ComputePlan.Device&quot;</span>
        <span class="n">supported</span><span class="p">:</span> <span class="n">_List</span><span class="p">[</span><span class="s2">&quot;ComputePlan.Device&quot;</span><span class="p">]</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="s2">&quot;ComputePlan.Device&quot;</span><span class="p">]:</span>
            <span class="k">def</span><span class="w"> </span><span class="nf">device_from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">Device</span><span class="p">]:</span>
                <span class="n">device_types</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">ComputePlan</span><span class="o">.</span><span class="n">CPUDevice</span><span class="p">,</span>
                    <span class="n">ComputePlan</span><span class="o">.</span><span class="n">GPUDevice</span><span class="p">,</span>
                    <span class="n">ComputePlan</span><span class="o">.</span><span class="n">NeuralEngineDevice</span><span class="p">,</span>
                <span class="p">]</span>

                <span class="k">for</span> <span class="n">device_type</span> <span class="ow">in</span> <span class="n">device_types</span><span class="p">:</span>
                    <span class="n">parsed_device</span> <span class="o">=</span> <span class="n">device_type</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">parsed_device</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">parsed_device</span>

                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Failed to parse device: </span><span class="si">{</span><span class="nb">dict</span><span class="si">}</span><span class="s2">, it does not match any known device type&quot;</span>
                <span class="p">)</span>

            <span class="n">preferred_device</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;preferred&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">preferred_device</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse preferred device: </span><span class="si">{</span><span class="n">preferred_device</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">preferred</span> <span class="o">=</span> <span class="n">device_from_dict</span><span class="p">(</span><span class="n">preferred_device</span><span class="p">)</span>

            <span class="n">supported_devices</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;supported&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">supported_devices</span><span class="p">,</span> <span class="n">_Sequence</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to parse supported devices: </span><span class="si">{</span><span class="n">supported_devices</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="n">supported</span> <span class="o">=</span> <span class="p">[</span><span class="n">device_from_dict</span><span class="p">(</span><span class="n">device</span><span class="p">)</span> <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="n">supported_devices</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">ComputePlan</span><span class="o">.</span><span class="n">DeviceUsage</span><span class="p">(</span><span class="n">preferred</span><span class="o">=</span><span class="n">preferred</span><span class="p">,</span> <span class="n">supported</span><span class="o">=</span><span class="n">supported</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;preferred&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">preferred</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                <span class="s2">&quot;supported&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">device</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">device</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">supported</span><span class="p">],</span>
            <span class="p">}</span></div>


<div class="viewcode-block" id="ComputePlan.OperationOrLayerInfo">
<a class="viewcode-back" href="../../../../../source/coremltools.models.html#coremltools.models.ml_program.experimental.remote_device.ComputePlan.OperationOrLayerInfo">[docs]</a>
    <span class="nd">@_dataclass</span><span class="p">(</span><span class="n">frozen</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">class</span><span class="w"> </span><span class="nc">OperationOrLayerInfo</span><span class="p">:</span>
        <span class="n">device_usage</span><span class="p">:</span> <span class="s2">&quot;ComputePlan.DeviceUsage&quot;</span>
        <span class="n">estimated_cost</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span>
        <span class="n">path</span><span class="p">:</span> <span class="n">ModelStructurePath</span>

        <span class="nd">@staticmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span>
            <span class="nb">dict</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="s2">&quot;ComputePlan.OperationOrLayerInfo&quot;</span><span class="p">]:</span>
            <span class="n">device_usage</span> <span class="o">=</span> <span class="n">ComputePlan</span><span class="o">.</span><span class="n">DeviceUsage</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deviceUsage&quot;</span><span class="p">,</span> <span class="p">{}))</span>
            <span class="n">estimated_cost</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;estimatedCost&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">ModelStructurePath</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="p">{}))</span>

            <span class="k">return</span> <span class="n">ComputePlan</span><span class="o">.</span><span class="n">OperationOrLayerInfo</span><span class="p">(</span>
                <span class="n">device_usage</span><span class="o">=</span><span class="n">device_usage</span><span class="p">,</span>
                <span class="n">estimated_cost</span><span class="o">=</span><span class="n">estimated_cost</span><span class="p">,</span>
                <span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;deviceUsage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">device_usage</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
                <span class="s2">&quot;estimatedCost&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">estimated_cost</span><span class="p">,</span>
                <span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(),</span>
            <span class="p">}</span></div>


    <span class="n">infos</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="n">ModelStructurePath</span><span class="p">,</span> <span class="s2">&quot;ComputePlan.OperationOrLayerInfo&quot;</span><span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="s2">&quot;ComputePlan&quot;</span><span class="p">]:</span>
        <span class="n">infos</span> <span class="o">=</span> <span class="nb">dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;infos&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">infos</span><span class="p">,</span> <span class="n">_Sequence</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">infos</span> <span class="o">=</span> <span class="p">(</span><span class="n">ComputePlan</span><span class="o">.</span><span class="n">OperationOrLayerInfo</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ComputePlan</span><span class="p">(</span><span class="n">infos</span><span class="o">=</span><span class="p">{</span><span class="n">info</span><span class="o">.</span><span class="n">path</span><span class="p">:</span> <span class="n">info</span> <span class="k">for</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">infos</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">to_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;infos&quot;</span><span class="p">:</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span> <span class="n">value</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">infos</span><span class="o">.</span><span class="n">items</span><span class="p">()},</span>
        <span class="p">}</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">_RemoteMLModelService</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This class provides a service interface for interacting with an MLModel</span>
<span class="sd">    on a remote device using a DeviceCtlService.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">State</span><span class="p">(</span><span class="n">_Enum</span><span class="p">):</span>
        <span class="n">Loaded</span> <span class="o">=</span> <span class="s2">&quot;loaded&quot;</span>
        <span class="n">Unloaded</span> <span class="o">=</span> <span class="s2">&quot;unloaded&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_args</span><span class="p">(</span>
        <span class="n">service</span><span class="p">:</span> <span class="n">_RemoteService</span><span class="p">,</span>
        <span class="n">compiled_model_path</span><span class="p">:</span> <span class="n">_Union</span><span class="p">[</span><span class="n">_Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">compute_units</span><span class="p">:</span> <span class="n">_ComputeUnit</span><span class="p">,</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">optimization_hints</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]],</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">_RemoteService</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;service&#39; must be a RemoteService instance, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">service</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compiled_model_path</span><span class="p">,</span> <span class="n">_Path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compiled_model_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;compiled_model_path&#39; must be a Path or str, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">compiled_model_path</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compute_units</span><span class="p">,</span> <span class="n">_ComputeUnit</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;compute_units&#39; must be a ComputeUnit enum, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">compute_units</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">function_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;function_name&#39; must be a str, not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">function_name</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">optimization_hints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">optimization_hints</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Parameter &#39;optimization_hints&#39; must be a mapping type (e.g., dict), not </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">optimization_hints</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">service</span><span class="p">:</span> <span class="n">_RemoteService</span><span class="p">,</span>
        <span class="n">compiled_model_path</span><span class="p">:</span> <span class="n">_Union</span><span class="p">[</span><span class="n">_Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">compute_units</span><span class="p">:</span> <span class="n">_ComputeUnit</span><span class="p">,</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimization_hints</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize a RemoteMLModelService instance.</span>

<span class="sd">        Parameter</span>
<span class="sd">        ---------</span>
<span class="sd">        compiled_model_path: Path</span>
<span class="sd">            Path to the compiled model file.</span>

<span class="sd">        compute_units: ComputeUnit</span>
<span class="sd">            The compute units to be used for model execution.</span>

<span class="sd">        service: RemoteService</span>
<span class="sd">            The service used for communication with the remote device.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_RemoteMLModelService</span><span class="o">.</span><span class="n">_validate_args</span><span class="p">(</span>
            <span class="n">service</span><span class="o">=</span><span class="n">service</span><span class="p">,</span>
            <span class="n">compiled_model_path</span><span class="o">=</span><span class="n">compiled_model_path</span><span class="p">,</span>
            <span class="n">compute_units</span><span class="o">=</span><span class="n">compute_units</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span>
            <span class="n">optimization_hints</span><span class="o">=</span><span class="n">optimization_hints</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">compiled_model_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">compiled_model_path</span> <span class="o">=</span> <span class="n">_Path</span><span class="p">(</span><span class="n">compiled_model_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_compiled_model_path</span> <span class="o">=</span> <span class="n">compiled_model_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_compute_units</span> <span class="o">=</span> <span class="n">compute_units</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">_uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_service</span> <span class="o">=</span> <span class="n">service</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">compiled_model_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_function_name</span> <span class="o">=</span> <span class="n">function_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_hints</span> <span class="o">=</span> <span class="n">optimization_hints</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">_RemoteMLModelService</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Unloaded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_duration_in_nano_seconds</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_last_predict_duration_in_nano_seconds</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_duration_in_nano_seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_duration_in_nano_seconds</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">last_predict_duration_in_nano_seconds</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_last_predict_duration_in_nano_seconds</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_RemoteMLModelService</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Unloaded</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;modelID&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_id</span><span class="p">,</span>
            <span class="s2">&quot;computeUnits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_units</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">fire_and_forget</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MLModelService.Unload&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">model_id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the unique identifier for this model instance.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            The model ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_id</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_units</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_ComputeUnit</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the compute units used for this model.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        ComputeUnit</span>
<span class="sd">            The compute units.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_units</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_result</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">result</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected result to be a mapping type (e.g., dict), but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;modelID&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Mismatched model ID: Expected &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="si">}</span><span class="s2">&#39;, but got &#39;</span><span class="si">{</span><span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;modelID&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;None&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
            <span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_device_state</span><span class="p">(</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">device</span><span class="o">.</span><span class="n">session</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Device is not prepared for debugging. Please call `prepare_for_model_debugging()` on the device before attempting to load the model.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">device</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">is_alive</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;The device session is not active. Please call `prepare_for_model_debugging()` on the device to establish a new session.&quot;</span>
            <span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads the model on the remote device asynchronously.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_RemoteMLModelService</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Loaded</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;modelID&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_id</span><span class="p">,</span>
            <span class="s2">&quot;computeUnits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_units</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_name</span><span class="p">,</span>
            <span class="s2">&quot;functionName&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_function_name</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_hints</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">optimization_hints_str_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_optimization_hints</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">params</span><span class="p">[</span><span class="s2">&quot;optimizationHints&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimization_hints_str_vals</span>


        <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">call_method</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MLModelService.Load&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">resource</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_compiled_model_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_result</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">_RemoteMLModelService</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Loaded</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_load_duration_in_nano_seconds</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_prepare_data_for_transfer</span><span class="p">(</span>
        <span class="n">values</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Tuple</span><span class="p">[</span><span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">],</span> <span class="n">_Path</span><span class="p">]:</span>
        <span class="n">data_file</span> <span class="o">=</span> <span class="n">_tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="s2">&quot;w+b&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.bin&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">data_file</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>

            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">from_array</span><span class="p">(</span>
                <span class="n">array</span><span class="o">=</span><span class="n">value</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">data_file</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">as_dict</span><span class="p">()</span>
        <span class="n">data_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">data_file_path</span> <span class="o">=</span> <span class="n">_Path</span><span class="p">(</span><span class="n">data_file</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">data_file_path</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">predict</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inputs</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a prediction using the remote ML model.</span>

<span class="sd">        This asynchronous method sends input data to the remote model, executes the prediction,</span>
<span class="sd">        and returns the results.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        inputs : Dict[str, np.array]</span>
<span class="sd">            A dictionary mapping input names to numpy arrays containing the input data for the prediction.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Dict[str, np.array]</span>
<span class="sd">            A dictionary mapping output names to numpy arrays containing the prediction results.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_RemoteMLModelService</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Unloaded</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;The model with ID </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">model_id</span><span class="si">}</span><span class="s2"> and </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_units</span><span class="o">.</span><span class="n">value</span><span class="si">}</span><span class="s2"> is not currently loaded.&quot;</span>
            <span class="k">raise</span> <span class="n">_DeviceCtlError</span><span class="p">(</span><span class="n">error_code</span><span class="o">=-</span><span class="mi">32001</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="n">message</span><span class="p">)</span>

        <span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">data_file_path</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_data_for_transfer</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">inputs</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;modelID&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_id</span><span class="p">,</span>
            <span class="s2">&quot;computeUnits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_units</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s2">&quot;inputs&quot;</span><span class="p">:</span> <span class="n">values</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">resource</span><span class="p">)</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">call_method</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MLModelService.Prediction&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
            <span class="n">resource</span><span class="o">=</span><span class="n">data_file_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_result</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

        <span class="n">outputs</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;outputs&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">outputs</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Expected outputs to be a mapping type (e.g., dict), but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">outputs</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">values</span><span class="p">:</span> <span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">resource</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Required resource for tensor data storage is missing.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">outputs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_Mapping</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Expected output to be a mapping type (e.g., dict), but got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>

                <span class="n">descriptor</span> <span class="o">=</span> <span class="n">_TensorDescriptor</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="n">array</span> <span class="o">=</span> <span class="n">descriptor</span><span class="o">.</span><span class="n">to_array</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                <span class="n">values</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">array</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_last_predict_duration_in_nano_seconds</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;duration&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">values</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">retrieve_compute_plan</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ComputePlan</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the compute plan of a model loaded on the remote device asynchronously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;modelID&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_id</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">call_method</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MLModelService.ComputePlan&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_result</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ComputePlan</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="nb">dict</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">unload</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unloads the model on the remote device asynchronously.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="n">_RemoteMLModelService</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Unloaded</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;modelID&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_id</span><span class="p">,</span>
            <span class="s2">&quot;computeUnits&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_units</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_service</span><span class="o">.</span><span class="n">call_method</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;MLModelService.Unload&quot;</span><span class="p">,</span>
            <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_validate_result</span><span class="p">(</span><span class="n">result</span><span class="o">=</span><span class="n">result</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="n">_RemoteMLModelService</span><span class="o">.</span><span class="n">State</span><span class="o">.</span><span class="n">Unloaded</span>

    <span class="nd">@staticmethod</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">load_on_device</span><span class="p">(</span>
        <span class="n">device</span><span class="p">:</span> <span class="n">Device</span><span class="p">,</span>
        <span class="n">compiled_model_path</span><span class="p">:</span> <span class="n">_Union</span><span class="p">[</span><span class="n">_Path</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span>
        <span class="n">compute_units</span><span class="p">:</span> <span class="n">_ComputeUnit</span><span class="p">,</span>
        <span class="n">function_name</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">optimization_hints</span><span class="p">:</span> <span class="n">_Optional</span><span class="p">[</span><span class="n">_Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_Any</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_Type</span><span class="p">[</span><span class="s2">&quot;_RemoteMLModelService&quot;</span><span class="p">]:</span>
        <span class="n">_RemoteMLModelService</span><span class="o">.</span><span class="n">_validate_device_state</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">)</span>

        <span class="n">socket</span> <span class="o">=</span> <span class="n">_DeviceCtlSocket</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="n">device</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Documents/modelrunnerd&quot;</span><span class="p">)</span>
        <span class="n">remote_service</span> <span class="o">=</span> <span class="n">_DeviceCtlRemoteService</span><span class="p">(</span><span class="n">socket</span><span class="o">=</span><span class="n">socket</span><span class="p">)</span>
        <span class="n">remote_model_service</span> <span class="o">=</span> <span class="n">_RemoteMLModelService</span><span class="p">(</span>
            <span class="n">service</span><span class="o">=</span><span class="n">remote_service</span><span class="p">,</span>
            <span class="n">compiled_model_path</span><span class="o">=</span><span class="n">compiled_model_path</span><span class="p">,</span>
            <span class="n">compute_units</span><span class="o">=</span><span class="n">compute_units</span><span class="p">,</span>
            <span class="n">function_name</span><span class="o">=</span><span class="n">function_name</span><span class="p">,</span>
            <span class="n">optimization_hints</span><span class="o">=</span><span class="n">optimization_hints</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">await</span> <span class="n">remote_model_service</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">remote_model_service</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Apple Inc.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>